



<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perpustakaan SMKN 1 Ketapang</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>

    :root {
      --navy:       #0f1b35;
      --navy2:      #152040;
      --navy3:      #1c2d55;
      --navy4:      #243360;
      --blue:       #3b7cf4;
      --blue-l:     #5b9cf6;
      --blue-pale:  rgba(59, 124, 244, .12);
      --white:      #ffffff;
      --bg:         #f4f6fb;
      --bg2:        #e8ecf4;
      --border:     #dde3f0;
      --border2:    #c8d0e8;
      --text:       #1a2440;
      --text2:      #4a5a80;
      --text3:      #7a8ab0;
      --green:      #16a34a;
      --green-bg:   #dcfce7;
      --orange:     #ea580c;
      --red:        #dc2626;
      --red-bg:     #fee2e2;
      --gold:       #f59e0b;
      --r:          14px;
      --r-sm:       10px;
      --shadow-sm:  0 1px 4px rgba(15, 27, 53, .07);
      --shadow-md:  0 4px 20px rgba(15, 27, 53, .13);
      --shadow-lg:  0 16px 50px rgba(15, 27, 53, .2);
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; font-size: 16px; }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    .page        { display: none; }
    .page.active { display: block; }
    .sect        { display: none; }
    .sect.on     { display: block; }
    .tab-section    { display: none; }
    .tab-section.on { display: block; }

    @keyframes orbFloat  { 0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-30px) scale(1.05);} }
    @keyframes scaleIn   { from{opacity:0;transform:scale(.94) translateY(16px);}to{opacity:1;transform:scale(1) translateY(0);} }
    @keyframes fadeUpIn  { from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:none;} }
    @keyframes latePulse { 0%,100%{background:rgba(220,38,38,.0);} 50%{background:rgba(220,38,38,.08);} }

    [data-theme="dark"] { --navy:#0a1020;--navy2:#0d1628;--navy3:#121e3a;--bg:#111827;--bg2:#1a2540;--border:#1e3050;--border2:#243a60;--text:#e2e8f8;--text2:#8a9bc0;--text3:#4a5a80;--card-bg:#131d32;--page-bg:#0d1525;--input-bg:#1a2540;--blue:#5b9cf6;--blue-l:#7bb4f8;--blue-pale:rgba(91,156,246,.12); }
    [data-theme="dark"] .login-card{background:#131d32;}
    [data-theme="dark"] .lf-input{background:#1a2540;color:var(--text);border-color:var(--border);}
    [data-theme="dark"] .demo-acc{background:var(--bg2);}
    [data-theme="dark"] .sort-box{background:var(--card-bg);color:var(--text);border-color:var(--border);}
    [data-theme="dark"] .fg input,[data-theme="dark"] .fg select,[data-theme="dark"] .fg textarea{background:var(--input-bg);color:var(--text);border-color:var(--border);}
    [data-theme="dark"] .user-type-tabs{background:var(--bg2);border-color:var(--border);}
    [data-theme="dark"] .utt.on{background:var(--navy3);color:var(--text);}
    [data-theme="dark"] .modal{background:var(--card-bg);}
    /* ── SKELETON LOADING ── */
@keyframes shimmer {
  0% { background-position: -400px 0; }
  100% { background-position: 400px 0; }
}
.bk-skeleton {
  background: #fff;
  border-radius: var(--r);
  overflow: hidden;
  border: 1.5px solid var(--border);
}
.sk-cover {
  height: 170px;
  background: linear-gradient(90deg, var(--bg2) 25%, var(--bg) 50%, var(--bg2) 75%);
  background-size: 400px 100%;
  animation: shimmer 1.4s ease-in-out infinite;
}
.sk-body { padding: 13px; }
.sk-line {
  height: 10px;
  border-radius: 20px;
  margin-bottom: 9px;
  background: linear-gradient(90deg, var(--bg2) 25%, var(--bg) 50%, var(--bg2) 75%);
  background-size: 400px 100%;
  animation: shimmer 1.4s ease-in-out infinite;
}
.sk-line-short { width: 40%; }
.sk-line-long  { width: 90%; }
.sk-line-med   { width: 65%; }
[data-theme="dark"] .bk-skeleton { background: var(--card-bg); border-color: var(--border); }
[data-theme="dark"] .sk-cover,
[data-theme="dark"] .sk-line {
  background: linear-gradient(90deg, var(--bg2) 25%, var(--border) 50%, var(--bg2) 75%);
  background-size: 400px 100%;
}
    [data-theme="dark"] .notif-panel{background:var(--card-bg);}
    [data-theme="dark"] .riwayat-table thead tr{background:var(--bg2);}
    [data-theme="dark"] .riwayat-table td{border-color:var(--border);color:var(--text);}
    [data-theme="dark"] .denda-card{background:var(--card-bg);border-color:var(--border);}

    /* DASHBOARD */
    .dash-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px;margin-bottom:22px;}
    .dash-stat{background:var(--card-bg);border:1.5px solid var(--border);border-radius:var(--r);padding:18px;display:flex;align-items:center;gap:14px;transition:.2s;animation:fadeUpIn .4s ease both;}
    .dash-stat:hover{box-shadow:var(--shadow-md);transform:translateY(-2px);}
    .ds-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
    .ds-val{font-size:1.5rem;font-weight:800;color:var(--text);line-height:1;}
    .ds-label{font-size:11px;color:var(--text3);margin-top:2px;}
    .dash-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;}
    .chart-bar-item{display:flex;align-items:center;gap:9px;margin-bottom:8px;}
    .cbi-label{font-size:11px;color:var(--text2);width:110px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cbi-bar-bg{flex:1;height:7px;background:var(--bg2);border-radius:20px;overflow:hidden;}
    .cbi-bar{height:100%;border-radius:20px;background:var(--blue);transition:width 1s cubic-bezier(.23,1,.32,1);width:0;}
    .cbi-val{font-size:10.5px;font-weight:700;color:var(--text2);width:18px;text-align:right;flex-shrink:0;}
    .rl-item{display:flex;align-items:center;gap:9px;padding:9px 0;border-bottom:1px solid var(--bg2);}
    .rl-item:last-child{border-bottom:none;}
    .rl-thumb{width:28px;height:36px;border-radius:5px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.7rem;color:rgba(255,255,255,.7);}
    .rl-info{flex:1;min-width:0;}
    .rl-title{font-size:12px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .rl-sub{font-size:10.5px;color:var(--text3);margin-top:1px;}
    .rl-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;flex-shrink:0;}

    /* MANAJEMEN */
    .add-btn{padding:9px 17px;border-radius:var(--r-sm);background:var(--navy);color:#fff;border:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;transition:.2s;}
    .add-btn:hover{background:var(--blue);transform:translateY(-1px);}
    .mgmt-table{width:100%;border-collapse:collapse;}
    .mgmt-table th{padding:10px 12px;text-align:left;font-size:10.5px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--text3);background:var(--bg);}
    .mgmt-table td{padding:11px 12px;border-bottom:1px solid var(--bg2);font-size:12.5px;color:var(--text);vertical-align:middle;}
    .mgmt-table tr:last-child td{border-bottom:none;}
    .mgmt-table tr:hover td{background:rgba(59,124,244,.02);}
    .tbl-btn{width:27px;height:27px;border-radius:7px;border:none;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;transition:.2s;}
    .tbl-btn.edit{background:rgba(59,124,244,.1);color:var(--blue);}
    .tbl-btn.edit:hover{background:var(--blue);color:#fff;}
    .tbl-btn.del{background:var(--red-bg);color:var(--red);}
    .tbl-btn.del:hover{background:var(--red);color:#fff;}

    /* PROFIL */
    .profil-layout{display:grid;grid-template-columns:285px 1fr;gap:20px;align-items:start;}
    .member-card{background:linear-gradient(135deg,var(--navy3),var(--navy));border-radius:18px;padding:22px;color:#fff;position:relative;overflow:hidden;}
   .member-card::before {
  content: '';
  position: absolute;
  top: 0; left: -75%;
  width: 50%; height: 100%;
  background: linear-gradient(
    120deg,
    transparent 0%,
    rgba(255,255,255,.07) 50%,
    transparent 100%
  );
  animation: cardShimmer 3s 1s ease-in-out infinite;
  pointer-events: none;
  z-index: 10;
}
.member-card .mc-bg-glow {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse 80% 60% at 80% 20%, rgba(59,124,244,.25), transparent);
  pointer-events: none;
}
    .member-card::after{content:'';position:absolute;inset:0;background-image:repeating-linear-gradient(-45deg,rgba(255,255,255,.03) 0,rgba(255,255,255,.03) 1px,transparent 1px,transparent 20px);pointer-events:none;}
    .mc-header{display:flex;align-items:center;gap:10px;margin-bottom:18px;position:relative;z-index:1;}
    .mc-logo{width:34px;height:34px;background:rgba(255,255,255,.15);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:14px;}
    .mc-school{font-size:10px;font-weight:700;line-height:1.3;opacity:.8;}
    .mc-avatar-big{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:800;color:#fff;border:3px solid rgba(255,255,255,.35);box-shadow:0 4px 18px rgba(0,0,0,.35),0 0 0 5px rgba(255,255,255,.08);margin:0 auto 14px;position:relative;z-index:1;animation:none!important;transform:none!important;}
    .mc-name{font-size:.95rem;font-weight:800;text-align:center;margin-bottom:3px;position:relative;z-index:1;}
    .mc-role-text{font-size:11px;opacity:.6;text-align:center;margin-bottom:15px;position:relative;z-index:1;}
    .mc-info{display:grid;grid-template-columns:1fr 1fr;gap:8px;position:relative;z-index:1;}
    .mc-field{background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;}
    .mc-field-label{font-size:9px;opacity:.55;letter-spacing:1px;text-transform:uppercase;margin-bottom:2px;}
    .mc-field-val{font-size:12px;font-weight:700;}
    .mc-barcode{margin-top:14px;position:relative;z-index:1;text-align:center;}
    .mc-barcode-bars{display:flex;gap:2px;justify-content:center;height:28px;align-items:flex-end;margin-bottom:4px;}
    .mc-bar{background:rgba(255,255,255,.6);border-radius:1px;}
    .mc-barcode-num{font-size:9px;opacity:.45;letter-spacing:2px;font-family:monospace;}
    .mc-status-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(22,163,74,.2);border:1px solid rgba(22,163,74,.3);color:#4ade80;font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;margin-top:8px;}
    .profil-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:11px;margin-bottom:16px;}
    .ps-item{background:var(--card-bg);border:1.5px solid var(--border);border-radius:var(--r-sm);padding:13px;text-align:center;}
    .ps-val{font-size:1.35rem;font-weight:800;color:var(--blue);}
    .ps-label{font-size:10.5px;color:var(--text3);margin-top:2px;}

    /* FORM MODAL BUKU */
    .fmodal{max-width:500px;}
    .fmodal-header{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
    .fmodal-title{font-size:.95rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:7px;}
    .fmodal-close{width:28px;height:28px;border-radius:50%;border:none;background:var(--bg2);color:var(--text3);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:.2s;}
    .fmodal-close:hover{background:var(--red-bg);color:var(--red);}
    .fmodal-body{padding:20px 22px;}
    .fmodal-footer{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:9px;justify-content:flex-end;}
    .fmodal-btn{padding:10px 20px;border-radius:var(--r-sm);border:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;transition:.2s;}
    .fmodal-btn.save{background:var(--navy);color:#fff;}
    .fmodal-btn.save:hover{background:var(--blue);}
    .fmodal-btn.cancel{background:var(--bg2);color:var(--text2);}

    /* REMINDER */
    .reminder-banner{padding:10px 32px;display:flex;align-items:center;gap:9px;font-size:12.5px;font-weight:600;color:#fff;}
    .reminder-banner.warn-b{background:linear-gradient(90deg,var(--orange),var(--red));}
    .reminder-banner.info-b{background:linear-gradient(90deg,#4f46e5,var(--blue));}
    .reminder-banner.urgent-b{background:linear-gradient(90deg,#991b1b,var(--red));}
    .rb-close{margin-left:auto;background:rgba(255,255,255,.2);border:none;color:#fff;width:22px;height:22px;border-radius:50%;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

    @media(max-width:900px){.profil-layout{grid-template-columns:1fr;}.dash-row{grid-template-columns:1fr;}.dash-grid{grid-template-columns:1fr 1fr;}}

    @keyframes spin      { to{transform:rotate(360deg);} }

    /* ── LOGIN ── */
    #page-login {
      min-height:100vh;
      background:linear-gradient(135deg,var(--navy) 0%,#0a1428 40%,#112244 100%);
      display:flex; align-items:center; justify-content:center;
      padding:20px; position:relative; overflow:hidden;
    }
    #page-login::before {
      content:''; position:absolute; inset:0;
      background: radial-gradient(ellipse 70% 70% at 80% 20%,rgba(59,124,244,.18) 0%,transparent 60%),
                  radial-gradient(ellipse 50% 50% at 10% 80%,rgba(26,107,107,.12) 0%,transparent 55%);
      pointer-events:none;
    }
    #page-login::after {
      content:''; position:absolute; inset:0;
      background-image: linear-gradient(rgba(255,255,255,.025) 1px,transparent 1px),
                        linear-gradient(90deg,rgba(255,255,255,.025) 1px,transparent 1px);
      background-size:50px 50px; pointer-events:none;
    }
    .orb { position:absolute; border-radius:50%; pointer-events:none; animation:orbFloat linear infinite; }

    .login-container { display:grid; grid-template-columns:1fr 480px; max-width:940px; width:100%; gap:60px; align-items:center; position:relative; z-index:2; }
    .login-brand { color:#fff; animation:fadeUpIn .7s ease both; }
    .login-logo-wrap { display:inline-flex; align-items:center; gap:14px; margin-bottom:40px; }
    .login-logo-icon { width:52px; height:52px; background:var(--blue); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:22px; color:#fff; box-shadow:0 8px 24px rgba(59,124,244,.4); }
    .login-logo-text { font-size:1rem; font-weight:700; color:#fff; line-height:1.25; }
    .login-logo-text small { display:block; font-size:11px; font-weight:400; opacity:.55; letter-spacing:.5px; }
    .login-headline { font-size:clamp(2rem,4vw,3rem); font-weight:800; line-height:1.15; margin-bottom:18px; letter-spacing:-.5px; }
    .login-headline .hi { color:rgba(255,255,255,.45); font-weight:300; display:block; font-size:.7em; margin-bottom:4px; }
    .login-headline .accent { color:var(--blue-l); }
    .login-desc { font-size:.95rem; color:rgba(255,255,255,.45); line-height:1.7; max-width:380px; margin-bottom:36px; }
    .login-features { display:flex; flex-direction:column; gap:12px; }
    .lf-item { display:flex; align-items:center; gap:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:var(--r-sm); padding:12px 16px; animation:fadeUpIn .6s ease both; }
    .lf-icon { width:36px; height:36px; border-radius:8px; background:rgba(59,124,244,.2); border:1px solid rgba(59,124,244,.3); display:flex; align-items:center; justify-content:center; color:var(--blue-l); font-size:14px; flex-shrink:0; }
    .lf-text { font-size:13px; font-weight:500; color:rgba(255,255,255,.7); }

    .login-card { background:#fff; border-radius:24px; padding:40px 36px; box-shadow:0 30px 80px rgba(0,0,0,.3); animation:scaleIn .6s .15s cubic-bezier(.23,1,.32,1) both; }
    .lc-header { text-align:center; margin-bottom:30px; }
    .lc-icon { width:64px; height:64px; background:linear-gradient(135deg,var(--navy3),var(--navy)); border-radius:16px; margin:0 auto 16px; display:flex; align-items:center; justify-content:center; font-size:26px; color:#fff; box-shadow:0 8px 24px rgba(15,27,53,.3); }
    .lc-title { font-size:1.4rem; font-weight:800; color:var(--text); margin-bottom:5px; }
    .lc-sub   { font-size:13px; color:var(--text3); }

    .user-type-tabs { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:5px; margin-bottom:24px; }
    .utt { padding:9px 6px; border-radius:8px; border:none; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; font-size:12px; font-weight:700; color:var(--text3); background:transparent; transition:.2s; display:flex; align-items:center; justify-content:center; gap:5px; }
    .utt i { font-size:11px; }
    .utt.on { background:#fff; color:var(--navy); box-shadow:var(--shadow-sm); }

    .lf-group { margin-bottom:16px; }
    .lf-group label { display:block; font-size:11.5px; font-weight:700; color:var(--text2); letter-spacing:.3px; margin-bottom:7px; }
    .lf-input-wrap { position:relative; }
    .lf-input-wrap i.prefix { position:absolute; left:14px; top:50%; transform:translateY(-50%); color:var(--text3); font-size:14px; pointer-events:none; }
    .lf-input { width:100%; padding:11px 14px 11px 40px; border:1.5px solid var(--border); border-radius:var(--r-sm); font-family:'Plus Jakarta Sans',sans-serif; font-size:14px; color:var(--text); background:#fff; outline:none; transition:.2s; }
    .lf-input:focus { border-color:var(--blue); box-shadow:0 0 0 3px rgba(59,124,244,.1); }
    .lf-input.error { border-color:var(--red); }
    .eye-btn { position:absolute; right:12px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; color:var(--text3); font-size:14px; padding:4px; }
    .lf-error { font-size:11.5px; color:var(--red); margin-top:5px; display:none; }
    .lf-error.show { display:block; }
    .lf-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
    .lf-check { display:flex; align-items:center; gap:7px; cursor:pointer; font-size:13px; color:var(--text2); }
    .lf-check input { accent-color:var(--blue); width:14px; height:14px; cursor:pointer; }
    .lf-forgot { font-size:13px; color:var(--blue); font-weight:600; text-decoration:none; cursor:pointer; }
    .lf-forgot:hover { color:var(--navy); text-decoration:underline; }

    .login-btn { width:100%; padding:14px; border-radius:var(--r-sm); background:linear-gradient(135deg,var(--navy3),var(--navy)); color:#fff; border:none; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; font-size:14px; font-weight:700; transition:.25s; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 16px rgba(15,27,53,.25); margin-bottom:20px; position:relative; overflow:hidden; }
    .login-btn:hover { background:linear-gradient(135deg,var(--blue),var(--navy3)); transform:translateY(-2px); box-shadow:0 8px 24px rgba(59,124,244,.35); }
    .login-btn .spinner { display:none; width:18px; height:18px; border:2px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:spin .7s linear infinite; }
    .login-btn.loading .btn-text { display:none; }
    .login-btn.loading .spinner  { display:block; }

    .alert-error { background:var(--red-bg); border:1px solid rgba(220,38,38,.2); border-radius:var(--r-sm); padding:11px 14px; margin-bottom:14px; font-size:13px; color:var(--red); display:none; align-items:center; gap:8px; }
    .alert-error.show { display:flex; }

    .demo-section { border-top:1px solid var(--border); padding-top:18px; margin-top:4px; }
    .demo-label   { font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--text3); text-align:center; margin-bottom:12px; }
    .demo-accounts { display:flex; flex-direction:column; gap:7px; }
    .demo-acc { display:flex; align-items:center; justify-content:space-between; padding:9px 13px; background:var(--bg); border:1px solid var(--border); border-radius:var(--r-sm); cursor:pointer; transition:.2s; }
    .demo-acc:hover { background:var(--blue-pale); border-color:rgba(59,124,244,.25); }
    .da-left { display:flex; align-items:center; gap:9px; }
    .da-icon { width:28px; height:28px; border-radius:7px; display:flex; align-items:center; justify-content:center; font-size:12px; color:#fff; flex-shrink:0; }
    .da-name { font-size:12px; font-weight:600; color:var(--text); }
    .da-role { font-size:10px; color:var(--text3); }
    .da-use  { font-size:11px; font-weight:600; color:var(--blue); }

    /* ── NAVBAR ── */
    .navbar { background:var(--navy); padding:0 32px; height:62px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:900; box-shadow:0 2px 20px rgba(0,0,0,.3); border-bottom:1px solid rgba(255,255,255,.06); }
    .nav-logo-btn { display:flex; align-items:center; gap:11px; background:none; border:none; cursor:pointer; padding:0; text-align:left; }
    .nav-logo-icon { width:38px; height:38px; border-radius:10px; background:var(--blue); display:flex; align-items:center; justify-content:center; color:#fff; font-size:16px; transition:.2s; flex-shrink:0; }
    .nav-logo-btn:hover .nav-logo-icon { background:var(--blue-l); transform:scale(1.05); }
    .nav-logo-name { color:#fff; font-size:.9rem; font-weight:700; line-height:1.2; }
    .nav-links { display:flex; gap:2px; }
    .nav-link { padding:7px 13px; border-radius:8px; font-size:13px; font-weight:500; color:rgba(255,255,255,.55); background:none; border:none; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; transition:.2s; display:flex; align-items:center; gap:6px; white-space:nowrap; }
    .nav-link i { font-size:12px; }
    .nav-link:hover { background:rgba(255,255,255,.08); color:#fff; }
    .nav-link.active { color:#fff; background:rgba(59,124,244,.22); font-weight:600; }
    .nav-right { display:flex; align-items:center; gap:8px; }
    .nav-icon-btn { width:36px; height:36px; border-radius:9px; border:none; cursor:pointer; background:rgba(255,255,255,.07); color:rgba(255,255,255,.7); font-size:14px; display:flex; align-items:center; justify-content:center; transition:.2s; position:relative; }
    .nav-icon-btn:hover { background:rgba(255,255,255,.14); color:#fff; }
    .notif-dot { width:7px; height:7px; background:#ef4444; border-radius:50%; position:absolute; top:5px; right:5px; border:1.5px solid var(--navy); }

    /* ── USER PILL & DROPDOWN ── */
    .user-pill { display:flex; align-items:center; gap:8px; padding:5px 14px 5px 6px; border-radius:50px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); cursor:pointer; transition:.2s; position:relative; user-select:none; }
    .user-pill:hover { background:rgba(255,255,255,.14); }
    .user-avatar { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#fff; flex-shrink:0; }
    .user-name { font-size:12px; font-weight:600; color:#fff; }
    .user-role { font-size:10px; color:rgba(255,255,255,.45); }
    .user-dropdown {
      position:absolute; top:calc(100% + 10px); right:0;
      background:#fff; border:1px solid var(--border); border-radius:var(--r);
      box-shadow:var(--shadow-lg); width:220px;
      opacity:0; visibility:hidden; transform:translateY(-6px);
      transition:.2s; overflow:hidden; z-index:1050;
      pointer-events:none;
    }
    .user-pill:hover .user-dropdown,
    .user-pill:focus-within .user-dropdown { opacity:1; visibility:visible; transform:translateY(0); pointer-events:auto; }
    .ud-header { padding:14px 16px; background:var(--bg); border-bottom:1px solid var(--border); }
    .ud-name  { font-size:13px; font-weight:700; color:var(--text); }
    .ud-email { font-size:11px; color:var(--text3); margin-top:1px; }
    .ud-item { padding:10px 16px; font-size:13px; font-weight:500; color:var(--text2); cursor:pointer; transition:.15s; display:flex; align-items:center; gap:9px; border:none; background:none; width:100%; font-family:'Plus Jakarta Sans',sans-serif; text-align:left; }
    .ud-item:hover { background:var(--bg); color:var(--text); }
    .ud-item i { width:14px; text-align:center; color:var(--text3); }
    .ud-item.danger { color:var(--red); }
    .ud-item.danger:hover { background:var(--red-bg); }
    .ud-item.danger i { color:var(--red); }
    .ud-sep { height:1px; background:var(--border); }

    /* ══ ADMIN NOTIF PANEL (BARU) ══ */
    .notif-panel-wrapper { position:relative; }
    .notif-panel {
      position:absolute; top:calc(100% + 12px); right:0;
      width:380px; background:#fff; border-radius:16px;
      border:1.5px solid var(--border); box-shadow:var(--shadow-lg);
      opacity:0; visibility:hidden; transform:translateY(-8px) scale(.97);
      transition:.25s cubic-bezier(.23,1,.32,1); z-index:1100;
      overflow:hidden;
    }
    .notif-panel.open { opacity:1; visibility:visible; transform:translateY(0) scale(1); }
    .np-header {
      padding:14px 18px; background:linear-gradient(135deg,var(--navy3),var(--navy));
      display:flex; align-items:center; justify-content:space-between;
    }
    .np-title { font-size:13px; font-weight:700; color:#fff; display:flex; align-items:center; gap:7px; }
    .np-badge { background:var(--red); color:#fff; font-size:10px; font-weight:700; padding:2px 7px; border-radius:20px; }
    .np-close { background:rgba(255,255,255,.15); border:none; color:#fff; width:26px; height:26px; border-radius:50%; cursor:pointer; font-size:11px; display:flex; align-items:center; justify-content:center; transition:.2s; }
    .np-close:hover { background:rgba(255,255,255,.3); }
    .np-body { max-height:400px; overflow-y:auto; }
    .np-empty { padding:36px 20px; text-align:center; color:var(--text3); font-size:13px; }
    .np-empty i { font-size:2rem; display:block; margin-bottom:8px; opacity:.35; }
    .np-item {
      padding:14px 18px; border-bottom:1px solid var(--bg2);
      animation:fadeUpIn .3s ease both;
    }
    .np-item:last-child { border-bottom:none; }
    .np-item-top { display:flex; align-items:flex-start; gap:10px; margin-bottom:10px; }
    .np-thumb { width:34px; height:44px; border-radius:6px; display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,.7); font-size:.85rem; flex-shrink:0; }
    .np-info { flex:1; min-width:0; }
    .np-book { font-size:12.5px; font-weight:700; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .np-user { font-size:11px; color:var(--text3); margin-top:2px; }
    .np-dates { font-size:10.5px; color:var(--text2); margin-top:3px; }
    .np-time { font-size:10px; color:var(--text3); white-space:nowrap; flex-shrink:0; }
    .np-actions { display:flex; gap:8px; }
    .np-btn { flex:1; padding:8px; border-radius:8px; border:none; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; font-size:12px; font-weight:700; transition:.2s; display:flex; align-items:center; justify-content:center; gap:5px; }
    .np-btn.approve { background:var(--green-bg); color:var(--green); }
    .np-btn.approve:hover { background:var(--green); color:#fff; }
    .np-btn.reject  { background:var(--red-bg); color:var(--red); }
    .np-btn.reject:hover { background:var(--red); color:#fff; }

    /* Badge jumlah pending di lonceng */
    .bell-count {
      position:absolute; top:-4px; right:-4px;
      background:var(--red); color:#fff;
      font-size:9px; font-weight:700;
      min-width:16px; height:16px;
      border-radius:20px; padding:0 4px;
      display:flex; align-items:center; justify-content:center;
      border:1.5px solid var(--navy);
      pointer-events:none;
    }

    /* ── HERO ── */
    .page-hero { background:linear-gradient(135deg,var(--navy) 0%,var(--navy3) 60%,#1e3a6e 100%); padding:40px 32px 46px; position:relative; overflow:hidden; }
    .page-hero::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse 60% 80% at 80% 50%,rgba(59,124,244,.18) 0%,transparent 70%); pointer-events:none; }
    .page-hero::after { content:''; position:absolute; inset:0; background-image:linear-gradient(rgba(255,255,255,.028) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.028) 1px,transparent 1px); background-size:42px 42px; pointer-events:none; }
    .hero-inner { position:relative; z-index:1; max-width:1200px; margin:0 auto; }
    .breadcrumb { display:flex; align-items:center; gap:6px; font-size:12px; color:rgba(255,255,255,.45); margin-bottom:16px; }
    .breadcrumb span { cursor:pointer; transition:.2s; }
    .breadcrumb span:hover { color:rgba(255,255,255,.8); }
    .breadcrumb i { font-size:9px; }
    .hero-title { font-size:1.9rem; font-weight:800; color:#fff; letter-spacing:-.3px; margin-bottom:7px; animation:fadeUpIn .5s ease both; }
    .hero-sub   { font-size:13.5px; color:rgba(255,255,255,.5); max-width:500px; line-height:1.65; margin-bottom:26px; animation:fadeUpIn .5s .08s ease both; }
    .hero-stats { display:flex; gap:28px; flex-wrap:wrap; animation:fadeUpIn .5s .16s ease both; }
    .hstat { display:flex; flex-direction:column; gap:2px; }
    .hstat-val { font-size:1.5rem; font-weight:800; color:#fff; line-height:1; display:flex; align-items:baseline; gap:3px; }
    .hstat-val span { font-size:.85rem; color:var(--blue-l); font-weight:700; }
    .hstat-lbl { font-size:11px; color:rgba(255,255,255,.4); letter-spacing:.5px; text-transform:uppercase; }

    /* ── TABS ── */
    .tabs-bar { background:var(--navy2); border-bottom:1px solid rgba(255,255,255,.07); padding:0 32px; display:flex; gap:2px; overflow-x:auto; }
    .tab-btn { padding:13px 18px; font-family:'Plus Jakarta Sans',sans-serif; font-size:13px; font-weight:600; color:rgba(255,255,255,.4); background:none; border:none; cursor:pointer; border-bottom:2.5px solid transparent; transition:.2s; display:flex; align-items:center; gap:7px; white-space:nowrap; flex-shrink:0; }
    .tab-btn:hover { color:rgba(255,255,255,.7); }
    .tab-btn.on { color:#fff; border-bottom-color:var(--blue); }
    .tab-count { background:rgba(59,124,244,.3); color:var(--blue-l); font-size:10px; font-weight:700; padding:2px 7px; border-radius:20px; }
    .tab-btn.on .tab-count { background:var(--blue); color:#fff; }

    /* ── MAIN ── */
    .main { max-width:1200px; margin:0 auto; padding:26px 32px 80px; }
    .toolbar { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
    .search-field { flex:1; min-width:200px; display:flex; align-items:center; gap:9px; background:#fff; border:1.5px solid var(--border); border-radius:var(--r-sm); padding:9px 14px; transition:.2s; }
    .search-field:focus-within { border-color:var(--blue); box-shadow:0 0 0 3px rgba(59,124,244,.1); }
    .search-field i { color:var(--text3); font-size:13px; }
    .search-field input { flex:1; border:none; outline:none; font-family:'Plus Jakarta Sans',sans-serif; font-size:13.5px; color:var(--text); background:none; }
    .search-field input::placeholder { color:var(--text3); }
    .pill-group { display:flex; gap:6px; flex-wrap:wrap; }
    .pill { padding:7px 14px; border-radius:50px; font-family:'Plus Jakarta Sans',sans-serif; font-size:12px; font-weight:600; border:1.5px solid var(--border); background:#fff; color:var(--text2); cursor:pointer; transition:.2s; display:flex; align-items:center; gap:5px; white-space:nowrap; }
    .pill:hover { border-color:var(--blue); color:var(--blue); }
    .pill.on { background:var(--navy); color:#fff; border-color:var(--navy); box-shadow:var(--shadow-sm); }
    .icon-btn { width:38px; height:38px; border-radius:var(--r-sm); border:1.5px solid var(--border); background:#fff; color:var(--text3); cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; font-size:13px; }
    .icon-btn:hover { border-color:var(--blue); color:var(--blue); }
    .icon-btn.on { background:var(--navy); color:#fff; border-color:var(--navy); }
    .result-meta { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; flex-wrap:wrap; gap:10px; }
    .result-text { font-size:13px; color:var(--text2); }
    .result-text strong { color:var(--text); }
    .sort-box { padding:7px 13px; border-radius:var(--r-sm); border:1.5px solid var(--border); background:#fff; font-family:'Plus Jakarta Sans',sans-serif; font-size:13px; color:var(--text); outline:none; cursor:pointer; }

    /* ── GRID BUKU ── */
    .books-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(195px,1fr)); gap:18px; transition:.3s; }
    .books-grid.list-mode { grid-template-columns:1fr; }
    .bk { background:#fff; border-radius:var(--r); overflow:hidden; border:1.5px solid var(--border); cursor:pointer; transition:transform .25s,box-shadow .25s,border-color .2s; opacity:0; transform:translateY(16px); }
    .bk.in { opacity:1; transform:none; }
    .bk:hover { transform:translateY(-4px); box-shadow:var(--shadow-lg); border-color:var(--border2); }
    .bk-cover { height:170px; position:relative; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .bk-cover-inner { width:100%; height:100%; display:flex; align-items:center; justify-content:center; position:relative; transition:transform .4s cubic-bezier(.23,1,.32,1); }
    .bk:hover .bk-cover-inner { transform:scale(1.04); }
    .cover-lines { position:absolute; inset:0; background-image:repeating-linear-gradient(-45deg,rgba(255,255,255,.07) 0,rgba(255,255,255,.07) 1px,transparent 1px,transparent 18px); }
    .cover-ico { font-size:2.6rem; color:rgba(255,255,255,.5); position:relative; z-index:2; transition:transform .3s; }
    .bk:hover .cover-ico { transform:scale(1.1) rotate(-5deg); }
    .cover-top { position:absolute; top:10px; left:10px; right:10px; display:flex; justify-content:space-between; align-items:flex-start; z-index:5; }
    .cat-badge { font-size:9px; font-weight:700; letter-spacing:1.2px; text-transform:uppercase; background:rgba(0,0,0,.35); backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,.15); color:#fff; padding:3px 9px; border-radius:20px; }
    .status-badge { font-size:9px; font-weight:700; padding:3px 9px; border-radius:20px; white-space:nowrap; }
    .sb-avail  { background:#16a34a; color:#fff; }
    .sb-limit  { background:#ea580c; color:#fff; }
    .sb-borrow { background:#dc2626; color:#fff; }
    .cover-actions { position:absolute; inset:0; background:rgba(15,27,53,.6); display:flex; align-items:center; justify-content:center; gap:9px; opacity:0; transition:opacity .3s; z-index:6; }
    .bk:hover .cover-actions { opacity:1; }
    .ca { width:38px; height:38px; border-radius:50%; background:rgba(255,255,255,.14); backdrop-filter:blur(6px); border:1.5px solid rgba(255,255,255,.3); color:#fff; font-size:14px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s; }
    .ca:hover { background:#fff; color:var(--navy); }
    .bk-body { padding:13px 13px 15px; }
    .bk-cat { font-size:9.5px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--blue); margin-bottom:4px; }
    .bk-title { font-size:.87rem; font-weight:700; color:var(--text); line-height:1.25; margin-bottom:3px; transition:color .2s; }
    .bk:hover .bk-title { color:var(--blue); }
    .bk-author { font-size:11px; color:var(--text3); margin-bottom:9px; display:flex; align-items:center; gap:3px; }
    .bk-footer { display:flex; align-items:center; justify-content:space-between; padding-top:9px; border-top:1px solid var(--bg2); }
    .bk-year  { font-size:11px; color:var(--text3); display:flex; align-items:center; gap:3px; }
    .bk-stock { font-size:11px; font-weight:700; }
    .stock-ok  { color:var(--green); }
    .stock-low { color:var(--orange); }
    .stock-out { color:var(--red); }
    .books-grid.list-mode .bk { display:flex; }
    .books-grid.list-mode .bk-cover { width:100px; height:auto; flex-shrink:0; border-radius:0; border-right:1px solid var(--border); }
    .books-grid.list-mode .bk-cover-inner { height:100%; }
    .books-grid.list-mode .bk-body { flex:1; display:flex; flex-direction:column; justify-content:center; padding:16px 20px; }
    .books-grid.list-mode .bk-title { font-size:.95rem; }
    .books-grid.list-mode .cover-actions { display:none; }
    .empty-state { grid-column:1/-1; text-align:center; padding:60px 20px; display:none; }
    .empty-state.show { display:block; }
    .empty-ico { width:64px; height:64px; background:var(--bg2); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 14px; font-size:1.6rem; color:var(--text3); }
    .empty-title { font-size:1rem; font-weight:700; color:var(--text2); margin-bottom:4px; }
    .empty-sub   { font-size:13px; color:var(--text3); }

    /* ── FORM PEMINJAMAN ── */
    .pinjam-layout { display:grid; grid-template-columns:1fr 340px; gap:22px; align-items:start; }
    .card-box { background:#fff; border:1.5px solid var(--border); border-radius:var(--r); padding:24px; box-shadow:var(--shadow-sm); }
    .card-box-title { font-size:.95rem; font-weight:700; color:var(--text); margin-bottom:18px; display:flex; align-items:center; gap:7px; }
    .card-box-title i { color:var(--blue); }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .fg { display:flex; flex-direction:column; gap:5px; }
    .fg label { font-size:11.5px; font-weight:700; color:var(--text2); letter-spacing:.3px; }
    .fg input, .fg select, .fg textarea { padding:9px 13px; border-radius:var(--r-sm); border:1.5px solid var(--border); font-family:'Plus Jakarta Sans',sans-serif; font-size:13.5px; color:var(--text); background:#fff; outline:none; transition:.2s; }
    .fg input:focus, .fg select:focus, .fg textarea:focus { border-color:var(--blue); box-shadow:0 0 0 3px rgba(59,124,244,.1); }
    .fg textarea { resize:vertical; min-height:70px; }
    .book-search-result { margin-top:7px; border:1.5px solid var(--border); border-radius:var(--r-sm); overflow:hidden; display:none; }
    .book-search-result.show { display:block; }
    .bsr-item { display:flex; align-items:center; gap:10px; padding:9px 13px; cursor:pointer; transition:.15s; border-bottom:1px solid var(--bg); }
    .bsr-item:last-child { border-bottom:none; }
    .bsr-item:hover { background:var(--bg); }
    .bsr-thumb { width:32px; height:42px; border-radius:5px; display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,.7); font-size:.9rem; flex-shrink:0; }
    .bsr-info  { flex:1; min-width:0; }
    .bsr-title { font-size:12.5px; font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .bsr-meta  { font-size:10.5px; color:var(--text3); }
    .bsr-stock { font-size:10.5px; font-weight:700; flex-shrink:0; }
    .selected-book { display:none; align-items:center; gap:10px; padding:10px 13px; background:rgba(59,124,244,.06); border:1.5px solid rgba(59,124,244,.2); border-radius:var(--r-sm); margin-top:8px; }
    .selected-book.show { display:flex; }
    .sb-remove { width:26px; height:26px; border-radius:50%; border:none; background:rgba(220,38,38,.1); color:var(--red); cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; font-size:11px; }
    .sb-remove:hover { background:var(--red); color:#fff; }
    .submit-btn { width:100%; padding:13px; border-radius:var(--r-sm); background:var(--navy); color:#fff; border:none; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; font-size:14px; font-weight:700; display:flex; align-items:center; justify-content:center; gap:7px; transition:.25s; margin-top:8px; }
    .submit-btn:hover { background:var(--blue); transform:translateY(-2px); box-shadow:0 6px 20px rgba(59,124,244,.3); }
    .summary-row { display:flex; justify-content:space-between; align-items:center; padding:9px 0; border-bottom:1px solid var(--bg2); font-size:12.5px; }
    .summary-row:last-child { border-bottom:none; }
    .sr-label { color:var(--text2); }
    .sr-val   { font-weight:600; color:var(--text); }
    .sr-val.accent { color:var(--blue); }
    .sr-val.green  { color:var(--green); }
    .sr-val.red    { color:var(--red); }
    .info-box { background:rgba(59,124,244,.06); border:1px solid rgba(59,124,244,.15); border-radius:var(--r-sm); padding:12px; margin-top:14px; font-size:12px; color:var(--text2); line-height:1.6; display:flex; gap:7px; }
    .info-box i { color:var(--blue); margin-top:1px; flex-shrink:0; }

    /* ── TABEL RIWAYAT ── */
    .del-riwayat-btn { width:26px;height:26px;border-radius:6px;border:none;background:var(--red-bg);color:var(--red);cursor:pointer;font-size:11px;display:inline-flex;align-items:center;justify-content:center;margin-left:4px;transition:.2s;vertical-align:middle; }
    .del-riwayat-btn:hover { background:var(--red);color:#fff; }
    .riwayat-table { width:100%; border-collapse:collapse; }
    .riwayat-table thead tr { background:var(--bg); }
    .riwayat-table th { padding:11px 14px; text-align:left; font-size:10.5px; font-weight:700; letter-spacing:.5px; text-transform:uppercase; color:var(--text3); white-space:nowrap; }
    .riwayat-table td { padding:13px 14px; border-bottom:1px solid var(--bg2); font-size:12.5px; color:var(--text); }
    .riwayat-table tr:last-child td { border-bottom:none; }
    .riwayat-table tr:hover td { background:rgba(59,124,244,.025); }
    .book-cell { display:flex; align-items:center; gap:9px; }
    .rt-thumb  { width:28px; height:36px; border-radius:5px; display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,.65); font-size:.8rem; flex-shrink:0; }
    .rt-title  { font-weight:600; font-size:12.5px; }
    .rt-author { font-size:10.5px; color:var(--text3); }
    .status-pill { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:20px; font-size:10.5px; font-weight:700; white-space:nowrap; }
    .sp-active  { background:var(--green-bg); color:var(--green); }
    .sp-late    { background:var(--red-bg);   color:var(--red); }
    .sp-done    { background:var(--bg2);       color:var(--text3); }
    .sp-borrow  { background:#ffedd5;           color:var(--orange); }
    .sp-pending { background:#fef9c3;           color:#ca8a04; }
    .action-link { font-size:12px; font-weight:600; color:var(--blue); background:none; border:none; cursor:pointer; padding:0; transition:.2s; }
    .action-link:hover { color:var(--navy); }

    /* ── BARIS TERLAMBAT PULSE ── */
    .row-late { animation:latePulse 1.8s ease-in-out infinite; border-left:3px solid var(--red) !important; }
    .row-late td:first-child { border-left:3px solid var(--red); }
    [data-theme="dark"] .row-late { animation:latePulseDark 1.8s ease-in-out infinite; }
    @keyframes latePulseDark { 0%,100%{background:rgba(220,38,38,.0);} 50%{background:rgba(220,38,38,.13);} }

    /* ════════════════════════════════
       EXPORT BUTTONS
    ════════════════════════════════ */
    .export-btn-group { display:flex; gap:7px; align-items:center; flex-wrap:wrap; }
    .export-btn {
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 13px; border-radius:8px; border:1.5px solid var(--border);
      background:var(--bg); color:var(--text2); cursor:pointer;
      font-family:inherit; font-size:12px; font-weight:700;
      transition:.18s; white-space:nowrap;
    }
    .export-btn:hover { border-color:var(--blue); color:var(--blue); background:var(--blue-pale); transform:translateY(-1px); }
    .export-btn.excel:hover { border-color:#16a34a; color:#16a34a; background:rgba(22,163,74,.08); }
    .export-btn.pdf:hover   { border-color:#dc2626; color:#dc2626; background:rgba(220,38,38,.08); }
    .export-btn i { font-size:13px; }

    /* ════════════════════════════════
       GRAFIK BULAN (MONTHLY CHART)
    ════════════════════════════════ */
    .monthly-chart-wrap { width:100%; overflow-x:auto; margin-top:8px; }
    .monthly-chart { display:flex; align-items:flex-end; gap:6px; min-height:130px; padding:0 4px 0; }
    .mc-bar-col { display:flex; flex-direction:column; align-items:center; gap:4px; min-width:34px; flex:1; }
    .mc-bar-col:hover .mc-bar-fill { opacity:.8; }
    .mc-bar-fill {
      width:100%; max-width:38px; border-radius:5px 5px 0 0;
      background:linear-gradient(180deg, var(--blue-l), var(--blue));
      transition:height .55s cubic-bezier(.34,1.56,.64,1);
      cursor:default; position:relative;
    }
    .mc-bar-fill.late-fill { background:linear-gradient(180deg,#f87171,var(--red)); }
    .mc-bar-fill[data-tip]:hover::after {
      content:attr(data-tip); position:absolute; bottom:calc(100% + 5px); left:50%; transform:translateX(-50%);
      background:var(--navy); color:#fff; font-size:10px; font-weight:700; padding:3px 7px;
      border-radius:5px; white-space:nowrap; pointer-events:none; z-index:5;
    }
    .mc-bar-fill[data-tip]:hover::before {
      content:''; position:absolute; bottom:calc(100% + 1px); left:50%; transform:translateX(-50%);
      border:4px solid transparent; border-top-color:var(--navy); pointer-events:none; z-index:5;
    }
    .mc-bar-label { font-size:9.5px; font-weight:700; color:var(--text3); text-align:center; }
    .mc-bar-val   { font-size:10px; font-weight:800; color:var(--blue); text-align:center; }
    .mc-legend { display:flex; gap:14px; margin-top:10px; flex-wrap:wrap; }
    .mc-legend-item { display:flex; align-items:center; gap:5px; font-size:11px; color:var(--text2); font-weight:600; }
    .mc-legend-dot { width:10px; height:10px; border-radius:3px; }
    .chart-tab-group { display:flex; gap:6px; margin-bottom:14px; }
    .chart-tab { padding:5px 12px; border-radius:20px; border:1.5px solid var(--border); background:var(--bg); color:var(--text3); font-size:11.5px; font-weight:700; cursor:pointer; transition:.15s; font-family:inherit; }
    .chart-tab.on { background:var(--blue); border-color:var(--blue); color:#fff; }
    .dash-row-full { margin-bottom:16px; }

    /* ════════════════════════════════
   AVATAR UPLOAD - FIXED
════════════════════════════════ */
.avatar-upload-wrap {
  position: relative;
  display: block;
  width: 72px;
  height: 72px;
  margin: 0 auto 14px;
}
.mc-avatar-big {
  width: 72px !important;
  height: 72px !important;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  font-weight: 800;
  color: #fff;
  border: 3px solid rgba(255,255,255,.35);
  box-shadow: 0 4px 18px rgba(0,0,0,.35), 0 0 0 5px rgba(255,255,255,.08);
  cursor: pointer;
  transition: box-shadow .2s, opacity .2s;
  position: relative;
  z-index: 1;
}
.avatar-upload-wrap:hover .mc-avatar-big {
  opacity: .85;
  box-shadow: 0 6px 24px rgba(0,0,0,.45), 0 0 0 6px rgba(255,255,255,.12);
}
.avatar-upload-overlay {
  position: absolute;
  bottom: 1px;
  right: 1px;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: rgba(255,255,255,.9);
  color: var(--navy);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 9px;
  cursor: pointer;
  border: 2px solid rgba(255,255,255,.6);
  box-shadow: 0 2px 8px rgba(0,0,0,.25);
  transition: background .18s, transform .18s;
  z-index: 2;
}
.avatar-upload-overlay:hover { background: var(--blue); color: #fff; transform: scale(1.1); }
#avatarFileInput { display: none; }
.mc-avatar-big.has-photo {
  background: none !important;
  padding: 0;
  overflow: hidden;
}
.mc-avatar-big.has-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
  display: block;
  animation: none !important;
  transform: none !important;
}

    /* ════════════════════════════════
       PRINT KARTU ANGGOTA
    ════════════════════════════════ */
    .cetak-btn-real {
      width:100%; padding:10px; border-radius:var(--r-sm);
      border:1.5px solid var(--blue); background:var(--blue-pale);
      color:var(--blue); cursor:pointer; font-family:inherit;
      font-size:12px; font-weight:700; display:flex; align-items:center;
      justify-content:center; gap:6px; transition:.2s;
    }
    .cetak-btn-real:hover { background:var(--blue); color:#fff; }

  @media print {
  @page {
    size: 86mm 54mm;
    margin: 0;
  }
  html, body {
    margin: 0 !important;
    padding: 0 !important;
    width: 86mm !important;
    height: 54mm !important;
    overflow: hidden !important;
  }
  body * {
    visibility: hidden !important;
  }
  #printCardArea {
    visibility: visible !important;
    display: block !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 86mm !important;
    height: 54mm !important;
    margin: 0 !important;
    padding: 0 !important;
    z-index: 999999 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  #printCardArea * {
    visibility: visible !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
}
    .pca-header {
      display:flex; align-items:center; gap:8px;
      padding:7px 10px 5px; border-bottom:1px solid rgba(255,255,255,.15);
    }
    .pca-logo {
      width:22px; height:22px; border-radius:5px; background:rgba(255,255,255,.15);
      display:flex; align-items:center; justify-content:center; font-size:10px; flex-shrink:0;
    }
    .pca-school { font-size:7px; font-weight:700; line-height:1.4; }
    .pca-school span { display:block; font-size:8.5px; color:rgba(255,255,255,.85); }
    .pca-type { margin-left:auto; font-size:7px; font-weight:800; letter-spacing:.5px; background:rgba(255,255,255,.15); padding:2px 6px; border-radius:10px; }
    .pca-body { display:flex; gap:9px; align-items:center; padding:7px 10px; }
    .pca-avatar {
      width:34px; height:34px; border-radius:50%; flex-shrink:0;
      background:rgba(255,255,255,.2); display:flex; align-items:center;
      justify-content:center; font-size:13px; font-weight:800; overflow:hidden;
      border:2px solid rgba(255,255,255,.4);
    }
    .pca-avatar img { width:100%; height:100%; object-fit:cover; }
    .pca-info { flex:1; }
    .pca-name { font-size:11px; font-weight:800; line-height:1.3; }
    .pca-nis  { font-size:8px; color:rgba(255,255,255,.7); margin-top:1px; }
    .pca-meta { display:grid; grid-template-columns:1fr 1fr; gap:3px; margin-top:5px; }
    .pca-meta-item label { font-size:6.5px; color:rgba(255,255,255,.55); display:block; }
    .pca-meta-item span  { font-size:8px; font-weight:700; }
    .pca-footer { padding:4px 10px 6px; display:flex; align-items:center; justify-content:space-between; border-top:1px solid rgba(255,255,255,.12); }
    .pca-barcode-wrap { display:flex; gap:1px; align-items:flex-end; }
    .pca-bar { background:rgba(255,255,255,.7); border-radius:1px; }
    .pca-num { font-size:6px; color:rgba(255,255,255,.5); margin-top:2px; }
    .pca-status-badge { font-size:7px; font-weight:800; background:rgba(74,222,128,.2); color:#4ade80; padding:2px 7px; border-radius:10px; border:1px solid rgba(74,222,128,.3); }

    /* ── PERPANJANG BUTTON ── */
    .perpanjang-btn { font-size:11.5px; font-weight:700; color:#fff; background:var(--blue); border:none; cursor:pointer; padding:4px 10px; border-radius:6px; transition:.2s; display:inline-flex; align-items:center; gap:4px; }
    .perpanjang-btn:hover { background:var(--navy); }
    .perpanjang-done { font-size:11px; font-weight:600; color:var(--text3); font-style:italic; }

    /* ── DENDA ── */
    .denda-cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(270px,1fr)); gap:16px; margin-bottom:24px; }
    .denda-card { background:#fff; border:1.5px solid var(--border); border-radius:var(--r); padding:18px; transition:.2s; }
    .denda-card.has-fine { border-color:rgba(220,38,38,.25); background:rgba(254,242,242,.3); }
    .denda-card:hover { box-shadow:var(--shadow-md); }
    .dc-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:12px; }
    .dc-thumb { width:32px; height:42px; border-radius:6px; display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,.7); font-size:.9rem; flex-shrink:0; }
    .dc-title  { font-size:12.5px; font-weight:700; color:var(--text); }
    .dc-author { font-size:10.5px; color:var(--text3); margin-top:2px; }
    .dc-amount { font-size:1.2rem; font-weight:800; color:var(--red); text-align:right; }
    .dc-amount small { display:block; font-size:9.5px; font-weight:500; color:var(--text3); }
    .dc-row { display:flex; justify-content:space-between; font-size:11.5px; margin-bottom:7px; }
    .dc-row-label { color:var(--text2); }
    .dc-row-val   { font-weight:600; color:var(--text); }
    .dc-pay-btn { width:100%; padding:9px; margin-top:12px; border-radius:var(--r-sm); background:var(--red); color:#fff; border:none; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; font-size:12.5px; font-weight:700; transition:.2s; display:flex; align-items:center; justify-content:center; gap:5px; }
    .dc-pay-btn:hover { background:#b91c1c; transform:translateY(-1px); }
    .no-fine { padding:13px; background:var(--green-bg); border:1px solid rgba(22,163,74,.2); border-radius:var(--r-sm); display:flex; align-items:center; gap:9px; font-size:13px; font-weight:600; color:var(--green); }

    /* ── MODAL ── */
    .modal-backdrop { position:fixed; inset:0; background:rgba(15,27,53,.6); backdrop-filter:blur(8px); z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px; opacity:0; visibility:hidden; transition:.3s; }
    .modal-backdrop.open { opacity:1; visibility:visible; }
    .modal { background:#fff; border-radius:20px; max-width:600px; width:100%; overflow:hidden; transform:scale(.94) translateY(14px); transition:transform .35s cubic-bezier(.23,1,.32,1); box-shadow:0 30px 80px rgba(0,0,0,.25); border:1px solid var(--border); max-height:90vh; overflow-y:auto; }
    .modal-backdrop.open .modal { transform:scale(1) translateY(0); }
    .modal-cover { height:180px; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .modal-cover-ico { font-size:3.5rem; color:rgba(255,255,255,.4); position:relative; z-index:2; }
    .modal-cover-lines { position:absolute; inset:0; background-image:repeating-linear-gradient(-45deg,rgba(255,255,255,.07) 0,rgba(255,255,255,.07) 1px,transparent 1px,transparent 18px); }
    .modal-cover-badge { position:absolute; top:13px; left:13px; background:rgba(0,0,0,.3); backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,.15); color:#fff; font-size:9px; font-weight:700; letter-spacing:1.2px; text-transform:uppercase; padding:3px 10px; border-radius:20px; }
    .modal-close { position:absolute; top:11px; right:11px; width:32px; height:32px; border-radius:50%; background:rgba(0,0,0,.25); backdrop-filter:blur(6px); border:none; color:#fff; cursor:pointer; font-size:13px; z-index:10; display:flex; align-items:center; justify-content:center; transition:.2s; }
    .modal-close:hover { background:rgba(0,0,0,.5); transform:rotate(90deg); }
    .modal-body { padding:24px 26px; }
    .modal-genre  { font-size:9.5px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--blue); margin-bottom:5px; }
    .modal-title  { font-size:1.4rem; font-weight:800; color:var(--text); margin-bottom:3px; line-height:1.2; }
    .modal-author { font-size:12.5px; color:var(--text3); margin-bottom:16px; }
    .modal-hr     { height:1px; background:var(--border); margin-bottom:16px; }
    .modal-desc   { font-size:13px; line-height:1.75; color:var(--text2); margin-bottom:18px; }
    .modal-meta-grid { display:grid; grid-template-columns:1fr 1fr; gap:9px; margin-bottom:20px; }
    .mm-item  { background:var(--bg); border-radius:var(--r-sm); padding:10px 12px; }
    .mm-label { font-size:9.5px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--text3); margin-bottom:2px; }
    .mm-val   { font-size:12.5px; font-weight:600; color:var(--text); }
    .modal-actions { display:flex; gap:9px; }
    .m-btn { flex:1; padding:12px; border-radius:var(--r-sm); border:none; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; font-size:13px; font-weight:700; transition:.25s; display:flex; align-items:center; justify-content:center; gap:6px; }
    .m-btn.prim { background:var(--navy); color:#fff; }
    .m-btn.prim:hover { background:var(--blue); }
    .m-btn.sec { background:var(--bg); color:var(--text); }
    .m-btn.sec:hover { background:var(--bg2); }

    /* ── MODAL PERPANJANG ── */
    .perpanjang-modal-body { padding:22px 24px; }
    .perpanjang-modal-body .pm-book-info { display:flex; align-items:center; gap:12px; padding:12px; background:var(--bg); border-radius:var(--r-sm); margin-bottom:18px; }
    .perpanjang-modal-body .pm-thumb { width:36px; height:48px; border-radius:6px; display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,.7); font-size:1rem; flex-shrink:0; }
    .perpanjang-modal-body .pm-title { font-size:13px; font-weight:700; color:var(--text); }
    .perpanjang-modal-body .pm-author { font-size:11px; color:var(--text3); margin-top:2px; }
    .perpanjang-dates { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:18px; }
    .pd-item { background:var(--bg); border-radius:var(--r-sm); padding:12px; text-align:center; }
    .pd-label { font-size:10px; font-weight:700; letter-spacing:.8px; text-transform:uppercase; color:var(--text3); margin-bottom:5px; }
    .pd-val { font-size:14px; font-weight:700; color:var(--text); }
    .pd-val.new { color:var(--green); }
    .pd-arrow { display:flex; align-items:center; justify-content:center; color:var(--text3); font-size:1.2rem; }
    .perpanjang-info { background:rgba(59,124,244,.06); border:1px solid rgba(59,124,244,.15); border-radius:var(--r-sm); padding:12px; font-size:12px; color:var(--text2); line-height:1.6; display:flex; gap:7px; margin-bottom:18px; }
    .perpanjang-info i { color:var(--blue); flex-shrink:0; margin-top:1px; }
    .perpanjang-modal-footer { display:flex; gap:9px; justify-content:flex-end; padding-top:4px; }

    /* ── TOAST ── */
    .toast { position:fixed; bottom:24px; right:24px; background:var(--navy); color:#fff; padding:12px 18px; border-radius:var(--r); font-size:13px; font-weight:600; display:flex; align-items:center; gap:9px; box-shadow:var(--shadow-lg); transform:translateY(80px); opacity:0; transition:.35s cubic-bezier(.23,1,.32,1); z-index:9999; max-width:310px; }
    .toast.show { transform:translateY(0); opacity:1; }
    .toast.success { background:var(--green); }
    .toast.error   { background:var(--red); }
    .toast.info    { background:var(--blue); }

    @media(max-width:860px) {
      .login-container { grid-template-columns:1fr; max-width:440px; }
      .login-brand { display:none; }
      .navbar { padding:0 16px; }
      .nav-links { display:none; }
      .main { padding:18px 16px 60px; }
      .pinjam-layout { grid-template-columns:1fr; }
      .form-grid { grid-template-columns:1fr; }
      .books-grid { grid-template-columns:repeat(auto-fill,minmax(155px,1fr)); gap:13px; }
      .tabs-bar { padding:0 16px; }
      .page-hero { padding:28px 16px 34px; }
      .hero-stats { gap:18px; }
      .notif-panel { width:320px; right:-10px; }
    }

    [data-theme="dark"]{--navy:#0a1020;--navy2:#0d1628;--navy3:#121e3a;--bg:#111827;--bg2:#1a2540;--border:#1e3050;--text:#e2e8f8;--text2:#8a9bc0;--text3:#4a5a80;--card-bg:#131d32;--page-bg:#0d1525;--input-bg:#1a2540;--blue:#5b9cf6;}
    [data-theme="dark"] .login-card{background:#131d32;}
    [data-theme="dark"] .lf-input{background:#1a2540;color:var(--text);border-color:var(--border);}
    [data-theme="dark"] .demo-acc,[data-theme="dark"] .user-type-tabs,[data-theme="dark"] .sort-box{background:var(--bg2);border-color:var(--border);color:var(--text);}
    [data-theme="dark"] .fg input,[data-theme="dark"] .fg select,[data-theme="dark"] .fg textarea{background:var(--input-bg);color:var(--text);border-color:var(--border);}
    [data-theme="dark"] .utt.on{background:var(--navy3);color:var(--text);}
    [data-theme="dark"] .riwayat-table td{border-color:var(--border);color:var(--text);}
    [data-theme="dark"] .riwayat-table thead tr{background:var(--bg2);}
    [data-theme="dark"] .denda-card{background:var(--card-bg);border-color:var(--border);}
    [data-theme="dark"] .mgmt-table th{background:var(--bg2);}
    [data-theme="dark"] .mgmt-table td{border-color:var(--border);color:var(--text);}
    /* ══ TRANSISI HALAMAN ══ */
.page.entering {
  display: block;
  animation: pageEnter 0.45s cubic-bezier(0.23,1,0.32,1) both;
}
.page.exiting {
  display: block;
  animation: pageExit 0.3s cubic-bezier(0.55,0,1,0.45) both;
  pointer-events: none;
}
@keyframes pageEnter {
  from { opacity:0; transform:translateY(22px) scale(0.985); filter:blur(4px); }
  to   { opacity:1; transform:translateY(0) scale(1); filter:blur(0); }
}
@keyframes pageExit {
  from { opacity:1; transform:translateY(0) scale(1); }
  to   { opacity:0; transform:translateY(-12px) scale(1.01); }
}

/* ══ TRANSISI TAB ══ */
.tab-section.tab-exit {
  display: block;
  animation: tabExit 0.22s cubic-bezier(0.55,0,1,0.45) both;
  pointer-events: none;
}
.tab-section.on {
  animation: tabEnter 0.38s cubic-bezier(0.23,1,0.32,1) both;
}
@keyframes tabEnter {
  from { opacity:0; transform:translateX(18px); }
  to   { opacity:1; transform:translateX(0); }
}
@keyframes tabExit {
  from { opacity:1; transform:translateX(0); }
  to   { opacity:0; transform:translateX(-14px); }
}

/* ══ CURTAIN LOGIN ══ */
.page-curtain {
  position:fixed; inset:0; z-index:9999; pointer-events:none;
}
.page-curtain .curtain-panel {
  position:absolute; inset:0;
  background:linear-gradient(135deg,#0f1b35,#1c2d55);
  transform:scaleY(0); transform-origin:bottom center;
  display:flex; align-items:center; justify-content:center;
}
.page-curtain.sweep-in .curtain-panel {
  animation:curtainIn 0.65s cubic-bezier(0.77,0,0.18,1) both;
  pointer-events:all;
}
.page-curtain.sweep-out .curtain-panel {
  animation:curtainOut 0.55s 0.1s cubic-bezier(0.77,0,0.18,1) both;
}
@keyframes curtainIn {
  from { transform:scaleY(0); transform-origin:bottom center; }
  to   { transform:scaleY(1); transform-origin:bottom center; }
}
@keyframes curtainOut {
  from { transform:scaleY(1); transform-origin:top center; }
  to   { transform:scaleY(0); transform-origin:top center; }
}

/* ══ PROGRESS BAR ══ */
.transition-progress {
  position:fixed; top:0; left:0; height:3px; width:0%;
  background:linear-gradient(90deg,#3b7cf4,#5b9cf6,#3b7cf4);
  background-size:200% 100%; z-index:10000;
  border-radius:0 2px 2px 0;
  box-shadow:0 0 10px rgba(59,124,244,.6);
  transition:width 0.3s ease;
  animation:progressShimmer 1.5s linear infinite;
}
@keyframes progressShimmer {
  to { background-position:200% 0%; }
}

/* ══ STAGGER ITEMS ══ */
.stagger-item {
  opacity:0; transform:translateY(16px);
  animation:staggerIn 0.4s cubic-bezier(0.23,1,0.32,1) both;
}
@keyframes staggerIn {
  to { opacity:1; transform:translateY(0); }
}

/* ══ LOGOUT OVERLAY ══ */
.logout-overlay {
  position:fixed; inset:0; background:#0f1b35;
  z-index:9998; opacity:0; pointer-events:none;
  transition:opacity 0.35s ease;
}
.logout-overlay.visible {
  opacity:1; pointer-events:all;
}

/* ─── Kartu Flip 3D ─── */
.member-card-wrapper {
  perspective: 1000px;
}
.member-card {
  animation: cardFlipIn 0.7s cubic-bezier(0.23,1,0.32,1) both;
  transform-style: preserve-3d;
}
@keyframes cardFlipIn {
  from {
    opacity: 0;
    transform: rotateY(-35deg) translateY(20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: rotateY(0deg) translateY(0) scale(1);
  }
}

/* ─── Avatar zoom + glow ─── */
.mc-avatar-big {
  animation: avatarPop 0.6s 0.3s cubic-bezier(0.23,1,0.32,1) both;
}
@keyframes avatarPop {
  0%   { opacity:0; transform:scale(0.4); box-shadow:0 0 0 0 rgba(59,124,244,0); }
  60%  { transform:scale(1.15); box-shadow:0 0 0 12px rgba(59,124,244,.2); }
  80%  { transform:scale(0.95); box-shadow:0 0 0 6px rgba(59,124,244,.1); }
  100% { opacity:1; transform:scale(1); box-shadow:0 4px 18px rgba(0,0,0,.35), 0 0 0 5px rgba(255,255,255,.08); }
}

/* ─── Shimmer di kartu anggota ─── */
.member-card::before {
  content: '';
  position: absolute;
  top: 0; left: -75%;
  width: 50%; height: 100%;
  background: linear-gradient(
    120deg,
    transparent 0%,
    rgba(255,255,255,.07) 50%,
    transparent 100%
  );
  animation: cardShimmer 3s 1s ease-in-out infinite;
  pointer-events: none;
  z-index: 10;
}
@keyframes cardShimmer {
  0%   { left: -75%; }
  40%,100% { left: 130%; }
}

/* ─── Stagger form fields ─── */
.profil-form-field {
  opacity: 0;
  transform: translateX(-14px);
  animation: fieldSlideIn 0.35s cubic-bezier(0.23,1,0.32,1) both;
}
@keyframes fieldSlideIn {
  to { opacity:1; transform:translateX(0); }
}

/* ─── Stats count-up wrapper ─── */
.ps-val {
  transition: color 0.3s ease;
}
.ps-item {
  opacity: 0;
  transform: translateY(14px);
  animation: statPop 0.45s cubic-bezier(0.23,1,0.32,1) both;
}
@keyframes statPop {
  to { opacity:1; transform:translateY(0); }
}
/* ══ AREA PRINT KARTU ══ */
#printCardArea {
  display: none;
  width: 86mm;
  min-height: 54mm;
  background: linear-gradient(135deg, #1c2d55, #0f1b35);
  border-radius: 12px;
  overflow: hidden;
  color: #fff;
  font-family: 'Plus Jakarta Sans', sans-serif;
  position: relative;
}
#printCardArea .pca-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px 5px;
  border-bottom: 1px solid rgba(255,255,255,.15);
}
#printCardArea .pca-body {
  display: flex;
  gap: 9px;
  align-items: center;
  padding: 7px 10px;
}
#printCardArea .pca-footer {
  padding: 4px 10px 6px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-top: 1px solid rgba(255,255,255,.12);
}
#printCardArea .pca-barcode-wrap {
  display: flex;
  gap: 1px;
  align-items: flex-end;
}
/* ─── Kartu cetak: slide dari bawah ─── */
.cetak-btn-real {
  position: relative;
  overflow: hidden;
}
.cetak-btn-real::after {
  content: '';
  position: absolute;
  top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent);
  animation: btnShimmer 2s 0.5s ease-in-out infinite;
}
@keyframes btnShimmer {
  0%   { left: -100%; }
  50%,100% { left: 100%; }
}

/* ─── Print card slide in ─── */
@keyframes printCardSlideIn {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}
    [data-theme="dark"] .modal,[data-theme="dark"] .notif-panel,[data-theme="dark"] .user-dropdown{background:var(--card-bg);border-color:var(--border);}

  </style>
</head>
<body>

<!-- ══ PAGE 1: LOGIN ══ -->
<div id="page-login" class="page">

  <div class="orb" style="width:300px;height:300px;background:radial-gradient(circle,rgba(59,124,244,.12),transparent);top:-80px;right:-60px;animation-duration:8s;"></div>
  <div class="orb" style="width:200px;height:200px;background:radial-gradient(circle,rgba(26,107,107,.1),transparent);bottom:60px;left:-40px;animation-duration:11s;animation-delay:2s;"></div>
  <div class="orb" style="width:150px;height:150px;background:radial-gradient(circle,rgba(59,124,244,.08),transparent);bottom:200px;right:200px;animation-duration:7s;animation-delay:1s;"></div>

  <div class="login-container">
    <div class="login-brand">
      <div class="login-logo-wrap">
        <div class="login-logo-icon"><i class="fas fa-book-open"></i></div>
        <div class="login-logo-text">Perpustakaan<small>SMKN 1 Ketapang</small></div>
      </div>
      <div class="login-headline">
        <span class="hi">Selamat datang di</span>
        Sistem <span class="accent">Perpustakaan</span> Digital
      </div>
      <p class="login-desc">Akses ribuan koleksi buku, kelola peminjaman, dan pantau riwayat secara mudah dari mana saja.</p>
      <div class="login-features">
        <div class="lf-item" style="animation-delay:.3s;"><div class="lf-icon"><i class="fas fa-book"></i></div><div class="lf-text">20+ Koleksi buku pelajaran, fiksi &amp; referensi</div></div>
        <div class="lf-item" style="animation-delay:.4s;"><div class="lf-icon"><i class="fas fa-clock"></i></div><div class="lf-text">Pantau tenggat pengembalian secara real-time</div></div>
        <div class="lf-item" style="animation-delay:.5s;"><div class="lf-icon"><i class="fas fa-shield-alt"></i></div><div class="lf-text">Data peminjaman aman &amp; terenkripsi</div></div>
      </div>
    </div>

    <div class="login-card">
      <div class="lc-header">
        <div class="lc-icon" style="background:none;box-shadow:none;width:72px;height:72px;">
          <img src="logo smkn bulat.jpg" style="width:72px;height:72px;object-fit:contain;border-radius:50%;">
        </div>
        <div class="lc-title">Masuk ke Akun</div>
        <div class="lc-sub">Gunakan NIS/NIP dan kata sandi Anda</div>
      </div>

      <div class="user-type-tabs" id="userTypeTabs">
        <button class="utt on" data-role="siswa" onclick="setRole('siswa',this)"><i class="fas fa-user-graduate"></i> Siswa</button>
        <button class="utt" data-role="guru" onclick="setRole('guru',this)"><i class="fas fa-chalkboard-teacher"></i> Guru</button>
        <button class="utt" data-role="admin" onclick="setRole('admin',this)"><i class="fas fa-user-shield"></i> Admin</button>
      </div>

      <div class="alert-error" id="loginAlert">
        <i class="fas fa-exclamation-circle"></i>
        <span id="loginAlertMsg">NIS/NIP atau kata sandi salah.</span>
      </div>

      <div class="lf-group">
        <label id="nisLabel">NIS (Nomor Induk Siswa)</label>
        <div class="lf-input-wrap">
          <i class="fas fa-id-card prefix"></i>
          <input type="text" id="loginNis" class="lf-input" placeholder="Masukkan NIS Anda" autocomplete="username">
        </div>
        <div class="lf-error" id="nisErr">NIS/NIP wajib diisi.</div>
      </div>

      <div class="lf-group">
        <label>Kata Sandi</label>
        <div class="lf-input-wrap">
          <i class="fas fa-lock prefix"></i>
          <input type="password" id="loginPass" class="lf-input" placeholder="••••••••" autocomplete="current-password">
          <button class="eye-btn" type="button" onclick="toggleEye()" id="eyeBtn"><i class="fas fa-eye"></i></button>
        </div>
        <div class="lf-error" id="passErr">Kata sandi wajib diisi.</div>
      </div>

      <div class="lf-row">
        <label class="lf-check"><input type="checkbox" id="rememberMe"> Ingat saya</label>
        <a class="lf-forgot" onclick="showToast('Hubungi admin perpustakaan untuk reset password.','info')">Lupa kata sandi?</a>
      </div>

      <button class="login-btn" id="loginBtn" onclick="doLogin()">
        <span class="btn-text"><i class="fas fa-sign-in-alt"></i> Masuk Sekarang</span>
        <div class="spinner"></div>
      </button>

      <div class="demo-section">
        <div class="demo-label">✦ Akun Demo — Klik untuk Isi Otomatis</div>
        <div class="demo-accounts">
          <div class="demo-acc" onclick="fillDemo('siswa')">
            <div class="da-left"><div class="da-icon" style="background:var(--blue);"><i class="fas fa-user-graduate"></i></div><div><div class="da-name">Aditya Nirwantoro — Siswa</div><div class="da-role">NIS: 12282008 · Pass: aditya1228</div></div></div>
            <span class="da-use">Gunakan →</span>
          </div>
          <div class="demo-acc" onclick="fillDemo('guru')">
            <div class="da-left"><div class="da-icon" style="background:var(--green);"><i class="fas fa-chalkboard-teacher"></i></div><div><div class="da-name">Korawati, S.Pd — Guru</div><div class="da-role">NIP: 197805012005012001 · Pass: guru123</div></div></div>
            <span class="da-use">Gunakan →</span>
          </div>
          <div class="demo-acc" onclick="fillDemo('admin')">
            <div class="da-left"><div class="da-icon" style="background:var(--gold);"><i class="fas fa-user-shield"></i></div><div><div class="da-name">Admin Perpustakaan</div><div class="da-role">ID: admin · Pass: admin123</div></div></div>
            <span class="da-use">Gunakan →</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ══ PAGE 2: PEMINJAMAN ══ -->
<div id="page-peminjaman" class="page">

  <div id="reminderBanner" style="display:none;"></div>
  <nav class="navbar">
    <button class="nav-logo-btn" onclick="goHome()" title="Kembali ke Halaman Utama">
      <div class="nav-logo-icon" style="background:none;box-shadow:none;padding:0;overflow:hidden;">
        <img src="logo smkn bulat.jpg" style="width:38px;height:38px;object-fit:contain;border-radius:50%;">
      </div>
      <div>
        <div class="nav-logo-name">Perpustakaan</div>
        <small class="nav-logo-name" style="font-size:10px;opacity:.5;font-weight:400;color:#fff;">SMKN 1 Ketapang</small>
      </div>
    </button>

    <div class="nav-links">
      <button class="nav-link" onclick="navGo('beranda')"><i class="fas fa-home"></i> Beranda</button>
      <button class="nav-link" onclick="navGo('tentang')"><i class="fas fa-info-circle"></i> Tentang Kami</button>
      <button class="nav-link" onclick="navGo('koleksi')"><i class="fas fa-book"></i> Koleksi</button>
      <button class="nav-link" onclick="navGo('layanan')"><i class="fas fa-concierge-bell"></i> Layanan</button>
      <button class="nav-link" onclick="navGo('kontak')"><i class="fas fa-envelope"></i> Kontak</button>
      <button class="nav-link active"><i class="fas fa-hand-holding-heart"></i> Peminjaman</button>
    </div>

    <div class="nav-right">
      <button class="nav-icon-btn" id="themeBtn" onclick="toggleTheme()" title="Mode Gelap"><i class="fas fa-moon" id="themeIcon"></i></button>
      <div class="notif-panel-wrapper">
        <button class="nav-icon-btn" id="bellBtn" onclick="toggleNotifPanel()" title="Notifikasi Peminjaman">
          <i class="fas fa-bell"></i>
          <span class="bell-count" id="bellCount" style="display:none;">0</span>
        </button>
        <div class="notif-panel" id="notifPanel">
          <div class="np-header">
            <div class="np-title">
              <i class="fas fa-bell"></i>
              Permintaan Peminjaman
              <span class="np-badge" id="npBadge">0</span>
            </div>
            <button class="np-close" onclick="toggleNotifPanel()"><i class="fas fa-times"></i></button>
          </div>
          <div class="np-body" id="npBody">
            <div class="np-empty"><i class="fas fa-inbox"></i>Belum ada permintaan masuk.</div>
          </div>
        </div>
      </div>

    <button class="nav-icon-btn" onclick="showToast('Fitur pencarian global segera hadir!','info')" title="Cari">
        <i class="fas fa-search"></i>
      </button>

      <!-- Tombol Masuk: tampil saat belum login -->
      <button id="navLoginBtn" onclick="openLoginModal()" style="padding:8px 18px;border-radius:50px;background:var(--blue);color:#fff;border:none;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;transition:.2s;box-shadow:0 4px 14px rgba(59,124,244,.35);" onmouseover="this.style.background='#5b9cf6'" onmouseout="this.style.background='var(--blue)'">
        <i class="fas fa-sign-in-alt"></i> Masuk
      </button>

      <!-- User pill: tampil setelah login -->
      <div class="user-pill" id="navUserPill" style="display:none;" tabindex="0">
        <div class="user-avatar" id="navAvatar" style="background:var(--blue);">A</div>
        <div>
          <div class="user-name" id="navName">Pengguna</div>
          <div class="user-role" id="navRole">Siswa</div>
        </div>
        <i class="fas fa-chevron-down" style="font-size:10px;color:rgba(255,255,255,.5);margin-left:4px;"></i>
        <div class="user-dropdown">
          <div class="ud-header">
            <div class="ud-name"  id="ddName">Aditya</div>
            <div class="ud-email" id="ddEmail">NIS: 12282008</div>
          </div>
          <button class="ud-item" onclick="switchMainTab('pinjam')"><i class="fas fa-book-reader"></i> Pinjam Buku</button>
          <button class="ud-item" onclick="switchMainTab('riwayat')"><i class="fas fa-history"></i> Riwayat Peminjaman</button>
          <button class="ud-item" onclick="switchMainTab('profil')"><i class="fas fa-id-card"></i> Profil &amp; Kartu</button>
          <button class="ud-item" onclick="switchMainTab('denda')"><i class="fas fa-receipt"></i> Tagihan Denda</button>
          <button class="ud-item" onclick="showToast('Fitur profil segera hadir!','info')"><i class="fas fa-user-cog"></i> Pengaturan Profil</button>
          <div class="ud-sep"></div>
          <button class="ud-item danger" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> Keluar</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="page-hero">
    <div class="hero-inner">
      <div class="breadcrumb">
        <span onclick="goHome()"><i class="fas fa-home"></i> Beranda</span>
        <i class="fas fa-chevron-right"></i>
        <span>Peminjaman Buku</span>
      </div>
      <div class="hero-title">Peminjaman Buku</div>
      <div class="hero-sub">Pinjam, lacak, dan kembalikan buku perpustakaan dengan mudah.</div>
      <div class="hero-stats">
        <div class="hstat"><div class="hstat-val"><span id="sTotal">20</span><span>+</span></div><div class="hstat-lbl">Total Buku</div></div>
        <div class="hstat"><div class="hstat-val"><span id="sAvail">17</span><span>+</span></div><div class="hstat-lbl">Tersedia</div></div>
        <div class="hstat"><div class="hstat-val"><span id="sCat">4</span></div><div class="hstat-lbl">Kategori</div></div>
      </div>
    </div>
  </div>

  <div class="tabs-bar">
    <button class="tab-btn on" id="tabBtnKoleksi" onclick="switchMainTab('koleksi')"><i class="fas fa-book"></i> Koleksi Buku <span class="tab-count" id="tcKoleksi">20</span></button>
   <button class="tab-btn" id="tabBtnPinjam"   onclick="requireLogin('pinjam')"><i class="fas fa-hand-holding-heart"></i> Form Peminjaman</button>
<button class="tab-btn" id="tabBtnRiwayat"  onclick="requireLogin('riwayat')"><i class="fas fa-history"></i> Riwayat <span class="tab-count" id="tcRiwayat">0</span></button>
<button class="tab-btn" id="tabBtnDenda"    onclick="requireLogin('denda')"><i class="fas fa-receipt"></i> Denda <span class="tab-count" id="tcDenda">0</span></button>
<button class="tab-btn" id="tabBtnProfil"   onclick="requireLogin('profil')"><i class="fas fa-id-card"></i> Profil</button>
    <button class="tab-btn admin-tab" id="tabBtnDashboard" onclick="switchMainTab('dashboard')" style="display:none;"><i class="fas fa-chart-bar"></i> Dashboard</button>
    <button class="tab-btn admin-tab" id="tabBtnManajemen" onclick="switchMainTab('manajemen')" style="display:none;"><i class="fas fa-cog"></i> Manajemen Buku</button>
  </div>

  <div class="main">

    <!-- Tab Koleksi -->
    <div class="tab-section on" id="tsKoleksi">
      <div class="toolbar">
        <div class="search-field">
          <i class="fas fa-search"></i>
          <input type="text" id="bookSearch" placeholder="Cari judul buku atau pengarang...">
          <i class="fas fa-times" id="clearBook" style="cursor:pointer;color:var(--border2);display:none;font-size:12px;" onclick="clearBookSearch()"></i>
        </div>
        <div class="pill-group" id="catPills">
          <div class="pill on" data-c="all">Semua</div>
          <div class="pill" data-c="Pelajaran"><i class="fas fa-graduation-cap" style="font-size:10px;"></i> Pelajaran</div>
          <div class="pill" data-c="Fiksi"><i class="fas fa-feather" style="font-size:10px;"></i> Fiksi</div>
          <div class="pill" data-c="Non-Fiksi"><i class="fas fa-globe" style="font-size:10px;"></i> Non-Fiksi</div>
          <div class="pill" data-c="Referensi"><i class="fas fa-book-open" style="font-size:10px;"></i> Referensi</div>
        </div>
        <div style="display:flex;gap:6px;">
          <button class="icon-btn on" id="gBtn" title="Grid"><i class="fas fa-grip"></i></button>
          <button class="icon-btn"    id="lBtn" title="List"><i class="fas fa-list"></i></button>
        </div>
      </div>
      <div class="result-meta">
        <div class="result-text" id="bookCount"><strong>20</strong> buku ditampilkan</div>
        <select class="sort-box" id="bookSort">
          <option value="default">Urutkan: Default</option>
          <option value="title">Judul A–Z</option>
          <option value="year_new">Tahun Terbaru</option>
          <option value="stock">Stok Terbanyak</option>
        </select>
      </div>
      <div class="books-grid" id="booksGrid">
        <div class="empty-state" id="bookEmpty">
          <div class="empty-ico"><i class="fas fa-search"></i></div>
          <div class="empty-title">Buku tidak ditemukan</div>
          <div class="empty-sub">Coba kata kunci lain atau ubah filter.</div>
        </div>
      </div>
    </div>

    <!-- Tab Form Peminjaman -->
    <div class="tab-section" id="tsPinjam">
      <div class="pinjam-layout">
        <div>
          <div class="card-box" style="margin-bottom:18px;">
            <div class="card-box-title"><i class="fas fa-user-circle"></i> Data Peminjam</div>
            <div class="form-grid">
              <div class="fg"><label>Nama Lengkap *</label><input type="text" id="fNama" placeholder="Nama lengkap"></div>
              <div class="fg"><label>NIS / NIP *</label><input type="text" id="fNis" placeholder="Nomor induk"></div>
              <div class="fg"><label>Kelas / Jabatan</label><input type="text" id="fKelas" placeholder="XI RPL 1 / Guru"></div>
              <div class="fg"><label>No. HP / WhatsApp</label><input type="text" id="fHp" placeholder="08xxxxxxxxxx"></div>
            </div>
          </div>
          <div class="card-box">
            <div class="card-box-title"><i class="fas fa-book"></i> Pilih Buku</div>
            <div class="fg" style="margin-bottom:13px;">
              <label>Cari &amp; Pilih Buku *</label>
              <div class="search-field"><i class="fas fa-search"></i><input type="text" id="fBookSearch" placeholder="Ketik judul atau pengarang..."></div>
              <div class="book-search-result" id="bookSearchResult"></div>
              <div class="selected-book" id="selectedBookChip">
                <div id="sbThumb"></div>
                <div style="flex:1;"><div style="font-size:13px;font-weight:700;" id="sbTitle"></div><div style="font-size:11px;color:var(--text3);margin-top:2px;" id="sbDetail"></div></div>
                <button class="sb-remove" onclick="clearSelectedBook()"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <div class="form-grid">
              <div class="fg"><label>Tanggal Pinjam *</label><input type="date" id="fTglPinjam"></div>
              <div class="fg"><label>Tanggal Kembali *</label><input type="date" id="fTglKembali"></div>
            </div>
            <div class="fg" style="margin-top:13px;"><label>Catatan (opsional)</label><textarea id="fCatatan" placeholder="Catatan untuk petugas..."></textarea></div>
            <button class="submit-btn" onclick="submitPinjam()"><i class="fas fa-paper-plane"></i> Ajukan Peminjaman</button>
          </div>
        </div>
        <div>
          <div class="card-box" style="position:sticky;top:20px;">
            <div class="card-box-title"><i class="fas fa-clipboard-list"></i> Ringkasan</div>
            <div class="summary-row"><span class="sr-label">Peminjam</span><span class="sr-val accent" id="sumNama">—</span></div>
            <div class="summary-row"><span class="sr-label">NIS/NIP</span><span class="sr-val" id="sumNis">—</span></div>
            <div class="summary-row"><span class="sr-label">Buku Dipilih</span><span class="sr-val accent" id="sumBuku">—</span></div>
            <div class="summary-row"><span class="sr-label">Tgl. Pinjam</span><span class="sr-val" id="sumPinjam">—</span></div>
            <div class="summary-row"><span class="sr-label">Tgl. Kembali</span><span class="sr-val" id="sumKembali">—</span></div>
            <div class="summary-row"><span class="sr-label">Durasi</span><span class="sr-val green" id="sumDur">—</span></div>
            <div class="summary-row"><span class="sr-label">Denda/hari</span><span class="sr-val red">Rp 500,-</span></div>
            <div class="info-box"><i class="fas fa-info-circle"></i><div>Maks. <strong>7 hari kerja</strong>. Perpanjangan 1x. Buku rusak/hilang wajib diganti.</div></div>
          </div>
          <div class="card-box" style="margin-top:16px;">
            <div class="card-box-title"><i class="fas fa-shield-alt"></i> Aturan Peminjaman</div>
            <ul style="font-size:12px;color:var(--text2);line-height:2.1;padding-left:15px;">
              <li>Wajib membawa kartu anggota aktif</li>
              <li>Maks. 2 buku dipinjam sekaligus</li>
              <li>Dikembalikan dalam kondisi baik</li>
              <li>Terlambat: denda Rp 500/hari</li>
              <li>Buku hilang: ganti judul yang sama</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Riwayat -->
    <div class="tab-section" id="tsRiwayat">
      <div class="card-box">
        <div class="card-box-title" style="justify-content:space-between;flex-wrap:wrap;gap:8px;">
          <span><i class="fas fa-history" style="color:var(--blue);"></i> Riwayat Peminjaman</span>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <span id="adminRiwayatBadge" style="display:none;font-size:11px;font-weight:600;color:var(--text3);background:var(--bg2);padding:4px 10px;border-radius:20px;">
              <i class="fas fa-user-shield" style="font-size:10px;color:var(--gold);"></i> Mode Admin — klik 🗑 untuk hapus
            </span>
            <div class="export-btn-group">
              <button class="export-btn excel" onclick="exportExcel()" title="Export ke Excel"><i class="fas fa-file-excel"></i> Excel</button>
              <button class="export-btn pdf"   onclick="exportPDF()"   title="Export ke PDF"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>
          </div>
        </div>
        <div id="riwayatEmpty" style="display:none;padding:40px 0;text-align:center;">
          <div style="width:52px;height:52px;background:var(--bg2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:1.4rem;color:var(--text3);"><i class="fas fa-history"></i></div>
          <div style="font-size:.95rem;font-weight:700;color:var(--text2);margin-bottom:4px;">Belum ada riwayat</div>
          <div style="font-size:13px;color:var(--text3);">Riwayat akan muncul setelah peminjaman disetujui admin.</div>
        </div>
        <div style="overflow-x:auto;" id="riwayatTableWrap">
          <table class="riwayat-table">
            <thead><tr><th>Buku</th><th>Peminjam</th><th>Tgl. Pinjam</th><th>Tgl. Kembali</th><th>Dikembalikan</th><th>Status</th><th>Denda</th><th>Aksi</th></tr></thead>
            <tbody id="riwayatBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab Denda -->
    <div class="tab-section" id="tsDenda">
      <div class="denda-cards" id="dendaCards"></div>
      <div class="no-fine" id="noFine" style="display:none;">
        <i class="fas fa-check-circle" style="font-size:1.4rem;"></i>
        <div><strong>Tidak ada denda!</strong> Semua buku dikembalikan tepat waktu.</div>
      </div>
    </div>

  </div>
    <!-- TAB: PROFIL & KARTU ANGGOTA -->
    <div class="tab-section" id="tsProfil">
      <div class="profil-layout">
        <div>
         <div class="member-card-wrapper">
          <div class="member-card">
            <div class="mc-header">
              <div class="mc-logo">
              <img src="logo smkn bulat.jpg" style="width:100%;height:100%;object-fit:contain;border-radius:6px;">
              </div>
              <div class="mc-school">Perpustakaan<br>SMKN 1 Ketapang</div>
            </div>
            <div class="avatar-upload-wrap">
           <div class="mc-avatar-big" id="mcAvatar" style="background:var(--blue);" onclick="document.getElementById('avatarFileInput').click()" title="Klik untuk ganti foto profil">AN</div>
          <div class="avatar-upload-overlay" onclick="document.getElementById('avatarFileInput').click()" title="Ganti foto">
        <i class="fas fa-camera"></i>
  </div>
</div>
            <input type="file" id="avatarFileInput" accept="image/*" onchange="handleAvatarUpload(event)">
            <div class="mc-name" id="mcName">Nama Anggota</div>
            <div class="mc-role-text" id="mcRoleText">Siswa</div>
            <div class="mc-info">
              <div class="mc-field"><div class="mc-field-label">NIS / NIP</div><div class="mc-field-val" id="mcNis">—</div></div>
              <div class="mc-field"><div class="mc-field-label">Role</div><div class="mc-field-val" id="mcRoleVal">—</div></div>
              <div class="mc-field"><div class="mc-field-label">Status</div><div class="mc-field-val" style="color:#4ade80;">Aktif</div></div>
              <div class="mc-field"><div class="mc-field-label">Terdaftar</div><div class="mc-field-val">2024</div></div>
            </div>
            <div class="mc-barcode">
              <div class="mc-barcode-bars" id="mcBarcode"></div>
              <div class="mc-barcode-num" id="mcBarcodeNum">000000000000</div>
            </div>
            <div style="text-align:center;"><span class="mc-status-badge"><i class="fas fa-check-circle" style="font-size:9px;"></i> Anggota Aktif</span></div>
          </div>
          </div>
          <div style="margin-top:10px;">
            <button onclick="cetakKartuAnggota()" class="cetak-btn-real"><i class="fas fa-print"></i> Cetak Kartu Anggota</button>
          </div>
        </div>
        <div>
          <div class="profil-stats">
            <div class="ps-item"><div class="ps-val" id="psTotal">0</div><div class="ps-label">Total Pinjam</div></div>
            <div class="ps-item"><div class="ps-val" id="psActive" style="color:var(--green);">0</div><div class="ps-label">Sedang Dipinjam</div></div>
            <div class="ps-item"><div class="ps-val" id="psDenda" style="color:var(--red);">0</div><div class="ps-label">Denda Aktif</div></div>
          </div>
          <div class="card-box" style="margin-bottom:14px;">
            <div class="card-box-title"><i class="fas fa-user-edit"></i> Edit Informasi Akun</div>
            <div class="fg profil-form-field" style="animation-delay:0ms;">
  <label>Nama Lengkap</label>
  <input type="text" id="profNama" placeholder="Nama lengkap">
</div>

<div class="fg profil-form-field" style="animation-delay:80ms;">
  <label>NIS / NIP</label>
  <input type="text" id="profNis" placeholder="—" readonly style="cursor:not-allowed;opacity:.7;">
</div>

<div class="fg profil-form-field" style="animation-delay:160ms;">
  <label>Kelas / Jabatan</label>
  <input type="text" id="profKelas" placeholder="XI RPL 1">
</div>

<div class="fg profil-form-field" style="animation-delay:240ms;">
  <label>No. HP</label>
  <input type="text" id="profHp" placeholder="08xxxxxxxxxx">
</div>

<div class="fg profil-form-field" style="animation-delay:320ms;grid-column:1/-1;">
  <label>Email</label>
  <input type="text" id="profEmail" placeholder="email@smkn1ketapang.sch.id">
</div>
            <button onclick="saveProfil()" style="margin-top:12px;padding:11px 20px;border-radius:var(--r-sm);background:var(--navy);color:#fff;border:none;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;transition:.2s;" onmouseover="this.style.background='var(--blue)'" onmouseout="this.style.background='var(--navy)'"><i class="fas fa-save"></i> Simpan Perubahan</button>
          </div>
          <div class="card-box">
            <div class="card-box-title"><i class="fas fa-lock"></i> Ubah Kata Sandi</div>
            <div class="form-grid">
              <div class="fg" style="grid-column:1/-1;"><label>Kata Sandi Lama</label><input type="password" id="passLama" placeholder="••••••••"></div>
              <div class="fg"><label>Kata Sandi Baru</label><input type="password" id="passBaru" placeholder="••••••••"></div>
              <div class="fg"><label>Konfirmasi Baru</label><input type="password" id="passKonfirm" placeholder="••••••••"></div>
            </div>
            <button onclick="changePassword()" style="margin-top:12px;padding:11px 20px;border-radius:var(--r-sm);background:var(--navy);color:#fff;border:none;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;transition:.2s;" onmouseover="this.style.background='var(--blue)'" onmouseout="this.style.background='var(--navy)'"><i class="fas fa-key"></i> Ubah Sandi</button>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: DASHBOARD ADMIN -->
    <div class="tab-section" id="tsDashboard">
      <div class="dash-grid" id="dashStatGrid"></div>
      <!-- Grafik peminjaman per bulan (full width) -->
      <div class="dash-row-full">
        <div class="card-box">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
            <div class="card-box-title" style="margin:0;"><i class="fas fa-chart-line" style="color:var(--blue);"></i> Statistik Peminjaman</div>
            <div class="chart-tab-group" id="chartTabGroup">
              <button class="chart-tab on" onclick="switchChartView('monthly',this)">Per Bulan</button>
              <button class="chart-tab" onclick="switchChartView('book',this)">Per Buku</button>
            </div>
          </div>
          <div id="monthlyChartWrap" class="monthly-chart-wrap">
            <div class="monthly-chart" id="monthlyChartBars"></div>
            <div class="mc-legend">
              <div class="mc-legend-item"><div class="mc-legend-dot" style="background:var(--blue);"></div> Peminjaman</div>
              <div class="mc-legend-item"><div class="mc-legend-dot" style="background:var(--red);"></div> Terlambat</div>
            </div>
          </div>
          <div id="bookChartWrap" style="display:none;">
            <div id="chartBars" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
      <div class="dash-row">
        <div class="card-box">
          <div class="card-box-title"><i class="fas fa-clock"></i> Aktivitas Peminjaman Terbaru</div>
          <div id="recentList"></div>
        </div>
        <div class="card-box">
          <div class="card-box-title" style="color:var(--orange);"><i class="fas fa-exclamation-triangle"></i> Stok Buku Rendah</div>
          <div id="lowStockList"></div>
        </div>
      </div>
      <div class="dash-row">
        <div class="card-box">
          <div class="card-box-title"><i class="fas fa-users"></i> Anggota Aktif Meminjam</div>
          <div id="activeLoans"></div>
        </div>
        <div class="card-box">
          <div class="card-box-title" style="color:var(--red);"><i class="fas fa-exclamation-circle"></i> Peminjaman Terlambat</div>
          <div id="lateLoans"></div>
        </div>
      </div>
    </div>

    <!-- TAB: MANAJEMEN BUKU -->
    <div class="tab-section" id="tsManajemen">
      <div class="card-box">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
          <div class="card-box-title" style="margin-bottom:0;"><i class="fas fa-cog"></i> Manajemen Koleksi Buku</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <div class="search-field" style="min-width:180px;flex:unset;"><i class="fas fa-search"></i><input type="text" id="mgmtSearch" placeholder="Cari buku..." oninput="renderManajemen()"></div>
            <button class="add-btn" onclick="openAddBook()"><i class="fas fa-plus"></i> Tambah Buku</button>
          </div>
        </div>
        <div style="overflow-x:auto;">
          <table class="mgmt-table">
            <thead><tr><th>#</th><th>Judul</th><th>Pengarang</th><th>Kategori</th><th>Thn</th><th>Stok</th><th>Total</th><th>Aksi</th></tr></thead>
            <tbody id="mgmtBody"></tbody>
          </table>
        </div>
      </div>
    </div>




<!-- AREA CETAK KARTU (hanya tampil saat print) -->
<div id="printCardArea">
  <div class="pca-header">
    <div class="pca-logo">
      <img src="logo smkn bulat.jpg" style="width:100%;height:100%;object-fit:contain;border-radius:4px;">
    </div>
    <div class="pca-school">Perpustakaan<span>SMKN 1 Ketapang</span></div>
    <div class="pca-type">KARTU ANGGOTA</div>
  </div>
  <div class="pca-body">
    <div class="pca-avatar" id="pcaAvatar">AN</div>
    <div class="pca-info">
      <div class="pca-name" id="pcaName">—</div>
      <div class="pca-nis" id="pcaNis">—</div>
      <div class="pca-meta">
        <div class="pca-meta-item"><label>Role</label><span id="pcaRole">—</span></div>
        <div class="pca-meta-item"><label>Tahun</label><span>2024</span></div>
        <div class="pca-meta-item"><label>Status</label><span style="color:#4ade80;">Aktif</span></div>
        <div class="pca-meta-item"><label>Berlaku s/d</label><span>Des 2025</span></div>
      </div>
    </div>
  </div>
  <div class="pca-footer">
    <div>
      <div class="pca-barcode-wrap" id="pcaBarcode"></div>
      <div class="pca-num" id="pcaBarcodeNum">000000000000</div>
    </div>
    <div class="pca-status-badge">✓ Anggota Aktif</div>
  </div>
</div>
<!-- ══ MODAL LOGIN POPUP ══ -->
<div class="modal-backdrop" id="loginModalBg" onclick="if(event.target===this)closeLoginModal()">
  <div class="modal" style="max-width:430px;">
    <div style="background:linear-gradient(135deg,var(--navy3),var(--navy));padding:20px 24px 16px;position:relative;">
      <button onclick="closeLoginModal()" style="position:absolute;top:12px;right:12px;width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,.15);border:none;color:#fff;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;"><i class="fas fa-times"></i></button>
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="width:42px;height:42px;border-radius:11px;overflow:hidden;flex-shrink:0;background:rgba(255,255,255,.1);">
          <img src="logo smkn bulat.jpg" style="width:100%;height:100%;object-fit:contain;">
        </div>
        <div>
          <div style="font-size:.95rem;font-weight:800;color:#fff;">Masuk ke Akun</div>
          <div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:1px;">Perpustakaan SMKN 1 Ketapang</div>
        </div>
      </div>
    </div>
    <div style="padding:20px 24px 24px;">
      <div id="loginModalAlert" style="display:none;background:var(--red-bg);border:1px solid rgba(220,38,38,.2);border-radius:8px;padding:10px 13px;margin-bottom:14px;font-size:12.5px;color:var(--red);align-items:center;gap:7px;">
        <i class="fas fa-exclamation-circle"></i><span id="loginModalAlertMsg"></span>
      </div>
      <div id="mRoleTabs" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:4px;margin-bottom:18px;">
        <button class="utt on" id="mUttSiswa" onclick="setModalRole('siswa',this)"><i class="fas fa-user-graduate" style="font-size:10px;"></i> Siswa</button>
        <button class="utt" id="mUttGuru"  onclick="setModalRole('guru',this)"><i class="fas fa-chalkboard-teacher" style="font-size:10px;"></i> Guru</button>
        <button class="utt" id="mUttAdmin" onclick="setModalRole('admin',this)"><i class="fas fa-user-shield" style="font-size:10px;"></i> Admin</button>
      </div>
      <div style="margin-bottom:13px;">
        <label id="mNisLabel" style="display:block;font-size:11.5px;font-weight:700;color:var(--text2);margin-bottom:6px;">NIS (Nomor Induk Siswa)</label>
        <div style="position:relative;">
          <i class="fas fa-id-card" style="position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:13px;pointer-events:none;"></i>
          <input type="text" id="mLoginNis" class="lf-input" placeholder="Masukkan NIS Anda" style="padding-left:40px;" onkeydown="if(event.key==='Enter')doModalLogin()">
        </div>
      </div>
      <div style="margin-bottom:18px;">
        <label style="display:block;font-size:11.5px;font-weight:700;color:var(--text2);margin-bottom:6px;">Kata Sandi</label>
        <div style="position:relative;">
          <i class="fas fa-lock" style="position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:13px;pointer-events:none;"></i>
          <input type="password" id="mLoginPass" class="lf-input" placeholder="••••••••" style="padding-left:40px;" onkeydown="if(event.key==='Enter')doModalLogin()">
          <button onclick="toggleModalEye()" type="button" style="position:absolute;right:11px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text3);font-size:13px;padding:4px;"><i class="fas fa-eye" id="mEyeIcon"></i></button>
        </div>
      </div>
      <button onclick="doModalLogin()" style="width:100%;padding:13px;border-radius:10px;background:linear-gradient(135deg,var(--navy3),var(--navy));color:#fff;border:none;cursor:pointer;font-family:inherit;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:7px;transition:.25s;margin-bottom:16px;">
        <span id="mBtnText"><i class="fas fa-sign-in-alt"></i> Masuk Sekarang</span>
        <div id="mSpinner" style="display:none;width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;"></div>
      </button>
      <div style="border-top:1px solid var(--border);padding-top:14px;">
        <div style="font-size:10.5px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);text-align:center;margin-bottom:10px;">✦ Demo — Klik untuk isi otomatis</div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <div class="demo-acc" onclick="fillModalDemo('siswa')"><div class="da-left"><div class="da-icon" style="background:var(--blue);"><i class="fas fa-user-graduate"></i></div><div><div class="da-name">Aditya — Siswa</div><div class="da-role">NIS: 12282008</div></div></div><span class="da-use">Gunakan →</span></div>
          <div class="demo-acc" onclick="fillModalDemo('guru')"><div class="da-left"><div class="da-icon" style="background:var(--green);"><i class="fas fa-chalkboard-teacher"></i></div><div><div class="da-name">Korawati — Guru</div><div class="da-role">NIP: 197805012005012001</div></div></div><span class="da-use">Gunakan →</span></div>
          <div class="demo-acc" onclick="fillModalDemo('admin')"><div class="da-left"><div class="da-icon" style="background:var(--gold);"><i class="fas fa-user-shield"></i></div><div><div class="da-name">Admin Perpustakaan</div><div class="da-role">ID: admin</div></div></div><span class="da-use">Gunakan →</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DETAIL BUKU -->
<div class="modal-backdrop" id="modalBg">
  <div class="modal" style="position:relative;">
    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
    <div class="modal-cover" id="mCover">
      <div class="modal-cover-lines"></div>
      <div class="modal-cover-badge" id="mCovBadge"></div>
      <div class="modal-cover-ico"><i id="mCovIco"></i></div>
    </div>
    <div class="modal-body">
      <div class="modal-genre"  id="mGenre"></div>
      <div class="modal-title"  id="mTitle"></div>
      <div class="modal-author" id="mAuthor"></div>
      <div class="modal-hr"></div>
      <div class="modal-desc"   id="mDesc"></div>
      <div class="modal-meta-grid" id="mMeta"></div>
      <div class="modal-actions">
        <button class="m-btn prim" id="mPinjamBtn"><i class="fas fa-bookmark"></i> Pilih untuk Dipinjam</button>
        <button class="m-btn sec" onclick="closeModal()">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- ══ MODAL PERPANJANG (BARU) ══ -->
<div class="modal-backdrop" id="perpanjangModalBg" onclick="if(event.target===this)closePerpanjangModal()">
  <div class="modal fmodal" style="max-width:420px;">
    <div class="fmodal-header">
      <div class="fmodal-title"><i class="fas fa-calendar-plus" style="color:var(--blue);"></i> Perpanjang Peminjaman</div>
      <button class="fmodal-close" onclick="closePerpanjangModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="perpanjang-modal-body">
      <div class="pm-book-info">
        <div class="pm-thumb" id="pmThumb"></div>
        <div>
          <div class="pm-title" id="pmTitle">Judul Buku</div>
          <div class="pm-author" id="pmAuthor">Pengarang</div>
        </div>
      </div>
      <div class="perpanjang-dates">
        <div class="pd-item">
          <div class="pd-label">Tenggat Lama</div>
          <div class="pd-val" id="pmOldDate">—</div>
        </div>
        <div class="pd-arrow"><i class="fas fa-arrow-right"></i></div>
        <div class="pd-item">
          <div class="pd-label">Tenggat Baru</div>
          <div class="pd-val new" id="pmNewDate">—</div>
        </div>
      </div>
      <div class="perpanjang-info">
        <i class="fas fa-info-circle"></i>
        <div>Perpanjangan hanya bisa dilakukan <strong>1 kali</strong>. Tenggat baru adalah <strong>+7 hari</strong> dari tenggat sebelumnya. Pastikan buku dalam kondisi baik.</div>
      </div>
    </div>
    <div class="fmodal-footer">
      <button class="fmodal-btn cancel" onclick="closePerpanjangModal()">Batal</button>
      <button class="fmodal-btn save" onclick="konfirmasiPerpanjang()"><i class="fas fa-check"></i> Konfirmasi Perpanjang</button>
    </div>
  </div>
</div>

<div class="page-curtain" id="pageCurtain">
  <div class="curtain-panel">
    <div style="text-align:center;color:#fff;">
      <img src="logo smkn bulat.jpg" style="width:72px;height:72px;border-radius:50%;margin:0 auto 16px;display:block;box-shadow:0 8px 24px rgba(0,0,0,.3);">
      <div style="font-size:1.1rem;font-weight:800;color:#fff;margin-bottom:6px;">Perpustakaan SMKN 1 Ketapang</div>
      <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;">
        <div style="width:14px;height:14px;border:2px solid rgba(255,255,255,.25);border-top-color:#3b7cf4;border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;"></div>
        <span style="font-size:12px;color:rgba(255,255,255,.6);font-weight:600;">Memuat halaman, mohon tunggu...</span>
      </div>
      <div style="width:160px;height:3px;background:rgba(255,255,255,.1);border-radius:10px;margin:0 auto;overflow:hidden;">
        <div style="height:100%;width:60%;background:linear-gradient(90deg,#3b7cf4,#5b9cf6);border-radius:10px;animation:progressShimmer 1.5s linear infinite;background-size:200% 100%;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Progress bar -->
<div class="transition-progress" id="transitionProgress" style="display:none;"></div>

<!-- Logout overlay -->
<div class="logout-overlay" id="logoutOverlay"></div>
<div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMsg"></span></div>


<script>
  /* ─── COUNT-UP ANIMASI ANGKA ─── */
function animateCountUp(elId, target, delay) {
  var el = document.getElementById(elId);
  if (!el) return;
  el.textContent = '0';
  if (target === 0) return;
  var duration = 800;
  var startTime = null;
  setTimeout(function() {
    function step(timestamp) {
      if (!startTime) startTime = timestamp;
      var progress = Math.min((timestamp - startTime) / duration, 1);
      // Easing out cubic
      var eased = 1 - Math.pow(1 - progress, 3);
      el.textContent = Math.floor(eased * target);
      if (progress < 1) {
        requestAnimationFrame(step);
      } else {
        el.textContent = target;
      }
    }
    requestAnimationFrame(step);
  }, delay || 0);
}
  function showProgress() {
  var bar = document.getElementById('transitionProgress');
  if (!bar) return;
  bar.style.display = 'block';
  bar.style.width = '0%';
  setTimeout(() => { bar.style.width = '80%'; }, 30);
}

function hideProgress() {
  var bar = document.getElementById('transitionProgress');
  if (!bar) return;
  bar.style.width = '100%';
  setTimeout(() => {
    bar.style.display = 'none';
    bar.style.width = '0%';
  }, 400);
}

function applyStagger(tabId) {
  var tab = document.getElementById(tabId);
  if (!tab) return;
  var items = tab.querySelectorAll('.card-box, .dash-stat, .denda-card, .profil-stats .ps-item');
  items.forEach((el, i) => {
    el.style.animationDelay = (i * 55) + 'ms';
    el.classList.remove('stagger-item');
    void el.offsetWidth;
    el.classList.add('stagger-item');
  });
}
const ACCOUNTS = [
  { id:'siswa', nis:'12282008',           pass:'aditya1228', name:'Aditya Nirwantoro',  role:'Siswa',         email:'NIS: 12282008',            avatar:'AN', color:'#3b7cf4' },
  { id:'guru',  nis:'197805012005012001', pass:'guru123',    name:'Korawati, S.Pd',     role:'Guru',          email:'NIP: 197805012005012001',   avatar:'KR', color:'#16a34a' },
  { id:'admin', nis:'admin',             pass:'admin123',   name:'Admin Perpustakaan',  role:'Administrator', email:'admin@smkn1ketapang.sch.id', avatar:'AD', color:'#f59e0b' },
];

const BOOKS = [
  { id:1,  title:'Matematika Kelas X',                    author:'Kemendikbud',               year:2022, cat:'Pelajaran', icon:'fas fa-square-root-alt', bg:'linear-gradient(140deg,#1d4ed8,#1e40af)', stock:3, total:4, pub:'Kemendikbud',      pages:320,  img:'Matematika.png', isbn:'978-602-427-001-1', desc:'Buku teks Matematika Kelas X mencakup aljabar, fungsi, trigonometri, dan statistika.' },
  { id:2,  title:'Bahasa Indonesia Kelas XI',             author:'Kemendikbud',               year:2022, cat:'Pelajaran', icon:'fas fa-language',         bg:'linear-gradient(140deg,#15803d,#166534)', stock:4, total:4, pub:'Kemendikbud',      pages:280,  img:'Indonesia_BG_KLS_XI_Rev_Cover.png', desc:'Buku teks Bahasa Indonesia Kelas XI mencakup teks eksposisi, persuasi, cerpen, dan puisi.' },
  { id:3,  title:'Bumi',                                  author:'Tere Liye',                 year:2021, cat:'Fiksi',     icon:'fas fa-globe',            bg:'linear-gradient(140deg,#7c3aed,#6d28d9)', stock:1, total:3, pub:'Gramedia',         pages:440,  img:'Islam-BG-KLS-XI.png', desc:'Novel petualangan fantasi Tere Liye tentang Raib yang bisa menghilang.' },
  { id:4,  title:'Laskar Pelangi',                        author:'Andrea Hirata',             year:2020, cat:'Fiksi',     icon:'fas fa-star',             bg:'linear-gradient(140deg,#d97706,#b45309)', stock:5, total:6, pub:'Bentang Pustaka',  pages:529,  img:'Kristen XI.png', desc:'Kisah sepuluh anak dari keluarga miskin di Belitung yang berjuang keras mendapatkan pendidikan.' },
  { id:5,  title:'Sapiens',                               author:'Yuval Noah Harari',         year:2019, cat:'Non-Fiksi', icon:'fas fa-landmark',         bg:'linear-gradient(140deg,#111827,#1f2937)', stock:0, total:2, pub:'KPG',              pages:498,  img:'TIK.jpg', desc:'Perjalanan umat manusia dari Zaman Batu hingga era modern.' },
  { id:6,  title:'Kamus Besar Bahasa Indonesia',          author:'Badan Pengembangan Bahasa', year:2018, cat:'Referensi', icon:'fas fa-book-open',        bg:'linear-gradient(140deg,#dc2626,#b91c1c)', stock:3, total:3, pub:'Balai Pustaka',    pages:1800, img:'Kimia.jpg', desc:'Kamus resmi Bahasa Indonesia memuat lebih dari 100.000 entri kata.' },
  { id:7,  title:'Fisika untuk SMA/SMK Kelas XI',         author:'Marthen Kanginan',          year:2021, cat:'Pelajaran', icon:'fas fa-bolt',             bg:'linear-gradient(140deg,#0891b2,#0e7490)', stock:2, total:5, pub:'Erlangga',         pages:410,  img:'Fisika.jpg', desc:'Buku teks Fisika Kelas XI membahas dinamika rotasi, fluida, dan gelombang.' },
  { id:8,  title:'Atomic Habits',                         author:'James Clear',               year:2022, cat:'Non-Fiksi', icon:'fas fa-atom',             bg:'linear-gradient(140deg,#059669,#047857)', stock:3, total:4, pub:'Avery',            pages:320,  img:'Biologi.jpg', desc:'Panduan berbasis riset untuk membangun kebiasaan baik.' },
  { id:9,  title:'Kimia Dasar',                           author:'Raymond Chang',             year:2020, cat:'Pelajaran', icon:'fas fa-flask',            bg:'linear-gradient(140deg,#7c3aed,#5b21b6)', stock:1, total:3, pub:'McGraw-Hill',      pages:850,  img:'Pendidikan Kewarganegaraan.jpg', desc:'Buku teks kimia umum mencakup stoikiometri dan termokimia.' },
  { id:10, title:'Python Crash Course',                   author:'Eric Matthes',              year:2022, cat:'Referensi', icon:'fab fa-python',           bg:'linear-gradient(140deg,#1d4ed8,#1e3a8a)', stock:2, total:2, pub:'No Starch Press',  pages:544,  img:'Geografi.jpg', desc:'Pengenalan Python yang cepat dan praktis.' },
  { id:11, title:'Negeri 5 Menara',                       author:'Ahmad Fuadi',               year:2020, cat:'Fiksi',     icon:'fas fa-mosque',           bg:'linear-gradient(140deg,#16a34a,#15803d)', stock:4, total:5, pub:'Gramedia',         pages:423,  img:'Sejarah.jpg', desc:"Kisah Alif Fikri di pesantren Pondok Madani." },
  { id:12, title:'Biologi Kelas XII',                     author:'Irnaningtyas',              year:2021, cat:'Pelajaran', icon:'fas fa-dna',              bg:'linear-gradient(140deg,#dc2626,#b91c1c)', stock:2, total:4, pub:'Erlangga',         pages:390,  img:'PJOK.png', desc:'Buku teks Biologi Kelas XII mencakup pertumbuhan dan genetika.' },
  { id:13, title:'Sejarah Indonesia Kelas X',             author:'Kemendikbud',               year:2022, cat:'Pelajaran', icon:'fas fa-scroll',           bg:'linear-gradient(140deg,#b45309,#92400e)', stock:5, total:5, pub:'Kemendikbud',      pages:310,  img:'KKA.png', desc:'Membahas prasejarah, kerajaan Hindu-Buddha hingga perjuangan kemerdekaan.' },
  { id:14, title:'The Art of War',                        author:'Sun Tzu',                   year:2019, cat:'Non-Fiksi', icon:'fas fa-chess-king',       bg:'linear-gradient(140deg,#1f2937,#111827)', stock:2, total:3, pub:'Various',          pages:273,  img:null, desc:'Risalah strategi militer kuno yang relevan dalam kepemimpinan modern.' },
  { id:15, title:'Ensiklopedia Sains',                    author:'Tim DK',                    year:2020, cat:'Referensi', icon:'fas fa-microscope',       bg:'linear-gradient(140deg,#0891b2,#155e75)', stock:0, total:2, pub:'DK Publishing',    pages:1200, img:null, desc:'Ensiklopedia sains bergambar komprehensif mencakup fisika, kimia, biologi.' },
  { id:16, title:'Matematika Kelas XI',                   author:'Kemendikbud',               year:2022, cat:'Pelajaran', icon:'fas fa-square-root-alt', bg:'linear-gradient(140deg,#1d4ed8,#1e40af)', stock:3, total:5, pub:'Kemendikbud',      pages:340,  img:null, desc:'Membahas program linear, matriks, transformasi, dan peluang.' },
  { id:17, title:'Ekonomi Kelas X',                       author:'Alam S.',                   year:2021, cat:'Pelajaran', icon:'fas fa-chart-line',       bg:'linear-gradient(140deg,#059669,#065f46)', stock:4, total:4, pub:'Esis',             pages:295,  img:null, desc:'Membahas konsep dasar ekonomi, permintaan dan penawaran.' },
  { id:18, title:'Thinking, Fast and Slow',               author:'Daniel Kahneman',           year:2018, cat:'Non-Fiksi', icon:'fas fa-brain',            bg:'linear-gradient(140deg,#7c3aed,#4c1d95)', stock:1, total:2, pub:'Farrar Straus',    pages:499,  img:null, desc:'Pemenang Nobel menjelaskan dua sistem berpikir manusia.' },
  { id:19, title:'Bahasa Inggris Kelas XII',              author:'Kemendikbud',               year:2022, cat:'Pelajaran', icon:'fas fa-comments',         bg:'linear-gradient(140deg,#0891b2,#0c4a6e)', stock:3, total:5, pub:'Kemendikbud',      pages:260,  img:null, desc:'Mencakup reading comprehension, grammar, dan writing skills.' },
  { id:20, title:'Dunia Sophie',                          author:'Jostein Gaarder',           year:2020, cat:'Fiksi',     icon:'fas fa-question-circle',  bg:'linear-gradient(140deg,#1d4ed8,#1e3a8a)', stock:2, total:3, pub:'Gyldendal',        pages:512,  img:null, desc:'Novel filsafat tentang Sophie yang menjelajahi pemikiran filosof besar.' },
]
const JB_KEY         = "$2a$10$WAEc7BsjDoeLvtCrWkBm5..cIBB6Whb/uKYNwWr5Lmwm1GMHehxXe";
const JB_BIN_RIWAYAT = "699fb74aae596e708f4aaef3";
const JB_BIN_PENDING = "699fb790ae596e708f4aaf8e";
const JB_BASE = "https://api.jsonbin.io/v3/b";

let RIWAYAT         = [];
let pendingRequests = [];
let pendingIdCounter = 1000;
let _pollInterval   = null;
let _isSyncing      = false;

function jbHeaders() {
  return {
    'Content-Type'    : 'application/json',
    'X-Master-Key'    : JB_KEY,
    'X-Bin-Versioning': 'false'
  };
}

async function fetchBin(binId) {
  try {
    const res  = await fetch(`${JB_BASE}/${binId}/latest`, { headers: jbHeaders() });
    const json = await res.json();
    return Array.isArray(json.record) ? json.record : [];
  } catch(e) { return null; }
}

async function putBin(binId, data) {
  try {
    const res = await fetch(`${JB_BASE}/${binId}`, {
      method : 'PUT',
      headers: jbHeaders(),
      body   : JSON.stringify(data)
    });
    await res.json();
  } catch(e) { console.warn('JSONBin save error:', e); }
}

async function saveRiwayat() { await putBin(JB_BIN_RIWAYAT, RIWAYAT); }
async function savePending()  { await putBin(JB_BIN_PENDING, pendingRequests); }

async function loadFromCloud() {
  const [r, p] = await Promise.all([
    fetchBin(JB_BIN_RIWAYAT),
    fetchBin(JB_BIN_PENDING)
  ]);
  if (r !== null) { RIWAYAT = r; }
  if (p !== null) {
    pendingRequests = p;
    if (p.length) {
      const maxId = Math.max(...p.map(x => x.id || 0));
      if (maxId > pendingIdCounter) pendingIdCounter = maxId;
    }
  }
  checkAndUpdateLateStatus();
  renderRiwayat();
  renderDenda();
  updateHeroStats();
  if (currentUser && currentUser.id === 'admin') updateBellBadge();
}

function startPolling() {
  if (_pollInterval) return;
  _pollInterval = setInterval(async () => {
    if (_isSyncing) return;
    _isSyncing = true;
    const p = await fetchBin(JB_BIN_PENDING);
    if (p !== null && p.length !== pendingRequests.length) {
      const wasCount = pendingRequests.length;
      pendingRequests = p;
      if (currentUser && currentUser.id === 'admin') {
        updateBellBadge();
        if (p.length > wasCount) {
          showToast(`🔔 Ada ${p.length - wasCount} permintaan baru!`, 'info');
        }
        const panel = document.getElementById('notifPanel');
        if (panel && panel.classList.contains('open')) renderNotifPanel();
      }
    }
    _isSyncing = false;
  }, 10000);
}

function stopPolling() {
  if (_pollInterval) { clearInterval(_pollInterval); _pollInterval = null; }
}

let currentUser  = null;
let currentRole  = 'siswa';
let activeCat    = 'all';
let activeSearch = '';
let isGridView   = true;
let selectedBook = null;

// ══ STATE PERPANJANG ══
let perpanjangTargetId = null; // ID riwayat yang sedang akan diperpanjang

/* ════ LOGIN ════ */
function setRole(role, el) {
  currentRole = role;
  document.querySelectorAll('.utt').forEach(b => b.classList.remove('on'));
  el.classList.add('on');
  const lbl = { siswa:'NIS (Nomor Induk Siswa)', guru:'NIP (Nomor Induk Pegawai)', admin:'ID Admin' };
  document.getElementById('nisLabel').textContent = lbl[role];
  document.getElementById('loginNis').placeholder = role==='admin' ? 'Masukkan ID Admin' : role==='guru' ? 'Masukkan NIP Anda' : 'Masukkan NIS Anda';
}

function fillDemo(role) {
  const a = ACCOUNTS.find(x => x.id === role);
  document.querySelector(`[data-role="${role}"]`).click();
  document.getElementById('loginNis').value  = a.nis;
  document.getElementById('loginPass').value = a.pass;
  hideAlert();
}

function toggleEye() {
  const inp = document.getElementById('loginPass');
  const ico = document.getElementById('eyeBtn').querySelector('i');
  if (inp.type==='password') { inp.type='text'; ico.className='fas fa-eye-slash'; }
  else { inp.type='password'; ico.className='fas fa-eye'; }
}

function hideAlert() {
  document.getElementById('loginAlert').classList.remove('show');
  document.getElementById('loginNis').classList.remove('error');
  document.getElementById('loginPass').classList.remove('error');
  document.getElementById('nisErr').classList.remove('show');
  document.getElementById('passErr').classList.remove('show');
}

function doLogin() {
  hideAlert();
  const nis  = document.getElementById('loginNis').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  let valid  = true;
  if (!nis)  { document.getElementById('nisErr').classList.add('show');  document.getElementById('loginNis').classList.add('error');  valid=false; }
  if (!pass) { document.getElementById('passErr').classList.add('show'); document.getElementById('loginPass').classList.add('error'); valid=false; }
  if (!valid) return;
  const btn = document.getElementById('loginBtn');
  btn.classList.add('loading');
  setTimeout(async () => {
    btn.classList.remove('loading');
    const acc = ACCOUNTS.find(a => a.nis===nis && a.pass===pass);
    if (!acc) {
      document.getElementById('loginAlertMsg').textContent = 'NIS/NIP atau kata sandi salah. Coba lagi.';
      document.getElementById('loginAlert').classList.add('show');
      document.getElementById('loginNis').classList.add('error');
      document.getElementById('loginPass').classList.add('error');
      return;
    }
currentUser = acc;
loadUserToUI(acc);
var curtain = document.getElementById('pageCurtain');
if (curtain) {
  curtain.classList.add('sweep-in');
  setTimeout(async () => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-peminjaman').classList.add('active');
    initPeminjaman();
    await loadFromCloud();
    startPolling();
    showDueDateBanner();
    curtain.classList.remove('sweep-in');
    curtain.classList.add('sweep-out');
    setTimeout(() => {
      curtain.classList.remove('sweep-out');
      showToast(`Selamat datang, ${acc.name}! 👋`, 'success');
   }, 650);        // ← tutup setTimeout dalam
      }, 700);          // ← tutup setTimeout curtain
    }                   // ← tutup if (curtain)
  }, 1200);             // ← tutup setTimeout loading
}                       // ← tutup function doLogin
var _pendingTabAfterLogin = null;
var _bukuDipilihSetelahLogin = null; 

function initGuestMode() {
  currentUser = null;
  var loginBtn = document.getElementById('navLoginBtn');
  var userPill = document.getElementById('navUserPill');
  if (loginBtn) loginBtn.style.display = 'flex';
  if (userPill) userPill.style.display = 'none';
  ['tabBtnPinjam','tabBtnRiwayat','tabBtnDenda','tabBtnProfil'].forEach(function(id){
    var el = document.getElementById(id);
    if (el) { el.style.opacity = '.45'; el.title = 'Login diperlukan'; }
  });
  document.querySelectorAll('.admin-tab').forEach(function(t){ t.style.display = 'none'; });
  renderBooks(getFiltered());
  updateHeroStats();
}

function requireLogin(tabName) {
  if (currentUser) { switchMainTab(tabName); return; }
  showToast('Silakan masuk terlebih dahulu.', 'error');
  openLoginModal(tabName);
}

function openLoginModal(afterTab) {
  _pendingTabAfterLogin = afterTab || null;
  var mNis = document.getElementById('mLoginNis');
  var mPass = document.getElementById('mLoginPass');
  if (mNis) mNis.value = '';
  if (mPass) mPass.value = '';
  var alertEl = document.getElementById('loginModalAlert');
  if (alertEl) alertEl.style.display = 'none';
  setModalRole('siswa', document.getElementById('mUttSiswa'));
  document.getElementById('loginModalBg').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(function(){ if (mNis) mNis.focus(); }, 250);
}

function closeLoginModal() {
  var bg = document.getElementById('loginModalBg');
  if (bg) bg.classList.remove('open');
  document.body.style.overflow = '';
  _pendingTabAfterLogin = null;
}

var _mRole = 'siswa';
function setModalRole(role, el) {
  _mRole = role;
  document.querySelectorAll('#mRoleTabs button').forEach(function(b){
    b.classList.remove('on');
    b.style.background = 'transparent';
    b.style.color = 'var(--text3)';
    b.style.boxShadow = 'none';
  });
  if (el) {
    el.classList.add('on');
    el.style.background = '#fff';
    el.style.color = 'var(--navy)';
    el.style.boxShadow = '0 1px 4px rgba(15,27,53,.1)';
  }
  var lbl = { siswa:'NIS (Nomor Induk Siswa)', guru:'NIP (Nomor Induk Pegawai)', admin:'ID Admin' };
  var ph  = { siswa:'Masukkan NIS Anda', guru:'Masukkan NIP Anda', admin:'Masukkan ID Admin' };
  var lbEl = document.getElementById('mNisLabel');
  var nisEl = document.getElementById('mLoginNis');
  if (lbEl) lbEl.textContent = lbl[role] || lbl.siswa;
  if (nisEl) nisEl.placeholder = ph[role] || ph.siswa;
}

function fillModalDemo(role) {
  var a = ACCOUNTS.find(function(x){ return x.id === role; });
  if (!a) return;
  var map = { siswa:'mUttSiswa', guru:'mUttGuru', admin:'mUttAdmin' };
  setModalRole(role, document.getElementById(map[role]));
  var mNis = document.getElementById('mLoginNis');
  var mPass = document.getElementById('mLoginPass');
  if (mNis) mNis.value = a.nis;
  if (mPass) mPass.value = a.pass;
  var alertEl = document.getElementById('loginModalAlert');
  if (alertEl) alertEl.style.display = 'none';
}

function toggleModalEye() {
  var inp = document.getElementById('mLoginPass');
  var ico = document.getElementById('mEyeIcon');
  if (!inp) return;
  if (inp.type === 'password') { inp.type = 'text'; if (ico) ico.className = 'fas fa-eye-slash'; }
  else { inp.type = 'password'; if (ico) ico.className = 'fas fa-eye'; }
}

function doModalLogin() {
  var nis  = (document.getElementById('mLoginNis').value || '').trim();
  var pass = (document.getElementById('mLoginPass').value || '').trim();
  var alertEl  = document.getElementById('loginModalAlert');
  var alertMsg = document.getElementById('loginModalAlertMsg');
  if (!nis || !pass) {
    alertEl.style.display = 'flex';
    alertMsg.textContent = 'NIS/NIP dan kata sandi wajib diisi.';
    return;
  }
  document.getElementById('mBtnText').style.display = 'none';
  document.getElementById('mSpinner').style.display = 'block';
  alertEl.style.display = 'none';
  setTimeout(async function() {
    document.getElementById('mBtnText').style.display = 'flex';
    document.getElementById('mSpinner').style.display = 'none';
    var acc = ACCOUNTS.find(function(a){ return a.nis === nis && a.pass === pass; });
    if (!acc) {
      alertEl.style.display = 'flex';
      alertMsg.textContent = 'NIS/NIP atau kata sandi salah. Coba lagi.';
      return;
    }
    currentUser = acc;
    closeLoginModal();
    var loginBtn = document.getElementById('navLoginBtn');
    var userPill = document.getElementById('navUserPill');
    if (loginBtn) loginBtn.style.display = 'none';
    if (userPill) userPill.style.display = 'flex';
    ['tabBtnPinjam','tabBtnRiwayat','tabBtnDenda','tabBtnProfil'].forEach(function(id){
      var el = document.getElementById(id);
      if (el) { el.style.opacity = '1'; el.title = ''; }
    });
    document.querySelectorAll('.admin-tab').forEach(function(t){
      t.style.display = acc.id === 'admin' ? 'flex' : 'none';
      t.style.opacity = '1';
    });
    loadUserToUI(acc);
    await loadFromCloud();
    startPolling();
    showDueDateBanner();
  showToast('Selamat datang, ' + acc.name.split(' ')[0] + '! 👋', 'success');
    if (typeof _bukuDipilihSetelahLogin !== 'undefined' && _bukuDipilihSetelahLogin) {
      var bukuId = _bukuDipilihSetelahLogin;
      _bukuDipilihSetelahLogin = null;
      setTimeout(function(){
        switchMainTab('pinjam');
        selectBook(bukuId);
      }, 500);
    }

    if (_pendingTabAfterLogin) {
      var tab = _pendingTabAfterLogin;
      _pendingTabAfterLogin = null;
      setTimeout(function(){ switchMainTab(tab); }, 400);
    }
  }, 900);
}
function loadUserToUI(acc) {
  // LOAD foto dari localStorage jika ada
  var savedPhoto = localStorage.getItem('avatarPhoto_' + acc.nis);
  if (savedPhoto) {
    acc.avatarPhoto = savedPhoto;
  }

  document.getElementById('navAvatar').style.background = acc.color;

  // Tampilkan foto atau inisial di navbar
  var navAv = document.getElementById('navAvatar');
  if (acc.avatarPhoto) {
    navAv.textContent = '';
    navAv.style.background = 'none';
    navAv.style.padding = '0';
    navAv.style.overflow = 'hidden';
    var img = document.createElement('img');
    img.src = acc.avatarPhoto;
    img.alt = 'Avatar';
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;';
    navAv.appendChild(img);
  } else {
    navAv.textContent = acc.avatar;
    navAv.style.background = acc.color;
  }

  document.getElementById('navName').textContent         = acc.name.split(' ')[0];
  document.getElementById('navRole').textContent         = acc.role;
  document.getElementById('ddName').textContent          = acc.name;
  document.getElementById('ddEmail').textContent         = acc.email;
  document.getElementById('fNama').value                 = acc.name;
  document.getElementById('fNis').value                  = acc.nis;

  var bellBtn = document.getElementById('bellBtn');
  if (acc.id === 'admin') {
    bellBtn.title = 'Panel Persetujuan Peminjaman';
    bellBtn.style.cursor = 'pointer';
    bellBtn.style.opacity = '1';
    updateBellBadge();
  } else {
    bellBtn.title = 'Notifikasi (hanya admin)';
    bellBtn.style.cursor = 'not-allowed';
    bellBtn.style.opacity = '0.45';
    document.getElementById('bellCount').style.display = 'none';
  }
  document.querySelectorAll('.admin-tab').forEach(function(t){
    t.style.display = acc.id === 'admin' ? 'flex' : 'none';
  });
  loadProfilFields(acc);
}

function doLogout() {
  if (!confirm('Yakin ingin keluar?')) return;
  var overlay = document.getElementById('logoutOverlay');
  if (overlay) {
    overlay.classList.add('visible');
    setTimeout(() => {
      stopPolling();
      currentUser = null; selectedBook = null;
      document.getElementById('notifPanel').classList.remove('open');
      document.getElementById('loginNis').value  = '';
      document.getElementById('loginPass').value = '';
      hideAlert();
      currentUser = null;
      initGuestMode();
      switchMainTab('koleksi');
      overlay.classList.remove('visible');
      showToast('Anda telah keluar.', 'info');
    }, 380);
  }
}

function showPage(name) {
  var current = document.querySelector('.page.active');
  var next = document.getElementById('page-' + name);
  if (!next || current === next) return;
  if (current) {
    current.classList.add('exiting');
    setTimeout(() => { current.classList.remove('active','exiting'); }, 280);
  }
  next.classList.add('entering');
  setTimeout(() => {
    next.classList.add('active');
    next.classList.remove('entering');
  }, 50);
  window.scrollTo(0, 0);
}

function goHome() {
  window.location.href = 'TugasAkhir.html';
}

function navGo(section) {
  const urls = {
    beranda: 'TugasAkhir.html',
    tentang: 'TugasAkhir.html#struktur-organisasi',
    koleksi: 'TugasAkhir.html#koleksi',
    layanan: 'TugasAkhir.html#layanan',
    kontak:  'TugasAkhir.html#kontak',
  };
  if (urls[section]) window.location.href = urls[section];
}

function switchMainTab(name) {
  const map = { koleksi:'Koleksi', pinjam:'Pinjam', riwayat:'Riwayat', denda:'Denda', profil:'Profil', dashboard:'Dashboard', manajemen:'Manajemen' };
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('on'));
  var tabBtn = document.getElementById('tabBtn' + map[name]);
  if (tabBtn) tabBtn.classList.add('on');
  var current = document.querySelector('.tab-section.on');
  if (current) {
    current.classList.add('tab-exit');
    setTimeout(() => { current.classList.remove('on','tab-exit'); }, 200);
  }
  showProgress();
  setTimeout(() => {
    var next = document.getElementById('ts' + map[name]);
    if (next) next.classList.add('on');
    hideProgress();
    applyStagger('ts' + map[name]);
    if (name === 'dashboard') renderDashboard();
    if (name === 'manajemen') renderManajemen();
    if (name === 'profil') renderProfil();
  }, 180);
}

/* ════ INIT ════ */
function initPeminjaman() {
  updateHeroStats();
  renderBooks(getFiltered());
  renderRiwayat();
  renderDenda();
  setTodayDate();
  initFormLive();
  initBookSearchForm();

  document.querySelectorAll('#catPills .pill').forEach(p => {
    p.addEventListener('click', () => {
      document.querySelectorAll('#catPills .pill').forEach(x => x.classList.remove('on'));
      p.classList.add('on');
      activeCat = p.dataset.c;
      renderBooks(getFiltered());
    });
  });

  document.getElementById('bookSearch').addEventListener('input', e => {
    activeSearch = e.target.value.toLowerCase();
    document.getElementById('clearBook').style.display = activeSearch ? 'block' : 'none';
    renderBooks(getFiltered());
  });

  document.getElementById('bookSort').addEventListener('change', () => renderBooks(getFiltered()));

  document.getElementById('gBtn').addEventListener('click', () => {
    isGridView = true;
    document.getElementById('booksGrid').classList.remove('list-mode');
    document.getElementById('gBtn').classList.add('on');
    document.getElementById('lBtn').classList.remove('on');
  });

  document.getElementById('lBtn').addEventListener('click', () => {
    isGridView = false;
    document.getElementById('booksGrid').classList.add('list-mode');
    document.getElementById('lBtn').classList.add('on');
    document.getElementById('gBtn').classList.remove('on');
  });
}

function clearBookSearch() {
  document.getElementById('bookSearch').value = '';
  activeSearch = '';
  document.getElementById('clearBook').style.display = 'none';
  renderBooks(getFiltered());
}

function getFiltered() {
  let list = [...BOOKS];
  if (activeCat !== 'all') list = list.filter(b => b.cat === activeCat);
  if (activeSearch)        list = list.filter(b => b.title.toLowerCase().includes(activeSearch) || b.author.toLowerCase().includes(activeSearch));
  const sort = document.getElementById('bookSort')?.value || 'default';
  if (sort==='title')    list.sort((a,b) => a.title.localeCompare(b.title));
  else if (sort==='year_new') list.sort((a,b) => b.year-a.year);
  else if (sort==='stock')    list.sort((a,b) => b.stock-a.stock);
  return list;
}

/* ════ RENDER BUKU ════ */
function renderBooks(list) {
  const grid  = document.getElementById('booksGrid');
  const empty = document.getElementById('bookEmpty');
  grid.querySelectorAll('.bk').forEach(c => c.remove());
  grid.querySelectorAll('.bk-skeleton').forEach(c => c.remove());

  // Tampilkan skeleton dulu
  for (let i = 0; i < 8; i++) {
    const sk = document.createElement('div');
    sk.className = 'bk-skeleton';
    sk.innerHTML = `
      <div class="sk-cover"></div>
      <div class="sk-body">
        <div class="sk-line sk-line-short"></div>
        <div class="sk-line sk-line-long"></div>
        <div class="sk-line sk-line-med"></div>
      </div>`;
    grid.insertBefore(sk, empty);
  }

  // Hapus skeleton setelah 400ms lalu tampilkan buku
  setTimeout(() => {
    grid.querySelectorAll('.bk-skeleton').forEach(c => c.remove());
    document.getElementById('bookCount').innerHTML = `<strong>${list.length}</strong> buku ditampilkan`;
    document.getElementById('tcKoleksi').textContent = list.length;
    if (!list.length) { empty.classList.add('show'); return; }
    empty.classList.remove('show');

    list.forEach((b, i) => {
      const sc = b.stock===0 ? 'stock-out' : b.stock<=1 ? 'stock-low' : 'stock-ok';
      const st = b.stock===0 ? 'Habis' : `${b.stock}/${b.total} stok`;
      const sb = b.stock===0 ? 'sb-borrow' : b.stock<=1 ? 'sb-limit' : 'sb-avail';
      const sl = b.stock===0 ? 'Dipinjam' : b.stock<=1 ? 'Terbatas' : 'Tersedia';
      const card = document.createElement('div');
      card.className = 'bk';
      card.style.transitionDelay = `${i*30}ms`;
      card.innerHTML = `
        <div class="bk-cover">
          <div class="bk-cover-inner" style="background:${b.bg};">
            <div class="cover-lines"></div>
            ${b.img 
              ? `<img src="${b.img}" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0;">`
              : `<div class="cover-ico"><i class="${b.icon}"></i></div>`
            }
            <div class="cover-top">
              <span class="cat-badge">${b.cat}</span>
              <span class="status-badge ${sb}">${sl}</span>
            </div>
            <div class="cover-actions">
              <button class="ca" onclick="event.stopPropagation();openModal(${b.id})" title="Detail"><i class="fas fa-eye"></i></button>
              <button class="ca" onclick="event.stopPropagation();pilihBuku(${b.id})" title="Pinjam"><i class="fas fa-bookmark"></i></button>
            </div>
          </div>
        </div>
        <div class="bk-body">
          <div class="bk-cat">${b.cat}</div>
          <div class="bk-title">${b.title}</div>
          <div class="bk-author"><i class="fas fa-user" style="font-size:9px;"></i> ${b.author}</div>
          <div class="bk-footer">
            <span class="bk-year"><i class="fas fa-calendar-alt" style="font-size:9px;"></i> ${b.year}</span>
            <span class="bk-stock ${sc}">${st}</span>
          </div>
          ${b.isbn ? `<div style="font-size:9.5px;color:#94a3b8;margin-top:6px;"><i class="fas fa-barcode" style="font-size:9px;"></i> ${b.isbn}</div>` : ''}
        </div>`;
      card.addEventListener('click', () => openModal(b.id));
      grid.insertBefore(card, empty);
      setTimeout(() => {
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('in'); obs.unobserve(e.target); } });
        }, { threshold:.08 });
        obs.observe(card);
      }, 30);
    });
  }, 400);
}

/* ════ MODAL ════ */
function openModal(id) {
  const b = BOOKS.find(x => x.id===id); if (!b) return;
  document.getElementById('mCover').style.background = b.bg;
  document.getElementById('mCovBadge').textContent   = b.cat;
  document.getElementById('mCovIco').className       = b.icon;
  document.getElementById('mGenre').textContent      = b.cat;
  document.getElementById('mTitle').textContent      = b.title;
  document.getElementById('mAuthor').textContent     = 'oleh ' + b.author;
  document.getElementById('mDesc').textContent       = b.desc;
  const st = b.stock===0 ? '❌ Tidak Tersedia' : b.stock<=1 ? `⚠️ Terbatas (${b.stock} tersisa)` : `✅ Tersedia (${b.stock}/${b.total})`;
  document.getElementById('mMeta').innerHTML = `
    <div class="mm-item"><div class="mm-label">Penerbit</div><div class="mm-val">${b.pub}</div></div>
    <div class="mm-item"><div class="mm-label">Tahun Terbit</div><div class="mm-val">${b.year}</div></div>
    <div class="mm-item"><div class="mm-label">Jumlah Halaman</div><div class="mm-val">${b.pages} hal.</div></div>
    <div class="mm-item"><div class="mm-label">Ketersediaan</div><div class="mm-val">${st}</div></div>
    ${b.isbn ? `<div class="mm-item" style="grid-column:1/-1;"><div class="mm-label">ISBN</div><div class="mm-val"><i class="fas fa-barcode" style="font-size:11px;margin-right:5px;"></i>${b.isbn}</div></div>` : ''}`;
  const pb = document.getElementById('mPinjamBtn');
  pb.disabled = b.stock===0; pb.style.opacity = b.stock===0 ? '.4' : '1';
  pb.onclick  = () => { closeModal(); requireLogin('pinjam'); selectedBook = b; };
  document.getElementById('modalBg').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modalBg').classList.remove('open');
  document.body.style.overflow = '';
}

document.getElementById('modalBg').addEventListener('click', e => { if (e.target===document.getElementById('modalBg')) closeModal(); });
document.addEventListener('keydown', e => { if (e.key==='Escape') { closeModal(); closePerpanjangModal(); } });

/* ════ PENCARIAN FORM ════ */
function initBookSearchForm() {
  const input  = document.getElementById('fBookSearch');
  const result = document.getElementById('bookSearchResult');
  input.addEventListener('input', () => {
    const q = input.value.toLowerCase(); if (!q) { result.classList.remove('show'); return; }
    const found = BOOKS.filter(b => b.title.toLowerCase().includes(q) || b.author.toLowerCase().includes(q)).slice(0,5);
    if (!found.length) { result.classList.remove('show'); return; }
    result.innerHTML = '';
    found.forEach(b => {
      const sc  = b.stock===0 ? 'var(--red)' : b.stock<=1 ? 'var(--orange)' : 'var(--green)';
      const stx = b.stock===0 ? 'Habis' : `${b.stock} tersisa`;
      result.innerHTML += `<div class="bsr-item" onclick="selectBook(${b.id})">
        <div class="bsr-thumb" style="background:${b.bg};"><i class="${b.icon}"></i></div>
        <div class="bsr-info"><div class="bsr-title">${b.title}</div><div class="bsr-meta">${b.author} · ${b.cat}</div></div>
        <span class="bsr-stock" style="color:${sc};">${stx}</span></div>`;
    });
    result.classList.add('show');
  });
  document.addEventListener('click', e => { if (!input.contains(e.target) && !result.contains(e.target)) result.classList.remove('show'); });
}

function selectBook(id) {
  const b = BOOKS.find(x => x.id===id); if (!b) return;
  if (b.stock===0) { showToast('Buku ini sedang tidak tersedia.','error'); return; }
  selectedBook = b;
  document.getElementById('fBookSearch').value = b.title;
  document.getElementById('bookSearchResult').classList.remove('show');
  document.getElementById('sbThumb').innerHTML = `<div style="width:36px;height:48px;border-radius:6px;background:${b.bg};display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.7);font-size:1rem;flex-shrink:0;"><i class="${b.icon}"></i></div>`;
  document.getElementById('sbTitle').textContent  = b.title;
  document.getElementById('sbDetail').textContent = `${b.author} · ${b.stock}/${b.total} stok tersedia`;
  document.getElementById('selectedBookChip').classList.add('show');
  updateSummary();
}

function clearSelectedBook() {
  selectedBook = null;
  document.getElementById('fBookSearch').value = '';
  document.getElementById('selectedBookChip').classList.remove('show');
  document.getElementById('sumBuku').textContent = '—';
}

function pilihBuku(id) {
  if (!currentUser) {
    showToast('Silakan masuk terlebih dahulu.', 'error');
    openLoginModal('pinjam');
    // Simpan buku yang dipilih untuk setelah login
    _bukuDipilihSetelahLogin = id;
    return;
  }
  if (!currentUser) {
    showToast('Silakan masuk terlebih dahulu.', 'error');
    _bukuDipilihSetelahLogin = id;
    openLoginModal('pinjam');
    return;
  }
  switchMainTab('pinjam');
  selectBook(id);
  setTimeout(() => document.getElementById('fNama').focus(), 250);
  showToast('Buku dipilih! Lengkapi form peminjaman.', 'success');
}

/* ════ FORM ════ */
function setTodayDate() {
  const fmt = d => d.toISOString().split('T')[0];
  const today = new Date(); const ret = new Date(today); ret.setDate(ret.getDate()+7);
  document.getElementById('fTglPinjam').value  = fmt(today);
  document.getElementById('fTglPinjam').min    = fmt(today);
  document.getElementById('fTglKembali').value = fmt(ret);
  document.getElementById('fTglKembali').min   = fmt(today);
}

function initFormLive() {
  ['fNama','fNis','fTglPinjam','fTglKembali'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', updateSummary);
  });
}

function updateSummary() {
  const p = document.getElementById('fTglPinjam').value;
  const k = document.getElementById('fTglKembali').value;
  document.getElementById('sumNama').textContent    = document.getElementById('fNama').value || '—';
  document.getElementById('sumNis').textContent     = document.getElementById('fNis').value  || '—';
  document.getElementById('sumBuku').textContent    = selectedBook ? selectedBook.title : '—';
  document.getElementById('sumPinjam').textContent  = p ? new Date(p).toLocaleDateString('id-ID',{day:'numeric',month:'short',year:'numeric'}) : '—';
  document.getElementById('sumKembali').textContent = k ? new Date(k).toLocaleDateString('id-ID',{day:'numeric',month:'short',year:'numeric'}) : '—';
  if (p && k) {
    const diff = Math.round((new Date(k)-new Date(p))/86400000);
    document.getElementById('sumDur').textContent = diff>0 ? diff+' hari' : '—';
    document.getElementById('fTglKembali').min = p;
  }
}

/* ══ SUBMIT PINJAM ══ */
function submitPinjam() {
  const nama = document.getElementById('fNama').value.trim();
  const nis  = document.getElementById('fNis').value.trim();
  const kelas = document.getElementById('fKelas').value.trim();
  const p    = document.getElementById('fTglPinjam').value;
  const k    = document.getElementById('fTglKembali').value;
  if (!nama)         { showToast('Nama lengkap wajib diisi.','error');                document.getElementById('fNama').focus();       return; }
  if (!nis)          { showToast('NIS/NIP wajib diisi.','error');                     document.getElementById('fNis').focus();        return; }
  if (!selectedBook) { showToast('Pilih buku terlebih dahulu.','error');              document.getElementById('fBookSearch').focus(); return; }
  if (!p || !k)      { showToast('Tanggal pinjam & kembali wajib diisi.','error');   return; }
  const diff = Math.round((new Date(k)-new Date(p))/86400000);
  if (diff<=0) { showToast('Tanggal kembali harus setelah tanggal pinjam.','error'); return; }
  if (diff>14) { showToast('Durasi maksimal 14 hari.','error'); return; }

  const req = {
    id: ++pendingIdCounter,
    bookId: selectedBook.id,
    bookTitle: selectedBook.title,
    bookBg: selectedBook.bg,
    bookIcon: selectedBook.icon,
    nama: nama,
    nis: nis,
    kelas: kelas || '—',
    tglPinjam: new Date(p).toLocaleDateString('id-ID',{day:'numeric',month:'short',year:'numeric'}),
    tglKembali: new Date(k).toLocaleDateString('id-ID',{day:'numeric',month:'short',year:'numeric'}),
    // Simpan nilai Date asli untuk keperluan perhitungan jatuh tempo
    tglKembaliRaw: k,
    waktuAjukan: new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}),
    catatan: document.getElementById('fCatatan').value.trim(),
  };

  pendingRequests.push(req);
  savePending();  // ← TAMBAH

  if (currentUser && currentUser.id === 'admin') {
    updateBellBadge();
    renderNotifPanel();
  }

  showToast(`✓ Permintaan "${selectedBook.title}" dikirim! Menunggu konfirmasi admin.`, 'success');

  renderRiwayat();

  setTimeout(() => {
    clearSelectedBook();
    document.getElementById('fCatatan').value = '';
    setTodayDate(); updateSummary();
  }, 500);
}

/* ══════════════════════════════════════════════════
   ══ FITUR BARU: AUTO TERLAMBAT + DENDA ══
   ══════════════════════════════════════════════════ */
function checkAndUpdateLateStatus() {
  var today = new Date();
  today.setHours(0, 0, 0, 0);

  RIWAYAT.forEach(function(r) {
    // Hanya proses yang masih aktif/borrow (belum dikembalikan)
    if (r.status !== 'active' && r.status !== 'borrow') return;
    if (!r.tglKembaliRaw) return;

    var due = new Date(r.tglKembaliRaw);
    due.setHours(0, 0, 0, 0);

    var diffDays = Math.round((today - due) / 86400000);

    if (diffDays > 0) {
      // Sudah melewati jatuh tempo → ubah status ke late dan hitung denda
      r.status = 'late';
      r.denda  = diffDays * 500; // Rp 500 per hari
    } else {
      // Belum terlambat — pastikan status kembali ke active jika sebelumnya sempat berubah
      if (r.status === 'late') {
        r.status = 'active';
        r.denda  = 0;
      }
    }
  });
}

/* ════ RIWAYAT ════ */
function renderRiwayat() {
  // ── Auto-update status terlambat & denda sebelum render ──
  checkAndUpdateLateStatus();

  var tbody = document.getElementById('riwayatBody');
  var emptyEl = document.getElementById('riwayatEmpty');
  var tableWrap = document.getElementById('riwayatTableWrap');
  var adminBadge = document.getElementById('adminRiwayatBadge');
  tbody.innerHTML = '';

  var isAdmin = currentUser && currentUser.id === 'admin';

  if (adminBadge) adminBadge.style.display = isAdmin ? 'inline-flex' : 'none';

  var list = isAdmin ? RIWAYAT : RIWAYAT.filter(function(r){ return r.nis === (currentUser ? currentUser.nis : ''); });

  if (!list.length) {
    emptyEl.style.display = 'block';
    tableWrap.style.display = 'none';
    document.getElementById('tcRiwayat').textContent = '0';
    return;
  }
  emptyEl.style.display = 'none';
  tableWrap.style.display = 'block';
  document.getElementById('tcRiwayat').textContent = list.length;

  var sm = {
    active: {cls:'sp-active',  lbl:'Aktif'},
    late:   {cls:'sp-late',    lbl:'Terlambat'},
    done:   {cls:'sp-done',    lbl:'Selesai'},
    borrow: {cls:'sp-borrow',  lbl:'Dipinjam'},
  };

  list.forEach(function(r) {
    var b = BOOKS.find(function(x){ return x.id===r.bookId; });
    if (!b) return;
    var st = sm[r.status] || sm.done;

    // ── TOMBOL AKSI (termasuk Perpanjang) ──
    var aksiHtml = '';
    var perpanjangHtml = '';

    // Tombol Perpanjang hanya untuk peminjaman aktif yang belum pernah diperpanjang
    if (r.status === 'active' || r.status === 'borrow' || r.status === 'late') {
      if (!r.sudahDiperpanjang) {
        perpanjangHtml = '<button class="perpanjang-btn" onclick="openPerpanjangModal(' + r.id + ')" title="Perpanjang 7 hari"><i class="fas fa-calendar-plus"></i> Perpanjang</button>';
      } else {
        perpanjangHtml = '<span class="perpanjang-done"><i class="fas fa-check" style="color:var(--green);font-size:9px;"></i> (sudah diperpanjang)</span>';
      }
    }

    if (isAdmin) {
      var kembalikanBtn = '';
      if (r.status === 'active' || r.status === 'borrow' || r.status === 'late') {
        kembalikanBtn = "<button class='action-link' onclick='showToast(\"Pengembalian dicatat.\",\"success\")'>Kembalikan</button>";
      } else {
        kembalikanBtn = '<span style="color:var(--text3);font-size:11px;">—</span>';
      }
      var hapusBtn = '<button onclick="deleteRiwayat(' + r.id + ')" title="Hapus riwayat ini" class="del-riwayat-btn"><i class="fas fa-trash"></i></button>';
      aksiHtml = '<div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;">' + perpanjangHtml + kembalikanBtn + hapusBtn + '</div>';
    } else {
      if (r.status === 'active' || r.status === 'borrow' || r.status === 'late') {
        aksiHtml = '<div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap;">' + perpanjangHtml + "<button class='action-link' onclick='showToast(\"Permintaan pengembalian dikirim ke petugas!\",\"success\")'>Kembalikan</button></div>";
      } else {
        aksiHtml = '<span style="color:var(--text3);font-size:11.5px;">—</span>';
      }
    }

    var dikembalikan = r.tglDikembalikan ? r.tglDikembalikan : '<span style="color:var(--orange);">Belum</span>';
    var dendaStr = r.denda > 0 ? 'Rp ' + r.denda.toLocaleString('id-ID') : 'Lunas';
    var dendaColor = r.denda > 0 ? 'var(--red)' : 'var(--green)';

    var tr = document.createElement('tr');
    tr.id = 'riwayat-row-' + r.id;
    // Tambahkan class pulse untuk baris terlambat
    if (r.status === 'late') tr.classList.add('row-late');
    tr.innerHTML =
      '<td><div class="book-cell"><div class="rt-thumb" style="background:' + b.bg + ';"><i class="' + b.icon + '"></i></div><div><div class="rt-title">' + b.title + '</div><div class="rt-author">' + b.author + '</div></div></div></td>' +
      '<td><div style="font-size:12px;font-weight:600;">' + (r.nama||'—') + '</div><div style="font-size:10.5px;color:var(--text3);">' + (r.nis||'') + '</div></td>' +
      '<td>' + r.tglPinjam + '</td>' +
      '<td>' + r.tglKembali + '</td>' +
      '<td>' + dikembalikan + '</td>' +
      '<td><span class="status-pill ' + st.cls + '">' + st.lbl + '</span></td>' +
      '<td style="font-weight:700;color:' + dendaColor + ';">' + dendaStr + '</td>' +
      '<td>' + aksiHtml + '</td>';
    tbody.appendChild(tr);
  });
}


function deleteRiwayat(rId) {
  if (!currentUser || currentUser.id !== 'admin') { showToast('Hanya admin yang bisa menghapus riwayat.','error'); return; }
  const r = RIWAYAT.find(x => x.id === rId); if (!r) return;
  const b = BOOKS.find(x => x.id === r.bookId);
  if (!confirm('Hapus riwayat peminjaman "' + (b ? b.title : 'buku ini') + '"?')) return;

  if ((r.status === 'active' || r.status === 'borrow') && b) b.stock++;

 const idx = RIWAYAT.findIndex(x => x.id === rId);
if (idx !== -1) {
    RIWAYAT.splice(idx, 1);
    saveRiwayat();
}
  const row = document.getElementById('riwayat-row-' + rId);
  if (row) {
    row.style.transition = '.3s';
    row.style.opacity = '0';
    row.style.transform = 'translateX(20px)';
    setTimeout(() => { renderRiwayat(); renderBooks(getFiltered()); renderDenda(); }, 320);
  } else {
    renderRiwayat(); renderBooks(getFiltered()); renderDenda();
  }
  showToast('Riwayat berhasil dihapus.', 'success');
}

/* ════ DENDA ════ */
function renderDenda() {
  // Sinkronkan status terlambat sebelum render denda
  checkAndUpdateLateStatus();

  const cont = document.getElementById('dendaCards');
  const noFine = document.getElementById('noFine');
  cont.innerHTML = '';
  noFine.style.display = 'none';
  const fines  = RIWAYAT.filter(r => r.denda>0);
  document.getElementById('tcDenda').textContent = fines.length;
  if (!fines.length) { noFine.style.display='flex'; return; }
  fines.forEach(r => {
    const b = BOOKS.find(x=>x.id===r.bookId);
    cont.innerHTML += `<div class="denda-card has-fine">
      <div class="dc-top">
        <div style="display:flex;gap:9px;align-items:flex-start;">
          <div class="dc-thumb" style="background:${b.bg};"><i class="${b.icon}"></i></div>
          <div><div class="dc-title">${b.title}</div><div class="dc-author">${b.author}</div></div>
        </div>
        <div class="dc-amount">Rp ${r.denda.toLocaleString('id-ID')}<small>Total Denda</small></div>
      </div>
      <div class="dc-row"><span class="dc-row-label">Tgl. Seharusnya</span><span class="dc-row-val">${r.tglKembali}</span></div>
      <div class="dc-row"><span class="dc-row-label">Tgl. Dikembalikan</span><span class="dc-row-val" style="color:var(--red);">${r.tglDikembalikan}</span></div>
      <div class="dc-row"><span class="dc-row-label">Keterlambatan</span><span class="dc-row-val" style="color:var(--red);">${r.denda/500} hari</span></div>
      <button class="dc-pay-btn" onclick="showToast('Konfirmasi pembayaran dikirim ke petugas!','success')">
        <i class="fas fa-credit-card"></i> Bayar Sekarang
      </button></div>`;
  });
}

/* ══════════════════════════════════════════════════
   ══ FITUR BARU: BANNER JATUH TEMPO ══
   ══════════════════════════════════════════════════ */
function showDueDateBanner() {
  if (!currentUser) return;
  // Perbarui status terlambat sebelum cek banner
  checkAndUpdateLateStatus();
  var banner = document.getElementById('reminderBanner');
  if (!banner) return;

  // Ambil peminjaman aktif milik user ini (termasuk yang terlambat)
  var myActive = RIWAYAT.filter(function(r){
    return r.nis === currentUser.nis && (r.status === 'active' || r.status === 'borrow' || r.status === 'late');
  });

  if (!myActive.length) {
    // Tidak ada peminjaman aktif — tampilkan pesan sambutan singkat
    banner.className = 'reminder-banner info-b';
    banner.style.display = 'flex';
    banner.innerHTML = '<i class="fas fa-info-circle"></i> Selamat datang, <strong style="margin:0 4px;">' + currentUser.name.split(' ')[0] + '</strong>! Tidak ada buku yang sedang dipinjam. <button class="rb-close" onclick="this.parentElement.style.display=\'none\'"><i class="fas fa-times"></i></button>';
    setTimeout(function(){ if(banner) banner.style.display = 'none'; }, 4000);
    return;
  }

  // Cek buku jatuh tempo paling dekat
  var today = new Date();
  today.setHours(0, 0, 0, 0);

  var earliestDays = Infinity;
  var earliestBook = null;

  myActive.forEach(function(r) {
    if (!r.tglKembaliRaw) return;
    var due = new Date(r.tglKembaliRaw);
    due.setHours(0, 0, 0, 0);
    var diff = Math.round((due - today) / 86400000);
    if (diff < earliestDays) {
      earliestDays = diff;
      earliestBook = r;
    }
  });

  if (earliestBook === null) {
    // Tidak ada tglKembaliRaw, tampilkan reminder umum
    banner.className = 'reminder-banner warn-b';
    banner.style.display = 'flex';
    banner.innerHTML = '<i class="fas fa-bell"></i> Anda memiliki <strong style="margin:0 4px;">' + myActive.length + ' buku</strong> yang sedang dipinjam. Jangan lupa kembalikan tepat waktu! <button class="rb-close" onclick="this.parentElement.style.display=\'none\'"><i class="fas fa-times"></i></button>';
    return;
  }

  var b = BOOKS.find(function(x){ return x.id === earliestBook.bookId; });
  var judulBuku = b ? b.title : 'buku Anda';

  var msg = '';
  var cls = '';

  if (earliestDays < 0) {
    // Sudah melewati jatuh tempo
    cls = 'urgent-b';
    msg = '🚨 <strong>Terlambat!</strong> "' + judulBuku + '" sudah melewati jatuh tempo <strong>' + Math.abs(earliestDays) + ' hari</strong>. Segera kembalikan untuk menghindari denda lebih lanjut!';
  } else if (earliestDays === 0) {
    // Jatuh tempo hari ini
    cls = 'urgent-b';
    msg = '⚠️ <strong>Jatuh tempo HARI INI!</strong> "' + judulBuku + '" harus dikembalikan hari ini sebelum perpustakaan tutup.';
  } else if (earliestDays === 1) {
    // Besok jatuh tempo
    cls = 'warn-b';
    msg = '⏰ Pengingat: "' + judulBuku + '" akan jatuh tempo <strong>besok</strong>. Segera siapkan untuk dikembalikan!';
  } else if (earliestDays === 2) {
    // 2 hari lagi
    cls = 'warn-b';
    msg = '📅 Pengingat: "' + judulBuku + '" akan jatuh tempo dalam <strong>2 hari</strong>. Jangan sampai terlambat!';
  } else {
    // Lebih dari 2 hari
    cls = 'info-b';
    msg = '📚 Anda memiliki <strong>' + myActive.length + ' buku</strong> yang sedang dipinjam. Tenggat terdekat: <strong>' + earliestDays + ' hari lagi</strong>.';
  }

  banner.className = 'reminder-banner ' + cls;
  banner.style.display = 'flex';
  banner.innerHTML = msg + ' <button class="rb-close" onclick="this.parentElement.style.display=\'none\'"><i class="fas fa-times"></i></button>';
}

/* ══════════════════════════════════════════════════
   ══ FITUR BARU: MODAL PERPANJANG ══
   ══════════════════════════════════════════════════ */

// Helper: tambah hari ke tanggal string "d MMM yyyy"
function addDaysToRiwayatDate(r, days) {
  // Gunakan tglKembaliRaw jika ada, kalau tidak parse dari string
  var baseDate;
  if (r.tglKembaliRaw) {
    baseDate = new Date(r.tglKembaliRaw);
  } else {
    // Fallback: coba parse dari tglKembali (format id-ID: "1 Jan 2025")
    baseDate = new Date(r.tglKembali);
  }
  if (isNaN(baseDate)) baseDate = new Date();
  baseDate.setDate(baseDate.getDate() + days);
  return baseDate;
}

function openPerpanjangModal(rId) {
  var r = RIWAYAT.find(function(x){ return x.id === rId; });
  if (!r) return;
  if (r.sudahDiperpanjang) { showToast('Peminjaman ini sudah pernah diperpanjang.', 'error'); return; }

  var b = BOOKS.find(function(x){ return x.id === r.bookId; });
  if (!b) return;

  perpanjangTargetId = rId;

  // Isi info buku
  document.getElementById('pmThumb').innerHTML = '<div style="width:36px;height:48px;border-radius:6px;background:' + b.bg + ';display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.7);font-size:1rem;"><i class="' + b.icon + '"></i></div>';
  document.getElementById('pmTitle').textContent = b.title;
  document.getElementById('pmAuthor').textContent = b.author;

  // Tenggat lama
  document.getElementById('pmOldDate').textContent = r.tglKembali;

  // Tenggat baru = +7 hari dari tenggat lama
  var newDate = addDaysToRiwayatDate(r, 7);
  var newDateStr = newDate.toLocaleDateString('id-ID', { day:'numeric', month:'short', year:'numeric' });
  document.getElementById('pmNewDate').textContent = newDateStr;

  // Simpan newDate string ke dataset untuk digunakan saat konfirmasi
  document.getElementById('perpanjangModalBg').dataset.newDate = newDateStr;
  document.getElementById('perpanjangModalBg').dataset.newDateRaw = newDate.toISOString().split('T')[0];

  document.getElementById('perpanjangModalBg').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closePerpanjangModal() {
  document.getElementById('perpanjangModalBg').classList.remove('open');
  document.body.style.overflow = '';
  perpanjangTargetId = null;
}

function konfirmasiPerpanjang() {
  if (!perpanjangTargetId) return;
  var r = RIWAYAT.find(function(x){ return x.id === perpanjangTargetId; });
  if (!r) { closePerpanjangModal(); return; }

  var newDateStr = document.getElementById('perpanjangModalBg').dataset.newDate;
  var newDateRaw = document.getElementById('perpanjangModalBg').dataset.newDateRaw;

  // Update data riwayat
 r.tglKembali = newDateStr;
  r.tglKembaliRaw = newDateRaw;
  r.sudahDiperpanjang = true;
  saveRiwayat(); 

  var b = BOOKS.find(function(x){ return x.id === r.bookId; });
  var judulBuku = b ? b.title : 'buku';

  closePerpanjangModal();
  renderRiwayat();
  // Refresh banner jatuh tempo setelah perpanjangan
  showDueDateBanner();

  showToast('✓ Peminjaman "' + judulBuku + '" berhasil diperpanjang hingga ' + newDateStr + '!', 'success');
}

/* ══ PANEL NOTIFIKASI ADMIN ══ */
function toggleNotifPanel() {
  if (!currentUser || currentUser.id !== 'admin') {
    showToast('Fitur ini hanya tersedia untuk Admin.', 'error');
    return;
  }
  const panel = document.getElementById('notifPanel');
  const isOpen = panel.classList.contains('open');
  if (!isOpen) {
    renderNotifPanel();
    panel.classList.add('open');
  } else {
    panel.classList.remove('open');
  }
}

document.addEventListener('click', function(e) {
  const wrapper = document.querySelector('.notif-panel-wrapper');
  if (wrapper && !wrapper.contains(e.target)) {
    document.getElementById('notifPanel').classList.remove('open');
  }
});

function updateBellBadge() {
  const count = pendingRequests.length;
  const badge = document.getElementById('bellCount');
  const npBadge = document.getElementById('npBadge');
  if (count > 0) {
    badge.style.display = 'flex';
    badge.textContent = count;
    const oldDot = document.getElementById('bellBtn').querySelector('.notif-dot');
    if (oldDot) oldDot.remove();
  } else {
    badge.style.display = 'none';
  }
  if (npBadge) npBadge.textContent = count;
}

function renderNotifPanel() {
  const body = document.getElementById('npBody');
  if (!pendingRequests.length) {
    body.innerHTML = '<div class="np-empty"><i class="fas fa-inbox"></i>Belum ada permintaan peminjaman masuk.</div>';
    return;
  }
  body.innerHTML = '';
  pendingRequests.forEach(req => {
    const item = document.createElement('div');
    item.className = 'np-item';
    item.id = 'req-' + req.id;
    item.innerHTML = `
      <div class="np-item-top">
        <div class="np-thumb" style="background:${req.bookBg};"><i class="${req.bookIcon}"></i></div>
        <div class="np-info">
          <div class="np-book">${req.bookTitle}</div>
          <div class="np-user"><i class="fas fa-user" style="font-size:9px;"></i> ${req.nama} · ${req.kelas}</div>
          <div class="np-dates"><i class="fas fa-calendar" style="font-size:9px;"></i> ${req.tglPinjam} → ${req.tglKembali}</div>
          ${req.catatan ? `<div style="font-size:10.5px;color:var(--text3);margin-top:2px;font-style:italic;">"${req.catatan}"</div>` : ''}
        </div>
        <div class="np-time">${req.waktuAjukan}</div>
      </div>
      <div class="np-actions">
        <button class="np-btn approve" onclick="approveRequest(${req.id})">
          <i class="fas fa-check"></i> Setujui
        </button>
        <button class="np-btn reject" onclick="rejectRequest(${req.id})">
          <i class="fas fa-times"></i> Tolak
        </button>
      </div>`;
    body.appendChild(item);
  });
}

async function approveRequest(reqId) {
  const req = pendingRequests.find(r => r.id === reqId);
  if (!req) return;

  const book = BOOKS.find(b => b.id === req.bookId);
  if (book && book.stock > 0) book.stock--;

  RIWAYAT.push({
    id: reqId,
    bookId: req.bookId,
    nama: req.nama,
    nis: req.nis,
    kelas: req.kelas,
    tglPinjam: req.tglPinjam,
    tglKembali: req.tglKembali,
    tglKembaliRaw: req.tglKembaliRaw || null,
    tglDikembalikan: null,
    status: 'active',
    denda: 0,
    sudahDiperpanjang: false, // ← flag perpanjang
  });

 pendingRequests = pendingRequests.filter(r => r.id !== reqId);
stopPolling();
await savePending();
await saveRiwayat();
setTimeout(() => startPolling(), 3000);

  const el = document.getElementById('req-' + reqId);
  if (el) { el.style.opacity='0'; el.style.transform='translateX(20px)'; el.style.transition='.3s'; setTimeout(()=>el.remove(), 300); }

  updateBellBadge();
  renderRiwayat();
  renderBooks(getFiltered());

  showToast(`✓ Peminjaman "${req.bookTitle}" oleh ${req.nama} disetujui!`, 'success');

  if (!pendingRequests.length) {
    setTimeout(() => {
      document.getElementById('npBody').innerHTML = '<div class="np-empty"><i class="fas fa-inbox"></i>Semua permintaan sudah diproses.</div>';
    }, 350);
  }
}

async function rejectRequest(reqId) {
  const req = pendingRequests.find(r => r.id === reqId);
  if (!req) return;

  const idx = RIWAYAT.findIndex(r => r.id === reqId);
 if (idx !== -1) {
    RIWAYAT.splice(idx, 1);
    saveRiwayat();  // ← TAMBAH
  }

 pendingRequests = pendingRequests.filter(r => r.id !== reqId);
stopPolling();
await savePending();
setTimeout(() => startPolling(), 3000);

  const el = document.getElementById('req-' + reqId);
  if (el) { el.style.opacity='0'; el.style.transform='translateX(-20px)'; el.style.transition='.3s'; setTimeout(()=>el.remove(), 300); }

  updateBellBadge();
  renderRiwayat();

  showToast(`✗ Peminjaman "${req.bookTitle}" oleh ${req.nama} ditolak.`, 'error');

  if (!pendingRequests.length) {
    setTimeout(() => {
      document.getElementById('npBody').innerHTML = '<div class="np-empty"><i class="fas fa-inbox"></i>Semua permintaan sudah diproses.</div>';
    }, 350);
  }
}

/* ════ TOAST ════ */
let toastTimer;
function showToast(msg, type='success') {
  clearTimeout(toastTimer);
  const t = document.getElementById('toast');
  document.getElementById('toastMsg').textContent = msg;
  t.className = 'toast '+type+' show';
  toastTimer  = setTimeout(() => t.classList.remove('show'), 3500);
}

document.getElementById('loginPass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
document.getElementById('loginNis').addEventListener('keydown',  e => { if(e.key==='Enter') doLogin(); });


/* ════ DARK MODE ════ */
var isDark = false;
function toggleTheme() {
  isDark = !isDark;
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  var ico = document.getElementById('themeIcon');
  if (ico) ico.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}

/* ════ REMINDER BANNER (legacy, masih dipakai di beberapa tempat) ════ */
function showReminderBanner() {
  showDueDateBanner();
}

function loadProfilFields(acc) {
  var setVal = function(id, v){ var el = document.getElementById(id); if(el) el.value = v || ''; };
  setVal('profNama', acc.name);
  setVal('profNis', acc.nis);
  setVal('profKelas', acc.kelas || '');
  setVal('profHp', acc.hp || '');
  setVal('profEmail', acc.email || '');
}

function renderProfil() {
  if (!currentUser) return;
  var u = currentUser;
 var setEl = function(id, v){ 
  var el = document.getElementById(id); 
  if(el) { 
    if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = v||''; 
    else el.textContent = v||''; 
  }
};
  
  // Load foto dari localStorage
  if (!u.avatarPhoto) {
    var savedPhoto = localStorage.getItem('avatarPhoto_' + u.nis);
    if (savedPhoto) u.avatarPhoto = savedPhoto;
  }

  // Avatar
  var av = document.getElementById('mcAvatar');
  if (av) {
    if (u.avatarPhoto) {
      av.classList.add('has-photo');
      av.innerHTML = '<img src="' + u.avatarPhoto + '" alt="Foto Profil" style="width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;">';
    } else {
      av.classList.remove('has-photo');
      av.innerHTML = u.avatar;
      av.style.background = u.color;
    }
  }

  // ← LANJUTKAN di sini (masih di DALAM fungsi)
  setEl('mcName', u.name);
  setEl('mcRoleText', u.role);
  setEl('mcNis', u.nis);
  setEl('mcRoleVal', u.role);
  loadProfilFields(u);

  // Barcode
  var barcodeEl = document.getElementById('mcBarcode');
  if (barcodeEl) {
    barcodeEl.innerHTML = '';
    var widths = [2,1,3,1,2,1,1,2,3,1,2,1,3,2,1,2,1,3,2,1,1,3,2,1,2,1];
    widths.forEach(function(w, i) {
      var bar = document.createElement('div');
      bar.className = 'mc-bar';
      bar.style.width = w + 'px';
      bar.style.height = (i%3===0?28:i%3===1?22:16) + 'px';
      barcodeEl.appendChild(bar);
    });
  }
  var bn = document.getElementById('mcBarcodeNum');
  if (bn) bn.textContent = u.nis.replace(/\D/g,'').padEnd(12,'0').substring(0,12);

  // Statistik
  var myRiwayat = RIWAYAT.filter(function(r){ return r.nis === u.nis; });
  var myActive  = myRiwayat.filter(function(r){ return r.status==='active'||r.status==='borrow'; });
  var myDenda   = myRiwayat.filter(function(r){ return r.denda > 0; });
  // Stats dengan animasi count-up
animateCountUp('psTotal',  myRiwayat.length, 0);
animateCountUp('psActive', myActive.length,  120);
animateCountUp('psDenda',  myDenda.length,   240);

// Stagger delay untuk ps-item
document.querySelectorAll('.ps-item').forEach(function(el, i) {
  el.style.animationDelay = (i * 120) + 'ms';
  el.classList.remove('statPop');
  void el.offsetWidth;
});
} // ← TUTUP renderProfil di SINI

function saveProfil() {
  if (!currentUser) return;
  var nm = document.getElementById('profNama'); if (nm) currentUser.name = nm.value || currentUser.name;
  var kl = document.getElementById('profKelas'); if (kl) currentUser.kelas = kl.value;
  var hp = document.getElementById('profHp');   if (hp) currentUser.hp    = hp.value;
  var em = document.getElementById('profEmail'); if (em) currentUser.email = em.value;
  var nn = document.getElementById('navName'); if (nn) nn.textContent = currentUser.name.split(' ')[0];
  var dn = document.getElementById('ddName');  if (dn) dn.textContent = currentUser.name;
  var de = document.getElementById('ddEmail'); if (de) de.textContent = currentUser.email;
  renderProfil();
  showToast('Profil berhasil disimpan!', 'success');
}

function changePassword() {
  var lama = document.getElementById('passLama');
  var baru = document.getElementById('passBaru');
  var konfirm = document.getElementById('passKonfirm');
  if (!lama || !baru || !konfirm) return;
  if (!lama.value || !baru.value || !konfirm.value) { showToast('Semua field wajib diisi.','error'); return; }
  if (lama.value !== currentUser.pass) { showToast('Kata sandi lama salah.','error'); return; }
  if (baru.value !== konfirm.value) { showToast('Konfirmasi sandi tidak cocok.','error'); return; }
  if (baru.value.length < 6) { showToast('Sandi baru minimal 6 karakter.','error'); return; }
  currentUser.pass = baru.value;
  lama.value = ''; baru.value = ''; konfirm.value = '';
  showToast('Kata sandi berhasil diubah!', 'success');
}

/* ════ DASHBOARD ════ */
var currentChartView = 'monthly';

function switchChartView(view, btn) {
  currentChartView = view;
  document.querySelectorAll('.chart-tab').forEach(function(b){ b.classList.remove('on'); });
  if (btn) btn.classList.add('on');
  var mw = document.getElementById('monthlyChartWrap');
  var bw = document.getElementById('bookChartWrap');
  if (view === 'monthly') { if(mw) mw.style.display='block'; if(bw) bw.style.display='none'; renderMonthlyChart(); }
  else                    { if(mw) mw.style.display='none'; if(bw) bw.style.display='block'; renderBookChart(); }
}

function renderMonthlyChart() {
  var el = document.getElementById('monthlyChartBars'); if (!el) return;
  el.innerHTML = '';

  var today = new Date();
  var months = [];
  for (var i = 11; i >= 0; i--) {
    var d = new Date(today.getFullYear(), today.getMonth() - i, 1);
    months.push({ year:d.getFullYear(), month:d.getMonth(), label:d.toLocaleDateString('id-ID',{month:'short'}), count:0, late:0 });
  }

  RIWAYAT.forEach(function(r) {
    if (!r.tglKembaliRaw && !r.tglPinjam) return;
    // Parse dari tglPinjam (format "1 Jan 2025")
    var d;
    try { d = new Date(r.tglPinjam); } catch(e) { return; }
    if (isNaN(d)) return;
    months.forEach(function(m) {
      if (d.getFullYear() === m.year && d.getMonth() === m.month) {
        m.count++;
        if (r.status === 'late') m.late++;
      }
    });
  });

  var maxVal = Math.max.apply(null, months.map(function(m){ return m.count; })) || 1;

  months.forEach(function(m) {
    var col = document.createElement('div');
    col.className = 'mc-bar-col';
    var pct = Math.round(m.count / maxVal * 100);
    var latePct = m.count > 0 ? Math.round(m.late / maxVal * 100) : 0;
    var minH = m.count > 0 ? 6 : 0;
    col.innerHTML =
      '<div class="mc-bar-val">' + (m.count > 0 ? m.count : '') + '</div>' +
      '<div class="mc-bar-fill" style="height:' + Math.max(pct, minH) + 'px;" data-tip="' + m.count + ' pinjam, ' + m.late + ' terlambat · ' + m.label + '"></div>' +
      (m.late > 0 ? '<div class="mc-bar-fill late-fill" style="height:' + Math.max(latePct, 4) + 'px;" data-tip="' + m.late + ' terlambat · ' + m.label + '"></div>' : '') +
      '<div class="mc-bar-label">' + m.label + '</div>';
    el.appendChild(col);
  });
}

function renderBookChart() {
  var chartEl = document.getElementById('chartBars');
  if (!chartEl) return;
  chartEl.innerHTML = '';
  var borrowCount = {};
  RIWAYAT.forEach(function(r){ borrowCount[r.bookId] = (borrowCount[r.bookId]||0) + 1; });
  var topBooks = BOOKS.map(function(b){ return { b:b, count:borrowCount[b.id]||0 }; })
    .sort(function(a,b){ return b.count - a.count; }).slice(0,6);
  var maxCount = topBooks[0] ? topBooks[0].count : 1;
  if (!topBooks[0] || topBooks[0].count === 0) {
    chartEl.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text3);font-size:13px;">Belum ada data peminjaman.</div>';
    return;
  }
  topBooks.forEach(function(item) {
    var pct = maxCount > 0 ? Math.round(item.count / maxCount * 100) : 0;
    var row = document.createElement('div');
    row.className = 'chart-bar-item';
    row.innerHTML = '<div class="cbi-label" title="' + item.b.title + '">' + item.b.title + '</div>' +
      '<div class="cbi-bar-bg"><div class="cbi-bar" data-w="' + pct + '" style="width:0;"></div></div>' +
      '<div class="cbi-val">' + item.count + '</div>';
    chartEl.appendChild(row);
  });
  setTimeout(function() {
    chartEl.querySelectorAll('.cbi-bar').forEach(function(bar) {
      bar.style.width = bar.getAttribute('data-w') + '%';
    });
  }, 80);
}

function renderDashboard() {
  var statGrid = document.getElementById('dashStatGrid');
  if (!statGrid) return;
  checkAndUpdateLateStatus();
  var totalBuku  = BOOKS.length;
  var totalStok  = BOOKS.reduce(function(s,b){ return s+b.total; }, 0);
  var tersedia   = BOOKS.filter(function(b){ return b.stock > 0; }).length;
  var dipinjam   = RIWAYAT.filter(function(r){ return r.status==='active'||r.status==='borrow'||r.status==='late'; }).length;
  var terlambat  = RIWAYAT.filter(function(r){ return r.status==='late'; }).length;
  var pending    = pendingRequests.length;
  var totalDenda = RIWAYAT.reduce(function(s,r){ return s+r.denda; }, 0);

  var stats = [
    { ico:'fas fa-book',             bg:'rgba(59,124,244,.12)',  clr:'var(--blue)',   val:totalBuku,  lbl:'Total Judul Buku' },
    { ico:'fas fa-check-circle',     bg:'rgba(22,163,74,.12)',   clr:'var(--green)',  val:tersedia,   lbl:'Judul Tersedia' },
    { ico:'fas fa-hand-holding-heart',bg:'rgba(234,88,12,.12)', clr:'var(--orange)', val:dipinjam,   lbl:'Sedang Dipinjam' },
    { ico:'fas fa-clock',            bg:'rgba(245,158,11,.12)',  clr:'var(--gold)',   val:pending,    lbl:'Menunggu Approval' },
    { ico:'fas fa-receipt',          bg:'rgba(220,38,38,.12)',   clr:'var(--red)',    val:'Rp '+(totalDenda/1000).toFixed(0)+'rb', lbl:'Total Denda' },
    { ico:'fas fa-exclamation-triangle',bg:'rgba(220,38,38,.12)',clr:'var(--red)',    val:terlambat,  lbl:'Buku Terlambat' },
  ];

  statGrid.innerHTML = '';
  stats.forEach(function(s, i) {
    var d = document.createElement('div');
    d.className = 'dash-stat';
    d.style.animationDelay = (i * 60) + 'ms';
    d.innerHTML = '<div class="ds-icon" style="background:' + s.bg + ';color:' + s.clr + ';"><i class="' + s.ico + '"></i></div><div><div class="ds-val">' + s.val + '</div><div class="ds-label">' + s.lbl + '</div></div>';
    statGrid.appendChild(d);
  });

  // Render chart sesuai view aktif
  if (currentChartView === 'monthly') renderMonthlyChart();
  else renderBookChart();

  var recentEl = document.getElementById('recentList');
  if (recentEl) {
    recentEl.innerHTML = '';
    var recent = RIWAYAT.slice().reverse().slice(0,5);
    if (!recent.length) {
      recentEl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text3);font-size:13px;">Belum ada riwayat.</div>';
    } else {
      recent.forEach(function(r) {
        var b = BOOKS.find(function(x){ return x.id===r.bookId; }); if (!b) return;
        var stCls = r.status==='active'?'sp-active':r.status==='late'?'sp-late':r.status==='borrow'?'sp-borrow':'sp-done';
        var stLbl = r.status==='active'?'Aktif':r.status==='late'?'Terlambat':r.status==='borrow'?'Dipinjam':'Selesai';
        var item = document.createElement('div'); item.className = 'rl-item';
        item.innerHTML = '<div class="rl-thumb" style="background:' + b.bg + ';"><i class="' + b.icon + '"></i></div>' +
          '<div class="rl-info"><div class="rl-title">' + b.title + '</div><div class="rl-sub">' + (r.nama||'—') + ' · ' + r.tglPinjam + '</div></div>' +
          '<span class="rl-badge status-pill ' + stCls + '">' + stLbl + '</span>';
        recentEl.appendChild(item);
      });
    }
  }

  var lowEl = document.getElementById('lowStockList');
  if (lowEl) {
    var lowBooks = BOOKS.filter(function(b){ return b.stock <= 1; }).sort(function(a,b){ return a.stock-b.stock; }).slice(0,5);
    if (!lowBooks.length) {
      lowEl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--green);font-size:13px;"><i class="fas fa-check-circle"></i> Semua stok aman!</div>';
    } else {
      lowEl.innerHTML = '';
      lowBooks.forEach(function(b) {
        var clr = b.stock===0?'var(--red)':'var(--orange)';
        var item = document.createElement('div'); item.className = 'rl-item';
        item.innerHTML = '<div class="rl-thumb" style="background:' + b.bg + ';"><i class="' + b.icon + '"></i></div>' +
          '<div class="rl-info"><div class="rl-title">' + b.title + '</div><div class="rl-sub">' + b.cat + ' · ' + b.author + '</div></div>' +
          '<span style="font-size:11px;font-weight:700;color:' + clr + ';">' + (b.stock===0?'Habis':b.stock+' tersisa') + '</span>';
        lowEl.appendChild(item);
      });
    }
  }

  var activeEl = document.getElementById('activeLoans');
  if (activeEl) {
    var actives = RIWAYAT.filter(function(r){ return r.status==='active'||r.status==='borrow'; }).slice(0,5);
    if (!actives.length) {
      activeEl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text3);font-size:13px;">Tidak ada peminjaman aktif.</div>';
    } else {
      activeEl.innerHTML = '';
      actives.forEach(function(r) {
        var b = BOOKS.find(function(x){ return x.id===r.bookId; }); if (!b) return;
        var item = document.createElement('div'); item.className = 'rl-item';
        item.innerHTML = '<div class="rl-thumb" style="background:' + b.bg + ';"><i class="' + b.icon + '"></i></div>' +
          '<div class="rl-info"><div class="rl-title">' + (r.nama||'—') + '</div><div class="rl-sub">' + b.title + ' · Kembali: ' + r.tglKembali + '</div></div>' +
          '<span class="status-pill sp-active">Aktif</span>';
        activeEl.appendChild(item);
      });
    }
  }

  var lateEl = document.getElementById('lateLoans');
  if (lateEl) {
    var lates = RIWAYAT.filter(function(r){ return r.status==='late'; }).slice(0,5);
    if (!lates.length) {
      lateEl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--green);font-size:13px;"><i class="fas fa-check-circle"></i> Tidak ada keterlambatan!</div>';
    } else {
      lateEl.innerHTML = '';
      lates.forEach(function(r) {
        var b = BOOKS.find(function(x){ return x.id===r.bookId; }); if (!b) return;
        var item = document.createElement('div'); item.className = 'rl-item';
        item.innerHTML = '<div class="rl-thumb" style="background:' + b.bg + ';"><i class="' + b.icon + '"></i></div>' +
          '<div class="rl-info"><div class="rl-title">' + (r.nama||'—') + '</div><div class="rl-sub">' + b.title + ' · Denda: Rp ' + r.denda.toLocaleString('id-ID') + '</div></div>' +
          '<span class="status-pill sp-late">Terlambat</span>';
        lateEl.appendChild(item);
      });
    }
  }
}

/* ════════════════════════════════════════════════
   EXPORT EXCEL
════════════════════════════════════════════════ */
function exportExcel() {
  if (!currentUser) { showToast('Login terlebih dahulu.','error'); return; }
  checkAndUpdateLateStatus();

var isAdmin = currentUser && currentUser.id === 'admin';
var list = isAdmin
  ? RIWAYAT
  : RIWAYAT.filter(function(r){ return r.nis === currentUser.nis; });
  if (!list.length) { showToast('Tidak ada data riwayat untuk diekspor.','info'); return; }

  var bulan = new Date().toLocaleDateString('id-ID',{month:'long',year:'numeric'});
  var rows = [['No','Nama Peminjam','NIS/NIP','Judul Buku','Pengarang','Tgl. Pinjam','Tgl. Kembali','Status','Denda (Rp)']];

  list.forEach(function(r, i) {
    var b = BOOKS.find(function(x){ return x.id===r.bookId; });
    var stLbl = r.status==='active'?'Aktif':r.status==='late'?'Terlambat':r.status==='borrow'?'Dipinjam':'Selesai';
    rows.push([
      i+1,
      r.nama||'—',
      r.nis||'—',
      b ? b.title : '—',
      b ? b.author : '—',
      r.tglPinjam||'—',
      r.tglKembali||'—',
      stLbl,
      r.denda||0,
    ]);
  });

  var ws = XLSX.utils.aoa_to_sheet(rows);
  // Lebar kolom
  ws['!cols'] = [{wch:4},{wch:22},{wch:20},{wch:30},{wch:20},{wch:14},{wch:14},{wch:12},{wch:12}];
  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Riwayat Peminjaman');
  XLSX.writeFile(wb, 'Rekap_Perpustakaan_' + bulan.replace(' ','_') + '.xlsx');
  showToast('✓ File Excel berhasil diunduh!', 'success');
}

/* ════════════════════════════════════════════════
   EXPORT PDF
════════════════════════════════════════════════ */
function exportPDF() {
  if (!currentUser) { showToast('Login terlebih dahulu.','error'); return; }
  checkAndUpdateLateStatus();

  var isAdmin = currentUser && currentUser.id === 'admin'; // ← TAMBAHAN INI

  var list = isAdmin
    ? RIWAYAT
    : RIWAYAT.filter(function(r){ return r.nis === currentUser.nis; });

  if (!list.length) { showToast('Tidak ada data riwayat untuk diekspor.','info'); return; }

  var { jsPDF } = window.jspdf;
  var doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });

  var bulan = new Date().toLocaleDateString('id-ID',{month:'long',year:'numeric'});

  // Header
  doc.setFillColor(15, 27, 53);
  doc.rect(0, 0, 297, 20, 'F');
  doc.setTextColor(255,255,255);
  doc.setFontSize(13); doc.setFont('helvetica','bold');
  doc.text('PERPUSTAKAAN SMKN 1 KETAPANG', 14, 9);
  doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.text('Rekap Peminjaman Buku — ' + bulan, 14, 15);
  doc.text('Dicetak: ' + new Date().toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'}), 297-14, 15, {align:'right'});

  var rows = list.map(function(r, i) {
    var b = BOOKS.find(function(x){ return x.id===r.bookId; });
    var stLbl = r.status==='active'?'Aktif':r.status==='late'?'Terlambat':r.status==='borrow'?'Dipinjam':'Selesai';
    return [
      i+1,
      r.nama||'—',
      r.nis||'—',
      b ? b.title : '—',
      r.tglPinjam||'—',
      r.tglKembali||'—',
      stLbl,
      r.denda > 0 ? 'Rp '+r.denda.toLocaleString('id-ID') : 'Lunas',
    ];
  });

  doc.autoTable({
    startY: 24,
    head: [['No','Nama Peminjam','NIS/NIP','Judul Buku','Tgl. Pinjam','Tgl. Kembali','Status','Denda']],
    body: rows,
    theme: 'grid',
    headStyles: { fillColor:[59,124,244], textColor:255, fontStyle:'bold', fontSize:9 },
    bodyStyles: { fontSize:8.5 },
    alternateRowStyles: { fillColor:[244,246,251] },
    columnStyles: { 0:{halign:'center',cellWidth:10}, 6:{halign:'center'}, 7:{halign:'right'} },
    didParseCell: function(data) {
      if (data.section === 'body' && data.column.index === 6) {
        var val = data.cell.raw;
        if (val === 'Terlambat') data.cell.styles.textColor = [220,38,38];
        else if (val === 'Aktif') data.cell.styles.textColor = [22,163,74];
      }
    },
    margin: { left:14, right:14 },
  });

  // Footer
  var pageCount = doc.internal.getNumberOfPages();
  for (var i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8); doc.setTextColor(150);
    doc.text('Halaman ' + i + ' dari ' + pageCount, 297/2, 205, {align:'center'});
  }

  doc.save('Rekap_Perpustakaan_' + bulan.replace(' ','_') + '.pdf');
  showToast('✓ File PDF berhasil diunduh!', 'success');
}
/* ════════════════════════════════════════════════
   AVATAR UPLOAD
════════════════════════════════════════════════ */
function handleAvatarUpload(event) {
  var file = event.target.files[0];
  if (!file) return;
  if (!file.type.startsWith('image/')) { showToast('Pilih file gambar (JPG/PNG/WebP).','error'); return; }
  if (file.size > 2 * 1024 * 1024) { showToast('Ukuran foto maks. 2 MB.','error'); return; }

  var reader = new FileReader();
  reader.onload = function(e) {
    var dataUrl = e.target.result;

    // 1. Simpan ke currentUser
    if (currentUser) currentUser.avatarPhoto = dataUrl;

    // 2. SIMPAN KE LOCALSTORAGE agar tidak hilang saat refresh
    if (currentUser) {
      localStorage.setItem('avatarPhoto_' + currentUser.nis, dataUrl);
    }

    // 3. Update kartu member (kiri)
    var avEl = document.getElementById('mcAvatar');
    if (avEl) {
      avEl.classList.add('has-photo');
      avEl.innerHTML = '<img src="' + dataUrl + '" alt="Foto Profil" style="width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;animation:none!important;transform:none!important;">';
    }

    // 4. Update navbar avatar (pojok kanan atas)
    var navAv = document.getElementById('navAvatar');
    if (navAv) {
      navAv.textContent = '';
      navAv.style.background = 'none';
      navAv.style.padding = '0';
      navAv.style.overflow = 'hidden';
      var navImg = document.createElement('img');
      navImg.src = dataUrl;
      navImg.alt = 'Avatar';
      navImg.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;';
      navAv.appendChild(navImg);
    }

    // 5. Update kartu cetak
    var pcaAv = document.getElementById('pcaAvatar');
    if (pcaAv) {
      pcaAv.innerHTML = '<img src="' + dataUrl + '" alt="Foto" style="width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;">';
    }

    showToast('✓ Foto profil berhasil disimpan permanen!', 'success');
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

/* ════════════════════════════════════════════════
   CETAK KARTU ANGGOTA
════════════════════════════════════════════════ */
function cetakKartuAnggota() {
  if (!currentUser) return;
  var u = currentUser;

  // Isi data
  var pcaName = document.getElementById('pcaName'); if(pcaName) pcaName.textContent = u.name;
  var pcaNis  = document.getElementById('pcaNis');  if(pcaNis)  pcaNis.textContent  = (u.id==='siswa'?'NIS: ':'NIP: ') + u.nis;
  var pcaRole = document.getElementById('pcaRole'); if(pcaRole) pcaRole.textContent = u.role;
  var pcaNum  = document.getElementById('pcaBarcodeNum'); if(pcaNum) pcaNum.textContent = u.nis.replace(/\D/g,'').padEnd(12,'0').substring(0,12);

  // Avatar
  var pcaAv = document.getElementById('pcaAvatar');
  if (pcaAv) {
    if (u.avatarPhoto) {
      pcaAv.innerHTML = '<img src="'+u.avatarPhoto+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    } else {
      pcaAv.textContent = u.avatar;
      pcaAv.style.background = u.color;
    }
  }

  // Barcode
  var bcEl = document.getElementById('pcaBarcode');
  if (bcEl) {
    bcEl.innerHTML = '';
    [2,1,3,1,2,1,1,2,3,1,2,1,3,2,1,2,1].forEach(function(w,i){
      var bar = document.createElement('div');
      bar.className = 'pca-bar';
      bar.style.width = w+'px';
      bar.style.height = (i%2===0?14:10)+'px';
      bcEl.appendChild(bar);
    });
  }

  // Tampilkan area cetak
  var area = document.getElementById('printCardArea');
  if (area) area.style.display = 'block';

  // Tunggu render lalu print
  setTimeout(function() {
    window.print();
    setTimeout(function() {
      if (area) area.style.display = 'none';
    }, 1000);
  }, 300);
}

/* ════ MANAJEMEN BUKU ════ */
var bookIdCounter = 200;

function renderManajemen() {
  var tbody = document.getElementById('mgmtBody'); if (!tbody) return;
  var q = (document.getElementById('mgmtSearch') ? document.getElementById('mgmtSearch').value.toLowerCase() : '');
  var list = BOOKS.filter(function(b){ return !q || b.title.toLowerCase().indexOf(q) !== -1 || b.author.toLowerCase().indexOf(q) !== -1; });
  tbody.innerHTML = '';
  list.forEach(function(b, i) {
    var sc = b.stock===0 ? 'var(--red)' : b.stock<=1 ? 'var(--orange)' : 'var(--green)';
    var tr = document.createElement('tr');
    tr.innerHTML = '<td>' + (i+1) + '</td>' +
      '<td><div style="display:flex;align-items:center;gap:8px;"><div style="width:22px;height:28px;border-radius:4px;background:' + b.bg + ';display:flex;align-items:center;justify-content:center;flex-shrink:0;"><i class="' + b.icon + '" style="font-size:9px;color:rgba(255,255,255,.8);"></i></div><div><div style="font-weight:600;font-size:12.5px;">' + b.title + '</div><div style="font-size:10.5px;color:var(--text3);">' + b.pub + '</div></div></div></td>' +
      '<td>' + b.author + '</td>' +
      '<td><span style="font-size:10.5px;font-weight:700;padding:2px 8px;border-radius:20px;background:var(--bg2);color:var(--text2);">' + b.cat + '</span></td>' +
      '<td>' + b.year + '</td>' +
      '<td><span style="font-weight:700;color:' + sc + ';">' + b.stock + '</span></td>' +
      '<td>' + b.total + '</td>' +
      '<td><div style="display:flex;gap:5px;">' +
        '<button class="tbl-btn edit" onclick="openEditBook(' + b.id + ')" title="Edit"><i class="fas fa-edit"></i></button>' +
        '<button class="tbl-btn del" onclick="deleteBook(' + b.id + ')" title="Hapus"><i class="fas fa-trash"></i></button>' +
      '</div></td>';
    tbody.appendChild(tr);
  });
  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text3);">Tidak ada buku ditemukan.</td></tr>';
  }
}

function openAddBook() {
  document.getElementById('bookFormTitle').innerHTML = '<i class="fas fa-plus"></i> Tambah Buku Baru';
  document.getElementById('bfId').value = '';
  var clearIds = ['bfTitle','bfAuthor','bfPub','bfYear','bfPages','bfStock','bfTotal','bfDesc'];
  clearIds.forEach(function(id){ var el = document.getElementById(id); if(el) el.value = ''; });
  document.getElementById('bookFormBg').classList.add('open');
}

function openEditBook(id) {
  var b = BOOKS.find(function(x){ return x.id === id; }); if (!b) return;
  document.getElementById('bookFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Buku';
  document.getElementById('bfId').value    = b.id;
  document.getElementById('bfTitle').value = b.title;
  document.getElementById('bfAuthor').value = b.author;
  document.getElementById('bfPub').value   = b.pub;
  document.getElementById('bfYear').value  = b.year;
  document.getElementById('bfPages').value = b.pages;
  document.getElementById('bfCat').value   = b.cat;
  document.getElementById('bfStock').value = b.stock;
  document.getElementById('bfTotal').value = b.total;
  document.getElementById('bfDesc').value  = b.desc;
  document.getElementById('bookFormBg').classList.add('open');
}

function closeBookForm() {
  document.getElementById('bookFormBg').classList.remove('open');
}

function saveBook() {
  var title  = document.getElementById('bfTitle').value.trim();
  var author = document.getElementById('bfAuthor').value.trim();
  var cat    = document.getElementById('bfCat').value;
  var stock  = parseInt(document.getElementById('bfStock').value) || 0;
  var total  = parseInt(document.getElementById('bfTotal').value) || stock;
  if (!title)  { showToast('Judul buku wajib diisi.','error'); return; }
  if (!author) { showToast('Pengarang wajib diisi.','error'); return; }

  var icons = { Pelajaran:'fas fa-graduation-cap', Fiksi:'fas fa-feather', NonFiksi:'fas fa-globe', Referensi:'fas fa-book-open' };
  var bgs   = { Pelajaran:'linear-gradient(140deg,#1d4ed8,#1e40af)', Fiksi:'linear-gradient(140deg,#7c3aed,#6d28d9)', NonFiksi:'linear-gradient(140deg,#111827,#1f2937)', Referensi:'linear-gradient(140deg,#0891b2,#0e7490)' };
  var catKey = cat.replace('-','');
  var existingId = document.getElementById('bfId').value;

  if (existingId) {
    var b = BOOKS.find(function(x){ return x.id === parseInt(existingId); });
    if (b) {
      b.title  = title; b.author = author; b.cat = cat;
      b.pub    = document.getElementById('bfPub').value.trim() || b.pub;
      b.year   = parseInt(document.getElementById('bfYear').value) || b.year;
      b.pages  = parseInt(document.getElementById('bfPages').value) || b.pages;
      b.stock  = stock; b.total = total;
      b.desc   = document.getElementById('bfDesc').value.trim() || b.desc;
      showToast('Buku "' + title + '" berhasil diperbarui!', 'success');
    }
  } else {
    BOOKS.push({
      id: ++bookIdCounter,
      title: title, author: author, cat: cat,
      pub:   document.getElementById('bfPub').value.trim() || '—',
      year:  parseInt(document.getElementById('bfYear').value) || new Date().getFullYear(),
      pages: parseInt(document.getElementById('bfPages').value) || 0,
      icon:  icons[catKey] || 'fas fa-book',
      bg:    bgs[catKey]   || 'linear-gradient(140deg,#374151,#1f2937)',
      stock: stock, total: total,
      desc:  document.getElementById('bfDesc').value.trim() || 'Deskripsi belum tersedia.',
      isbn: '',
    });
    showToast('Buku "' + title + '" berhasil ditambahkan!', 'success');
  }
  closeBookForm();
  renderManajemen();
  renderBooks(getFiltered());
  updateHeroStats();
}

function deleteBook(id) {
  var b = BOOKS.find(function(x){ return x.id===id; }); if (!b) return;
  if (!confirm('Hapus buku "' + b.title + '" dari koleksi?')) return;
  var idx = BOOKS.findIndex(function(x){ return x.id===id; });
  if (idx !== -1) BOOKS.splice(idx, 1);
  renderManajemen();
  renderBooks(getFiltered());
  updateHeroStats();
  showToast('Buku "' + b.title + '" dihapus.', 'success');
}

function updateHeroStats() {
  var sT = document.getElementById('sTotal'); if(sT) sT.textContent = BOOKS.length;
  var sA = document.getElementById('sAvail'); if(sA) sA.textContent = BOOKS.filter(function(b){ return b.stock>0; }).length;
  var sC = document.getElementById('sCat');   if(sC) sC.textContent = [...new Set(BOOKS.map(function(b){ return b.cat; }))].length;
  var sAc= document.getElementById('sActive'); if(sAc) sAc.textContent = RIWAYAT.filter(function(r){ return r.status==='active'||r.status==='borrow'; }).length;
  var tcK= document.getElementById('tcKoleksi'); if(tcK) tcK.textContent = BOOKS.length;
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') { closeBookForm(); }
});

</script>

<!-- MODAL TAMBAH/EDIT BUKU -->
<div class="modal-backdrop" id="bookFormBg" onclick="if(event.target===this)closeBookForm()">
  <div class="modal fmodal">
    <div class="fmodal-header">
      <div class="fmodal-title" id="bookFormTitle"><i class="fas fa-book"></i> Tambah Buku Baru</div>
      <button class="fmodal-close" onclick="closeBookForm()"><i class="fas fa-times"></i></button>
    </div>
    <div class="fmodal-body">
      <input type="hidden" id="bfId" value="">
      <div class="form-grid">
        <div class="fg" style="grid-column:1/-1;"><label>Judul Buku *</label><input type="text" id="bfTitle" placeholder="Masukkan judul lengkap buku"></div>
        <div class="fg"><label>Pengarang *</label><input type="text" id="bfAuthor" placeholder="Nama pengarang"></div>
        <div class="fg"><label>Penerbit</label><input type="text" id="bfPub" placeholder="Nama penerbit"></div>
        <div class="fg"><label>Tahun Terbit</label><input type="number" id="bfYear" placeholder="2024" min="1900" max="2099"></div>
        <div class="fg"><label>Jumlah Halaman</label><input type="number" id="bfPages" placeholder="200" min="1"></div>
        <div class="fg"><label>Kategori *</label>
          <select id="bfCat">
            <option value="Pelajaran">Pelajaran</option>
            <option value="Fiksi">Fiksi</option>
            <option value="Non-Fiksi">Non-Fiksi</option>
            <option value="Referensi">Referensi</option>
          </select>
        </div>
        <div class="fg"><label>Stok Tersedia *</label><input type="number" id="bfStock" placeholder="5" min="0"></div>
        <div class="fg"><label>Total Eksemplar</label><input type="number" id="bfTotal" placeholder="5" min="0"></div>
        <div class="fg" style="grid-column:1/-1;"><label>Deskripsi</label><textarea id="bfDesc" placeholder="Deskripsi singkat buku..."></textarea></div>
      </div>
    </div>
    <div class="fmodal-footer">
      <button class="fmodal-btn cancel" onclick="closeBookForm()">Batal</button>
      <button class="fmodal-btn save" onclick="saveBook()"><i class="fas fa-save"></i> Simpan Buku</button>
    </div>
  </div>
</div>

<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
  (function() {
  // Sembunyikan semua page
  document.querySelectorAll('.page').forEach(function(p){ 
    p.classList.remove('active'); 
    p.style.display = 'none';
  });
  // Paksa tampilkan page-peminjaman
  var pem = document.getElementById('page-peminjaman');
  pem.classList.add('active');
  pem.style.display = 'block';
  // Sembunyikan page-login
  var login = document.getElementById('page-login');
  login.style.display = 'none';
  initGuestMode();
  initPeminjaman();
})();
</script>
</body>
</html>
